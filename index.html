<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ระบบขอสั่งอะไหล่คลังสินค้านวนคร</title>
    <!-- Enhanced Content Security Policy to reduce phishing risks -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com https://code.jquery.com https://opensheet.elk.sh https://docs.google.com https://script.google.com https://script.googleusercontent.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: https: blob: https://drive.google.com https://lh3.googleusercontent.com; connect-src 'self' https://opensheet.elk.sh https://docs.google.com https://script.google.com https://script.googleusercontent.com; frame-src https://docs.google.com https://drive.google.com; object-src 'none'; base-uri 'self'; form-action 'self' https://docs.google.com;">
    <!-- Additional security headers via meta -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <!-- Removed invalid X-Frame-Options meta; set via server if needed -->
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <!-- Verification meta to help with Safe Browsing (add your site verification if available) -->
    <meta name="google-site-verification" content="your-verification-token-if-any">
    <!-- Clear description to indicate legitimacy -->
    <meta name="description" content="ระบบภายในสำหรับขอสั่งอะไหล่คลังสินค้านวนคร - เครื่องมือสำหรับพนักงานเท่านั้น ไม่ใช่เว็บไซต์ภายนอก">
    <link href="https://fonts.googleapis.com/css2?family=Itim&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <style>
      body {
        margin: 0;
        padding: 0;
        background-color: #eceff1;
        font-family: "Kanit", sans-serif;
        font-size: 14px; /* ลด base font-size ให้ compact */
        transition: background-color 0.3s ease, color 0.3s ease;
      }
      /* Dark Mode Styles */
      body.dark-mode {
        background-color: #121212;
        color: #e0e0e0;
      }
      body.dark-mode .login-modal {
        background-color: rgba(0, 0, 0, 0.8);
      }
      body.dark-mode .login-content {
        background: linear-gradient(135deg, #2c3e50, #34495e);
        color: #ecf0f1;
      }
      body.dark-mode .login-content input {
        background-color: #34495e;
        border-color: #555;
        color: #ecf0f1;
      }
      body.dark-mode .login-content input:focus {
        border-color: #1abc9c;
        box-shadow: 0 0 5px rgba(26, 188, 156, 0.3);
      }
      body.dark-mode .login-content button {
        background: linear-gradient(135deg, #1abc9c, #16a085);
      }
      body.dark-mode .login-content button:hover {
        background: linear-gradient(135deg, #16a085, #1abc9c);
      }
      body.dark-mode .error {
        background: #7f1d1d;
        color: #fca5a5;
      }
      body.dark-mode .header {
        background: linear-gradient(135deg, #2c3e50, #34495e);
        color: #ecf0f1;
        border-bottom-color: #1abc9c;
      }
      body.dark-mode .header h1 {
        color: #ecf0f1;
      }
      body.dark-mode .user-name-small {
        color: #ff6b9d;
      }
      body.dark-mode .qrcode-header-btn {
        background: linear-gradient(135deg, #1abc9c, #16a085);
      }
      body.dark-mode .qrcode-header-btn:hover {
        background: linear-gradient(135deg, #16a085, #1abc9c);
      }
      body.dark-mode .logout-btn {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
      }
      body.dark-mode .logout-btn:hover {
        background: linear-gradient(135deg, #c0392b, #a93226);
      }
      body.dark-mode .setting-btn {
        background: linear-gradient(135deg, #f39c12, #e67e22);
        color: white;
        border: none;
        padding: 6px 12px; /* ลด padding */
        border-radius: 20px;
        cursor: pointer;
        font-size: 12px; /* ลด font-size */
        margin-left: 5px; /* ลด margin */
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 3px; /* ลด gap */
      }
      body.dark-mode .setting-btn:hover {
        background: linear-gradient(135deg, #e67e22, #d68910);
        transform: translateY(-1px);
      }
      body.dark-mode .container {
        background-color: #2c3e50;
        color: #ecf0f1;
      }
      body.dark-mode .disclaimer {
        background-color: #7f8c8d;
        border-color: #95a5a6;
        color: #ecf0f1;
      }
      body.dark-mode .tab-button {
        background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
      }
      body.dark-mode .tab-button:hover {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      }
      body.dark-mode .tab-button.active {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      }
      body.dark-mode .tab-content {
        background-color: #34495e;
      }
      body.dark-mode #parts, body.dark-mode #images, body.dark-mode #today, body.dark-mode #all, body.dark-mode #pending-calls {
        background-color: #34495e;
      }
      body.dark-mode table {
        background: #2c3e50;
      }
      body.dark-mode th {
        background: linear-gradient(135deg, #1abc9c, #16a085);
        color: #ecf0f1;
      }
      body.dark-mode td {
        border-color: #555;
        color: #e0e0e0;
      }
      body.dark-mode tr:hover {
        background-color: #3d566e;
      }
      body.dark-mode .pagination button {
        background: linear-gradient(135deg, #1abc9c, #16a085);
      }
      body.dark-mode .pagination button:hover {
        background: linear-gradient(135deg, #16a085, #1abc9c);
      }
      body.dark-mode .pagination .active {
        background: linear-gradient(135deg, #e67e22, #d68910);
      }
      body.dark-mode .requisition-button, body.dark-mode .detail-button, body.dark-mode .image-button {
        background: linear-gradient(135deg, #1abc9c, #16a085);
      }
      body.dark-mode .requisition-button:hover, body.dark-mode .detail-button:hover, body.dark-mode .image-button:hover {
        background: linear-gradient(135deg, #16a085, #1abc9c);
      }
      body.dark-mode .modal {
        background: rgba(0, 0, 0, 0.8);
      }
      body.dark-mode .modal-content {
        background: linear-gradient(to bottom right, #2c3e50, #34495e);
        color: #ecf0f1;
      }
      body.dark-mode #modalContent span.label {
        color: #1abc9c;
      }
      body.dark-mode .footer {
        background: linear-gradient(135deg, #1abc9c, #16a085);
      }
      body.dark-mode .swal2-popup {
        background: #2c3e50 !important;
        color: #ecf0f1 !important;
      }
      body.dark-mode .swal2-backdrop {
        background-color: rgba(0, 0, 0, 0.8) !important;
      }
      body.dark-mode .autocomplete-items {
        background-color: #34495e;
        border-color: #555;
      }
      body.dark-mode .autocomplete-item:hover {
        background-color: #3d566e;
      }
      /* Light Mode Styles (default) - existing styles remain */
      body.light-mode {
        background-color: #eceff1;
        color: #1a1a1a;
      }
      /* Ensure light mode doesn't override dark-specific */
      body.light-mode .header {
        background: linear-gradient(135deg, #fff3e0, #ffebee);
        color: #1a3c87;
      }
      /* ... other light overrides if needed, but mostly default */
      /* Login Modal Styles */
      .login-modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        transition: background-color 0.3s ease;
      }
      .login-modal.active {
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .login-content {
        background: linear-gradient(135deg, #ffffff, #f5f7fa);
        padding: 20px; /* ลด padding */
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        width: 90%;
        max-width: 400px;
        text-align: center;
        animation: fadeInUp 0.4s ease;
        position: relative;
        transition: background 0.3s ease;
      }
      .login-content::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(135deg, #42a5f5, #2196f3);
        border-radius: 12px 12px 0 0;
      }
      .login-content h2 {
        color: #1a3c87;
        margin-bottom: 15px; /* ลด margin */
        font-family: "Itim", cursive;
        font-size: 20px; /* ลด font-size */
        transition: color 0.3s ease;
      }
      .login-content input {
        width: 100%;
        padding: 10px; /* ลด padding */
        margin: 8px 0; /* ลด margin */
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        font-size: 14px; /* ลด font-size */
        box-sizing: border-box;
        transition: all 0.3s ease;
        background-color: white;
      }
      .login-content input:focus {
        border-color: #2196f3;
        outline: none;
        box-shadow: 0 0 5px rgba(33, 150, 243, 0.3);
        transform: translateY(-1px);
      }
      .login-content .password-container {
        position: relative;
      }
      .login-content .password-container i {
        position: absolute;
        right: 10px; /* ลด right */
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        color: #666;
        font-size: 14px; /* ลด font-size */
        transition: color 0.3s ease;
      }
      .login-content .password-container i:hover {
        color: #2196f3;
      }
      .login-content .remember-me {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 10px 0; /* ลด margin */
        font-size: 12px; /* ลด font-size */
        text-align: left;
        padding: 0 4px;
      }
      .login-content .remember-me input[type="checkbox"] {
        margin-right: 6px; /* ลด margin */
        transform: scale(1.1); /* ลด scale */
        margin-left: 0;
      }
      .login-content .remember-me label {
        cursor: pointer;
        font-family: "Poppins", sans-serif;
        font-weight: 400;
        margin: 0;
        flex-shrink: 0;
      }
      .login-content button {
        width: 100%;
        padding: 10px; /* ลด padding */
        background: linear-gradient(135deg, #42a5f5, #2196f3);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 14px; /* ลด font-size */
        cursor: pointer;
        margin-top: 8px; /* ลด margin */
        transition: all 0.3s ease;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .login-content button:hover {
        background: linear-gradient(135deg, #1976d2, #1565c0);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
      }
      .login-content button:active {
        transform: translateY(0);
      }
      .login-content .error {
        color: #ef5350;
        font-size: 12px; /* ลด font-size */
        margin-top: 8px; /* ลด margin */
        display: none;
        background: #ffebee;
        padding: 6px; /* ลด padding */
        border-radius: 4px;
        border-left: 3px solid #ef5350;
        transition: background 0.3s ease, color 0.3s ease;
      }
      .logout-btn {
        background: linear-gradient(135deg, #f44336, #d32f2f);
        color: white;
        border: none;
        padding: 6px 12px; /* ลด padding */
        border-radius: 20px;
        cursor: pointer;
        font-size: 12px; /* ลด font-size */
        margin-left: 5px; /* ลด margin */
        transition: all 0.3s ease;
      }
      .logout-btn:hover {
        background: linear-gradient(135deg, #d32f2f, #b71c1c);
        transform: translateY(-1px);
      }
      .app-content {
        display: none;
      }
      .app-content.logged-in {
        display: block;
      }
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      /* Adjusted Header for Top Navigation Bar - More Compact */
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #1a3c87;
        padding: 5px 10px; /* ลด padding */
        border-bottom: 1px solid #ff80ab;
        background: linear-gradient(135deg, #fff3e0, #ffebee);
        font-family: "Kanit", sans-serif;
        position: relative;
        margin: 0;
        max-width: none;
        transition: transform 0.3s ease, background 0.3s ease, color 0.3s ease;
        height: 40px; /* ลด height ให้ compact */
      }
      body.dark-mode .header {
        background: linear-gradient(135deg, #2c3e50, #34495e);
        border-bottom-color: #1abc9c;
        color: #ecf0f1;
      }
      .header-logo
      .header-title {
        display: flex;
        align-items: center;
        flex-grow: 1;
        margin: 0;
        font-size: 12px; /* ลด font-size */
        font-weight: normal;
        text-shadow: 0.5px 0.5px 1px rgba(0, 0, 0, 0.1);
        white-space: nowrap;
        text-align: center;
        transition: color 0.3s ease;
      }
      body.dark-mode .header-title {
        color: #ecf0f1;
      }
      .user-name-small {
        font-size: 10px; /* ลด font-size */
        color: #e91e63;
        font-weight: bold;
        text-align: right;
        white-space: nowrap;
        transition: color 0.3s ease;
      }
      body.dark-mode .user-name-small {
        color: #ff6b9d;
      }
      /* Bottom Navigation Styles (Facebook Mobile-like) - More Compact */
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: white;
        display: flex;
        justify-content: space-around;
        padding: 5px 0; /* ลด padding */
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
        border-top: 1px solid #e0e0e0;
        transition: background 0.3s ease;
      }
      body.dark-mode .bottom-nav {
        background: #2c3e50;
        border-top-color: #555;
      }
      .nav-btn {
        background: none;
        border: none;
        padding: 5px; /* ลด padding */
        font-size: 16px; /* ลด icon size */
        color: #666;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1px; /* ลด gap */
        transition: color 0.3s ease, transform 0.2s ease;
        position: relative;
      }
      .nav-btn::after {
        content: attr(data-label);
        font-size: 8px; /* ลด label font-size */
        color: inherit;
        margin-top: 1px; /* ลด margin */
      }
      .nav-btn.active {
        color: #2196f3;
      }
      body.dark-mode .nav-btn {
        color: #bdc3c7;
      }
      body.dark-mode .nav-btn.active {
        color: #1abc9c;
      }
      .nav-btn:hover {
        transform: scale(1.05); /* ลด scale */
      }
      .nav-btn i {
        font-size: 16px; /* ลด icon size */
      }
      /* Settings Modal Styles */
      .settings-modal {
        display: none;
        position: fixed;
        z-index: 1001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        transition: opacity 0.3s ease;
      }
      .settings-modal-content {
        background: linear-gradient(135deg, #ffffff, #f5f7fa);
        margin: 20% auto;
        padding: 15px; /* ลด padding */
        width: 90%;
        max-width: 300px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        position: relative;
        transition: background 0.3s ease;
      }
      body.dark-mode .settings-modal-content {
        background: linear-gradient(135deg, #2c3e50, #34495e);
        color: #ecf0f1;
      }
      .close-settings {
        color: #78909c;
        float: right;
        font-size: 20px; /* ลด font-size */
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s ease;
      }
      body.dark-mode .close-settings {
        color: #bdc3c7;
      }
      .close-settings:hover {
        color: #e53935;
      }
      .settings-modal-content h2 {
        color: #1a3c87;
        margin-bottom: 15px; /* ลด margin */
        font-family: "Itim", cursive;
        font-size: 18px; /* ลด font-size */
      }
      body.dark-mode .settings-modal-content h2 {
        color: #ecf0f1;
      }
      #userInfo p {
        margin: 8px 0; /* ลด margin */
        font-size: 12px; /* ลด font-size */
        color: #333;
      }
      body.dark-mode #userInfo p {
        color: #e0e0e0;
      }
      .modal-qr-btn, .modal-logout-btn {
        width: 100%;
        padding: 12px; /* ลด padding */
        margin: 8px 0; /* ลด margin */
        border: none;
        border-radius: 8px;
        font-size: 20px; /* ลด font-size */
        cursor: pointer;
        transition: all 0.3s ease;
        color: white;
      }
      .modal-qr-btn {
        background: linear-gradient(135deg, #4caf50, #388e3c);
      }
      .modal-qr-btn:hover {
        background: linear-gradient(135deg, #388e3c, #4caf50);
        transform: translateY(-2px);
      }
      body.dark-mode .modal-qr-btn {
        background: linear-gradient(135deg, #1abc9c, #16a085);
      }
      body.dark-mode .modal-qr-btn:hover {
        background: linear-gradient(135deg, #16a085, #1abc9c);
      }
      .modal-logout-btn {
        background: linear-gradient(135deg, #f44336, #d32f2f);
      }
      .modal-logout-btn:hover {
        background: linear-gradient(135deg, #d32f2f, #b71c1c);
        transform: translateY(-2px);
      }
      body.dark-mode .modal-logout-btn {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
      }
      body.dark-mode .modal-logout-btn:hover {
        background: linear-gradient(135deg, #c0392b, #a93226);
      }
      /* Container adjustment for bottom nav */
      .container {
        max-width: 1500px;
        margin: 0 auto;
        padding: 10px; /* ลด padding */
        padding-bottom: 70px; /* Space for bottom nav */
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        font-family: "Kanit", sans-serif;
        transition: background-color 0.3s ease, color 0.3s ease;
      }
      body.dark-mode .container {
        background-color: #2c3e50;
        color: #ecf0f1;
      }
      /* Hide original tabs */
      .tabs {
        display: none;
      }
      /* Rest of the styles remain the same */
      .tab-content {
        display: none;
        padding: 10px; /* ลด padding */
        background-color: #fafafa;
        border-radius: 10px;
        margin-top: 8px; /* ลด margin */
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        transition: background-color 0.3s ease;
      }
      .tab-content.active {
        display: block;
      }
      .loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        font-size: 18px; /* ลด font-size */
        color: #2196f3;
        z-index: 9999;
        display: none;
      }
      body.dark-mode .loading {
        background: rgba(0, 0, 0, 0.8);
        color: #1abc9c;
      }
      .loading .spinner {
        width: 32px; /* ลด size */
        height: 32px;
        border: 3px solid #eceff1; /* ลด border */
        border-top: 3px solid #2196f3;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 8px; /* ลด margin */
        transition: border-color 0.3s ease;
      }
      body.dark-mode .loading .spinner {
        border-color: #555;
        border-top-color: #1abc9c;
      }
      iframe {
        width: 100%;
        height: 800px;
        border: none;
        border-radius: 10px;
      }
      .footer {
        background: linear-gradient(135deg, #0d47a1, #1565c0);
        color: white;
        text-align: center;
        padding: 8px 0; /* ลด padding */
        margin-top: 15px; /* ลด margin */
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        transition: background 0.3s ease;
      }
      .footer p {
        margin: 0;
        font-size: 12px; /* ลด font-size */
      }
      .social-buttons {
        display: none; /* ซ่อน social-buttons เนื่องจากย้าย QR ไป header แล้ว */
      }
      #parts, #images, #today {
        font-family: "Poppins", sans-serif;
        background-color: #f0f4f8;
        padding: 10px; /* ลด padding */
        border-radius: 8px;
        transition: background-color 0.3s ease;
      }
      #parts #searchContainer, #images #searchContainerImages, #today #searchContainer {
        display: flex;
        justify-content: flex-start;
        margin-bottom: 10px; /* ลด margin */
        gap: 8px; /* ลด gap */
        align-items: center;
        flex-wrap: nowrap; /* เปลี่ยนจาก wrap เป็น nowrap เพื่อให้อยู่บรรทัดเดียว */
      }
      #parts #searchInput1, #parts #searchInput2, #images #searchInputImages1, #images #searchInputImages2, #today #searchInputToday {
        flex: 1;
        min-width: 100px; /* ลด min-width */
        max-width: 200px; /* ลด max-width */
        padding: 8px; /* ลด padding */
        border-radius: 6px;
        border: 1px solid #e0e0e0;
        font-size: 14px; /* ลด font-size */
        transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
        background-color: white;
      }
      #parts #searchInput1:focus, #parts #searchInput2:focus, #images #searchInputImages1:focus, #images #searchInputImages2:focus, #today #searchInputToday:focus {
        border-color: #2196f3;
        box-shadow: 0 0 5px rgba(33, 150, 243, 0.3);
        outline: none;
      }
      body.dark-mode #parts #searchInput1, body.dark-mode #parts #searchInput2, body.dark-mode #images #searchInputImages1, body.dark-mode #images #searchInputImages2, body.dark-mode #today #searchInputToday {
        background-color: #34495e;
        border-color: #555;
        color: #ecf0f1;
      }
      body.dark-mode #parts #searchInput1:focus, body.dark-mode #parts #searchInput2:focus, body.dark-mode #images #searchInputImages1:focus, body.dark-mode #images #searchInputImages2:focus, body.dark-mode #today #searchInputToday:focus {
        border-color: #1abc9c;
        box-shadow: 0 0 5px rgba(26, 188, 156, 0.3);
      }
      #parts .refresh-button, #images .refresh-button-images {
        background: linear-gradient(135deg, #42a5f5, #2196f3);
        color: #fff;
        padding: 8px 16px; /* ลด padding */
        border: none;
        border-radius: 6px;
        font-size: 11px; /* ลด font-size */
        font-weight: 500;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        margin-left: 8px; /* ลด margin */
        flex-shrink: 0;
      }
      #parts .refresh-button:hover, #images .refresh-button-images:hover {
        background: linear-gradient(135deg, #1976d2, #1565c0);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }
      #parts table, #images table, #today table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
        border-radius: 8px;
        overflow: hidden;
        transition: background 0.3s ease;
      }
      body.dark-mode #parts table,
      body.dark-mode #images table,
      body.dark-mode #today table {
        background: #2c3e50;
      }
      #parts th, #parts td, #images th, #images td, #today th, #today td {
        padding: 6px; /* ลด padding */
        text-align: center;
        border: 1px solid #e0e0e0;
        font-size: 12px; /* ลด font-size */
        transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
      }
      body.dark-mode #parts th,
      body.dark-mode #images th,
      body.dark-mode #today th {
        background: linear-gradient(135deg, #1abc9c, #16a085);
        color: #ecf0f1;
        border-color: #555;
      }
      body.dark-mode #parts td,
      body.dark-mode #images td,
      body.dark-mode #today td {
        border-color: #555;
        color: #e0e0e0;
      }
      #parts th, #images th, #today th {
        background: linear-gradient(135deg, #2196f3, #1976d2);
        color: white;
        position: sticky;
        top: 0;
        z-index: 1;
      }
      #today th.sortable {
        cursor: pointer;
        position: relative;
      }
      #today th.sortable:hover {
        background: linear-gradient(135deg, #1976d2, #1565c0);
      }
      body.dark-mode #today th.sortable:hover {
        background: linear-gradient(135deg, #16a085, #1abc9c);
      }
      #today .today-arrow {
        font-size: 10px; /* ลด font-size */
        margin-left: 4px; /* ลด margin */
      }
      #parts tr:hover, #images tr:hover, #today tr:hover {
        background-color: #f5f5f5;
      }
      body.dark-mode #parts tr:hover,
      body.dark-mode #images tr:hover,
      body.dark-mode #today tr:hover {
        background-color: #3d566e;
      }
      #parts .table-container, #images .table-container-images, #today .table-container {
        max-height: 80vh;
        overflow-y: auto;
        overflow-x: auto;
        background: white;
        border-radius: 8px;
        transition: background 0.3s ease, opacity 0.3s ease;
      }
          .fade-out {
         opacity: 0;
          }
      body.dark-mode #parts .table-container,
      body.dark-mode #images .table-container-images,
      body.dark-mode #today .table-container {
        background: #2c3e50;
      }
      #parts .pagination, #images .pagination-images, #today .pagination-today {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        margin-top: 8px; /* ลด margin */
      }
      #parts .pagination button, #images .pagination-images button, #today .pagination-today button {
        background: linear-gradient(135deg, #42a5f5, #2196f3);
        color: white;
        padding: 6px; /* ลด padding */
        border: none;
        border-radius: 50%;
        margin: 0 3px; /* ลด margin */
        cursor: pointer;
        width: 32px; /* ลด width */
        height: 32px;
        font-size: 11px; /* ลด font-size */
        transition: all 0.3s ease;
      }
      #parts .pagination button:hover, #images .pagination-images button:hover, #today .pagination-today button:hover {
        background: linear-gradient(135deg, #1976d2, #1565c0);
        transform: translateY(-2px);
      }
      #parts .pagination .active, #images .pagination-images .active, #today .pagination-today .active {
        background: linear-gradient(135deg, #ff9800, #f57c00);
      }
      #parts .pagination button:disabled, #images .pagination-images button:disabled, #today .pagination-today button:disabled {
        background: #b0bec5;
        cursor: not-allowed;
      }
      #parts .pagination select, #images .pagination-images select, #today .pagination-today select {
        padding: 6px; /* ลด padding */
        border-radius: 6px;
        margin: 0 8px; /* ลด margin */
        font-size: 12px; /* ลด font-size */
      }
      #parts .table-container, #images .table-container-images, #today .table-container {
        overflow-x: auto;
        width: 100%;
      }
      #parts table, #images table, #today table {
        min-width: 900px;
      }
      #parts td, #images td, #today td {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      #parts td:nth-child(3), #images td:nth-child(3), #today td:nth-child(4) {
        text-align: left;
      }
      #parts td:nth-child(4), #images td:nth-child(4) {
        text-align: left;
      }
      #parts th:nth-child(4), #parts td:nth-child(4), #images th:nth-child(4), #images td:nth-child(4) {
        min-width: 300px;
      }
      #parts th:nth-child(5), #parts td:nth-child(5), #images th:nth-child(5), #images td:nth-child(5) {
        min-width: 50px;
      }
      #parts th:nth-child(6), #parts td:nth-child(6), #images th:nth-child(6), #images td:nth-child(6) {
        min-width: 50px;
      }
      #parts th:nth-child(7), #parts td:nth-child(7), #images th:nth-child(7), #images td:nth-child(7) {
        min-width: 250px;
      }
      #parts th:nth-child(8), #parts td:nth-child(8), #images th:nth-child(8), #images td:nth-child(8) {
        min-width: 150px;
      }
      #today td:nth-child(5) {
    text-align: left;
      }
      #parts .requisition-button, #today .detail-button, #images .requisition-button-images {
        background: linear-gradient(135deg, #4caf50, #388e3c);
        color: white;
        font-size: 11px; /* ลด font-size */
        font-weight: 500;
        padding: 6px 12px; /* ลด padding */
        border: none;
        border-radius: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
      }
      #parts .requisition-button:hover, #today .detail-button:hover, #images .requisition-button-images:hover {
        background: linear-gradient(135deg, #388e3c, #4caf50);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }
      #parts .requisition-button:focus, #today .detail-button:focus, #images .requisition-button-images:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.3);
      }
      #parts .requisition-button:active, #today .detail-button:active, #images .requisition-button-images:active {
        transform: translateY(1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      /* New style for image button, copied from requisition-button but with blue gradient */
      #parts .image-button, #images .image-button-images {
        background: linear-gradient(135deg, #2196f3, #1976d2);
        color: white;
        font-size: 10px; /* ลด font-size */
        font-weight: 500;
        padding: 6px 12px; /* ลด padding */
        border: none;
        border-radius: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #parts .image-button:hover, #images .image-button-images:hover {
        background: linear-gradient(135deg, #1565c0, #0d47a1);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }
      #parts .image-button:focus, #images .image-button-images:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.3);
      }
      #parts .image-button:active, #images .image-button-images:active {
        transform: translateY(1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      #parts .image-button i, #images .image-button-images i {
        font-size: 10px; /* ลด font-size */
      }
      #parts .swal2-input, #images .swal2-input-images {
        margin: 3px 0; /* ลด margin */
        width: 100%;
        box-sizing: border-box;
        border-radius: 6px;
        font-size: 12px; /* ลด font-size */
        padding: 5px; /* ลด padding */
        height: 32px; /* ลด height */
        transition: background-color 0.3s ease;
        background-color: white;
      }
      body.dark-mode #parts .swal2-input, body.dark-mode #images .swal2-input-images {
        background-color: #34495e;
        color: #ecf0f1;
        border-color: #555;
      }
      #parts .swal2-select, #images .swal2-select-images {
        margin: 3px 0; /* ลด margin */
        width: 100%;
        padding: 5px; /* ลด padding */
        box-sizing: border-box;
        border-radius: 6px;
        font-size: 12px; /* ลด font-size */
        height: 32px; /* ลด height */
        transition: background-color 0.3s ease;
        background-color: white;
      }
      body.dark-mode #parts .swal2-select, body.dark-mode #images .swal2-select-images {
        background-color: #34495e;
        color: #ecf0f1;
        border-color: #555;
      }
      #parts .swal2-label, #images .swal2-label-images {
        font-weight: 500;
        margin: 6px 0 3px; /* ลด margin */
        display: block;
        text-align: left;
        font-size: 12px; /* ลด font-size */
      }
      #parts .invalid-input, #images .invalid-input-images {
        border: 2px solid #ef5350 !important;
        box-shadow: 0 0 5px rgba(239, 83, 80, 0.3);
      }
      #parts .error-message, #images .error-message-images {
        color: #ef5350;
        font-size: 10px; /* ลด font-size */
        margin-top: 1px; /* ลด margin */
        display: block;
        text-align: left;
      }
      #parts a, #images a {
        text-decoration: none;
        color: #2196f3;
        target="_blank" rel="noopener noreferrer";
        transition: color 0.3s ease;
      }
      body.dark-mode #parts a, body.dark-mode #images a {
        color: #1abc9c;
      }
      #parts a:hover, #images a:hover {
        color: #1565c0;
      }
      body.dark-mode #parts a:hover, body.dark-mode #images a:hover {
        color: #16a085;
      }
      #parts img, #images img {
        transition: transform 0.2s ease;
      }
      #parts img:hover, #images img:hover {
        transform: scale(1.1);
      }
      #today .status-green {
        color: #4caf50;
        font-weight: bold;
      }
      #today .status-red {
        color: #ef5350;
        font-weight: bold;
      }
      #today .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        opacity: 0;
        transform: scale(0.95);
        transition: opacity 0.3s ease, transform 0.3s ease, background-color 0.3s ease;
      }
      body.dark-mode #today .modal {
        background: rgba(0, 0, 0, 0.8);
      }
      #today .modal-content {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(to bottom right, #ffffff, #f5f7fa);
        padding: 15px; /* ลด padding */
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        animation: fadeIn 0.3s ease;
        font-family: "Poppins", sans-serif;
        z-index: 1001;
        transition: background 0.3s ease;
      }
      body.dark-mode #today .modal-content {
        background: linear-gradient(to bottom right, #2c3e50, #34495e);
        color: #ecf0f1;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
      }
      #today .close {
        color: #78909c;
        float: right;
        font-size: 20px; /* ลด font-size */
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s;
      }
      body.dark-mode #today .close {
        color: #bdc3c7;
      }
      #today .close:hover {
        color: #e53935;
      }
      #today #modalContent {
        margin-top: 10px; /* ลด margin */
      }
      #today #modalContent div {
        padding: 8px 0; /* ลด padding */
        border-bottom: 1px solid #eceff1;
        transition: border-bottom-color 0.3s ease;
      }
      body.dark-mode #today #modalContent div {
        border-bottom-color: #555;
      }
      #today #modalContent div:last-child {
        border-bottom: none;
      }
      #today #modalContent span.label {
        display: inline-block;
        min-width: 100px; /* ลด min-width */
        font-weight: 500;
        color: #2196f3;
        font-size: 13px; /* ลด font-size */
        transition: color 0.3s ease;
      }
      body.dark-mode #today #modalContent span.label {
        color: #1abc9c;
      }
      #today #modalContent span.value {
        font-size: 13px; /* ลด font-size */
        color: #37474f;
        transition: color 0.3s ease;
      }
      body.dark-mode #today #modalContent span.value {
        color: #bdc3c7;
      }
      #today .modal-content h2 {
        color: #e91e63;
        font-size: 18px; /* ลด font-size */
        font-weight: bold;
        margin-bottom: 10px; /* ลด margin */
        transition: color 0.3s ease;
      }
      body.dark-mode #today .modal-content h2 {
        color: #ff6b9d;
      }
      #today .spinner-container {
        text-align: center;
        padding: 30px 15px; /* ลด padding */
        color: #2196f3;
        font-size: 13px; /* ลด font-size */
        transition: color 0.3s ease;
      }
      body.dark-mode #today .spinner-container {
        color: #1abc9c;
      }
      #today .spinner {
        width: 32px; /* ลด size */
        height: 32px;
        border: 3px solid #eceff1; /* ลด border */
        border-top: 3px solid #2196f3;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 8px auto; /* ลด margin */
        transition: border-color 0.3s ease;
      }
      body.dark-mode #today .spinner {
        border-color: #555;
        border-top-color: #1abc9c;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      #error-container, #error-container-images, #error-container-today {
        display: none;
        text-align: center;
        padding: 10px; /* ลด padding */
        color: #ef5350;
        font-size: 13px; /* ลด font-size */
        background-color: #ffebee;
        border-radius: 8px;
        margin-bottom: 10px; /* ลด margin */
        transition: background-color 0.3s ease, color 0.3s ease;
      }
      body.dark-mode #error-container, body.dark-mode #error-container-images, body.dark-mode #error-container-today {
        background-color: #7f1d1d;
        color: #fca5a5;
      }
      #retry-button, #retry-button-images, #retry-button-today {
        background: linear-gradient(135deg, #ff7043, #f44336);
        color: white;
        padding: 8px 16px; /* ลด padding */
        border: none;
        border-radius: 6px;
        font-size: 12px; /* ลด font-size */
        cursor: pointer;
        margin-top: 8px; /* ลด margin */
        transition: all 0.3s ease;
      }
      #retry-button:hover, #retry-button-images:hover, #retry-button-today:hover {
        background: linear-gradient(135deg, #f44336, #ff7043);
        transform: translateY(-2px);
      }
      .swal2-container {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        z-index: 99998 !important;
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        overflow: hidden !important;
      }
      .swal2-backdrop {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background-color: rgba(0, 0, 0, 0.5) !important;
        backdrop-filter: blur(8px) !important;
        z-index: 99997 !important;
      }
      body.dark-mode .swal2-backdrop {
        background-color: rgba(0, 0, 0, 0.8) !important;
      }
      .swal2-popup {
        position: relative !important;
        margin: 0 !important;
        transform: none !important;
        max-width: 500px !important;
        width: 500px !important;
        max-height: 90vh !important;
        overflow-y: auto !important;
        padding: 20px !important; /* ลด padding */
        font-size: 12px !important; /* ลด font-size */
        border-radius: 10px !important;
        z-index: 99999 !important;
        background: white !important;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
        color: #333 !important;
        transition: background 0.3s ease, color 0.3s ease !important;
      }
      body.dark-mode .swal2-popup {
        background: #2c3e50 !important;
        color: #ecf0f1 !important;
      }
      .swal2-content {
        padding-bottom: 150px !important;
      }
      .swal2-title {
        font-size: 16px !important; /* ลด font-size */
        margin-bottom: 8px !important; /* ลด margin */
        transition: color 0.3s ease !important;
      }
      body.dark-mode .swal2-title {
        color: #ecf0f1 !important;
      }
      .swal2-actions {
        margin-top: 8px !important; /* ลด margin */
      }
      .swal2-confirm, .swal2-cancel {
        font-size: 12px !important; /* ลด font-size */
        padding: 6px 12px !important; /* ลด padding */
      }
      .swal2-confirm:disabled {
        background: #b0bec5 !important;
        cursor: not-allowed !important;
        opacity: 0.6;
      }
      .autocomplete-items {
        max-height: 120px;
        border-radius: 6px;
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }
      .autocomplete-item {
        padding: 5px; /* ลด padding */
        font-size: 12px; /* ลด font-size */
        transition: background-color 0.3s ease;
      }
      .swal2-qrcode {
        display: block;
        margin: 8px auto; /* ลด margin */
        border: 1px solid #ddd;
        border-radius: 4px;
        transition: border-color 0.3s ease;
      }
      body.dark-mode .swal2-qrcode {
        border-color: #555;
      }
      .swal2-spinner-container {
        text-align: center;
        padding: 15px; /* ลด padding */
        color: #2196f3;
        font-size: 13px; /* ลด font-size */
        transition: color 0.3s ease;
      }
      body.dark-mode .swal2-spinner-container {
        color: #1abc9c;
      }
      .swal2-spinner {
        width: 32px; /* ลด size */
        height: 32px;
        border: 3px solid #eceff1; /* ลด border */
        border-top: 3px solid #2196f3;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 8px auto; /* ลด margin */
        transition: border-color 0.3s ease;
      }
      body.dark-mode .swal2-spinner {
        border-color: #555;
        border-top-color: #1abc9c;
      }
      .summary-image {
        width: 50px !important; /* ลด width */
        height: auto !important;
        max-width: 100% !important;
        object-fit: cover !important;
        border-radius: 8px;
        margin-bottom: 8px; /* ลด margin */
        display: block;
        margin-left: auto;
        margin-right: auto;
      }
      .dark-blue-title {
        color: #00008b !important;
        transition: color 0.3s ease !important;
      }
      body.dark-mode .dark-blue-title {
        color: #74b9ff !important;
      }
      @media screen and (max-width: 360px) {
        .swal2-popup {
          max-width: 95vw !important;
          width: 95vw !important;
          padding: 8px !important; /* ลด padding */
          font-size: 11px !important; /* ลด font-size */
        }
        .swal2-input, .swal2-select {
          font-size: 11px; /* ลด font-size */
          height: 30px; /* ลด height */
        }
        .swal2-label {
          font-size: 11px; /* ลด font-size */
        }
        .autocomplete-item {
          font-size: 11px; /* ลด font-size */
        }
        .swal2-qrcode {
          width: 120px !important;
          height: 120px !important;
        }
      }
      /* Styles for #all tab */
      #all {
        font-family: 'Prompt', sans-serif;
        background-color: #f0f4f8;
        padding: 10px; /* ลด padding */
        border-radius: 8px;
        transition: background-color 0.3s ease;
      }
      body.dark-mode #all {
        background-color: #34495e;
      }
      #all #searchContainerAll {
        display: flex;
        justify-content: flex-start;
        margin-bottom: 15px; /* ลด margin */
      }
      #all #searchInputAll {
        width: 100%;
        max-width: 250px; /* ลด max-width */
        padding: 8px; /* ลด padding */
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 14px; /* ลด font-size */
        transition: background-color 0.3s ease, border-color 0.3s ease;
        background-color: white;
      }
      body.dark-mode #all #searchInputAll {
        background-color: #34495e;
        border-color: #555;
        color: #ecf0f1;
      }
      #all table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border-radius: 12px;
        overflow: hidden;
        transition: background 0.3s ease;
      }
      body.dark-mode #all table {
        background: #2c3e50;
      }
      #all th, #all td {
        padding: 5px 8px; /* ลด padding */
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
        cursor: pointer;
        transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
      }
      body.dark-mode #all th,
      body.dark-mode #all td {
        border-color: #555;
        color: #e0e0e0;
      }
      #all th {
        background-color: #007bff;
        color: white;
      }
      body.dark-mode #all th {
        background: linear-gradient(135deg, #1abc9c, #16a085);
        color: #ecf0f1;
      }
      #all td:nth-child(6) {
        min-width: 150px; /* ลด min-width */
      }
      #all tr:hover {
        background-color: #f1f1f1;
      }
      body.dark-mode #all tr:hover {
        background-color: #3d566e;
      }
      #all .status-green {
        color: green;
        font-weight: bold;
      }
      #all .status-red {
        color: red;
        font-weight: bold;
      }
      #all .detail-button {
        padding: 5px 8px; /* ลด padding */
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }
      #all .detail-button:hover {
        background-color: #2980b9;
      }
      #all .all-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
        transition: background-color 0.3s ease;
      }
      body.dark-mode #all .all-modal {
        background-color: rgba(0,0,0,0.8);
      }
      #all .all-modal-content {
        background-color: #fff;
        margin: 10% auto;
        padding: 15px; /* ลด padding */
        border-radius: 12px;
        width: 80%;
        max-width: 500px;
        transition: background-color 0.3s ease;
      }
      body.dark-mode #all .all-modal-content {
        background-color: #2c3e50;
        color: #ecf0f1;
      }
      #all .all-close {
        color: #aaa;
        float: right;
        font-size: 20px; /* ลด font-size */
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s;
      }
      body.dark-mode #all .all-close {
        color: #bdc3c7;
      }
      #all .all-close:hover {
        color: #000;
      }
      body.dark-mode #all .all-close:hover {
        color: #ecf0f1;
      }
      #all #modalContentAll span.label {
        color: #007bff;
        font-weight: bold;
        transition: color 0.3s ease;
      }
      body.dark-mode #all #modalContentAll span.label {
        color: #1abc9c;
      }
      #all #modalContentAll span.value {
        color: #000;
        transition: color 0.3s ease;
      }
      body.dark-mode #all #modalContentAll span.value {
        color: #ecf0f1;
      }
      #all .all-pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 15px; /* ลด margin */
      }
      #all .all-pagination button,
      #all .all-pagination select {
        padding: 6px 10px; /* ลด padding */
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px; /* ลด font-size */
        margin: 0 3px; /* ลด margin */
        transition: background-color 0.3s ease;
      }
      #all .all-pagination button:hover,
      #all .all-pagination select:hover {
        background-color: #2980b9;
      }
      #all .all-pagination .all-page-number {
        padding: 5px 8px; /* ลด padding */
        background-color: #ecf0f1;
        color: #3498db;
        border-radius: 6px;
        margin: 0 2px; /* ลด margin */
        cursor: pointer;
        transition: background-color 0.3s ease, color 0.3s ease;
      }
      body.dark-mode #all .all-pagination .all-page-number {
        background-color: #34495e;
        color: #1abc9c;
      }
      #all .all-pagination .all-page-number.active {
        background-color: #3498db;
        color: white;
      }
      body.dark-mode #all .all-pagination .all-page-number.active {
        background-color: #e67e22;
        color: white;
      }
      #all .all-pagination img {
        width: 18px; /* ลด size */
        height: 18px;
        cursor: pointer;
      }
      #all .all-pagination .all-page-number {
        width: 32px; /* ลด width */
        height: 32px;
        background-color: #3498db; /* น้ำเงิน */
        color: white;
        border-radius: 50%;
        display: inline-flex;
        justify-content: center;
        align-items: center;
        margin: 0 3px; /* ลด margin */
        cursor: pointer;
        font-size: 14px; /* ลด font-size */
        border: none;
        transition: background-color 0.3s; /* ลื่นตอน hover */
      }
      #all .all-pagination .all-page-number:hover {
        background-color: #2980b9; /* น้ำเงินเข้ม ตอน hover */
      }
      #all .all-pagination .all-page-number.active {
        background-color: #e67e22; /* ส้มเข้ม สำหรับหน้าปัจจุบัน */
        color: white;
      }
      /* ใส่ CSS ส่วนอื่น ๆ ตามที่ได้บอกในคำตอบก่อนหน้านี้ */
      #all .all-pagination img {
        width: 18px; /* ลด size */
        height: 18px;
        cursor: pointer;
      }
      /* เพิ่มเส้นตาราง */
      #all table,
      #all th,
      #all td {
        border: 1px solid #ccc;
        transition: border-color 0.3s ease;
      }
      body.dark-mode #all table,
      body.dark-mode #all th,
      body.dark-mode #all td {
        border-color: #555;
      }
      /* --- ปรับความกว้างเฉพาะบางคอลัมน์ --- */
      #all th:nth-child(3), #all td:nth-child(3) {
        width: 150px; /* ลด width */
        min-width: 120px; /* ลด min-width */
      }
      #all th:nth-child(4), #all td:nth-child(4) {
        width: 250px; /* ลด width */
        min-width: 200px; /* ลด min-width */
      }
      #all th:nth-child(9), #all td:nth-child(9) {
        width: 150px; /* ลด width */
        min-width: 120px; /* ลด min-width */
      }
      /* --- Responsive: เวลาจอแคบให้เลื่อนตารางได้ --- */
      #all .all-table-container {
        overflow-x: auto;
        width: 100%;
      }
      #all table {
        width: 100%;
        border-collapse: collapse;
        min-width: 900px; /* กันตารางแคบเกิน */
      }
      #all th, #all td {
        padding: 6px; /* ลด padding */
        text-align: left;
        white-space: nowrap; /* กันบรรทัดตก */
      }
      @media (max-width: 768px) {
        #all th, #all td {
          padding: 4px; /* ลด padding */
          font-size: 12px; /* ลด font-size */
        }
      }
        #all tr {
          opacity: 0;
          transform: translateY(10px);
          animation: fadeInUp 0.5s ease forwards;
        }
        #all tr:nth-child(even) {
          animation-delay: 0.1s;
        }
        #all tr:nth-child(odd) {
          animation-delay: 0.2s;
        }
        /* Modal Animation */
        #all .all-modal-content {
          animation: zoomIn 0.4s ease;
        }
        @keyframes zoomIn {
          from {
            opacity: 0;
            transform: scale(0.8);
          }
          to {
            opacity: 1;
            transform: scale(1);
          }
        }
        /* ปุ่ม smooth */
        #all button, #all .all-page-number, #all .detail-button {
          transition: all 0.3s ease;
        }
        #all .detail-button:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        #all .all-pagination .all-page-number:hover {
          transform: scale(1.1);
        }
        #all th:nth-child(9), #all td:nth-child(9) {
          width: 70px; /* ลด width */
          min-width: 50px; /* ลด min-width */
          max-width: 80px; /* ลด max-width */
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }
      /* Styles for #pending-calls tab */
      #pending-calls {
        font-family: 'Prompt', sans-serif;
        background-color: #f0f4f8;
        padding: 10px; /* ลด padding */
        border-radius: 8px;
        transition: background-color 0.3s ease;
      }
      body.dark-mode #pending-calls {
        background-color: #34495e;
      }
      #pending-calls #searchContainerPending {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        margin-bottom: 15px; /* ลด margin */
      }
      #pending-calls .pending-filter-row {
        display: flex;
        align-items: center;
      }
      #pending-calls .pending-search-row {
        display: flex;
        align-items: center;
        margin-top: 8px; /* ลด margin */
      }
      #pending-calls #teamFilterLabelPending {
        font-size: 14px; /* ลด font-size */
        color: #333;
        transition: color 0.3s ease;
      }
      body.dark-mode #pending-calls #teamFilterLabelPending {
        color: #ecf0f1;
      }
      #pending-calls #teamFilterPending {
        margin-left: 4px; /* ลด margin */
        padding: 8px; /* ลด padding */
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 14px; /* ลด font-size */
        background-color: #fff;
        cursor: pointer;
        transition: all 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
      }
      body.dark-mode #pending-calls #teamFilterPending {
        background-color: #34495e;
        border-color: #555;
        color: #ecf0f1;
      }
      #pending-calls #teamFilterPending:hover {
        border-color: #2980b9;
      }
      body.dark-mode #pending-calls #teamFilterPending:hover {
        border-color: #1abc9c;
      }
      #pending-calls #searchInputPending {
        width: 250px; /* ลด width */
        padding: 8px; /* ลด padding */
        border-radius: 8px 0 0 8px;
        border: 1px solid #ccc;
        border-right: none;
        font-size: 14px; /* ลด font-size */
        transition: background-color 0.3s ease, border-color 0.3s ease;
        background-color: white;
      }
      body.dark-mode #pending-calls #searchInputPending {
        background-color: #34495e;
        border-color: #555;
        color: #ecf0f1;
      }
      #pending-calls #searchButtonPending {
        padding: 8px; /* ลด padding */
        background-color: #3498db;
        color: white;
        border: 1px solid #ccc;
        border-left: none;
        border-radius: 0 8px 8px 0;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      #pending-calls #searchButtonPending:hover {
        background-color: #2980b9;
      }
      #pending-calls .pending-table-container {
        overflow-x: auto;
        width: 100%;
      }
      #pending-calls table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border-radius: 12px;
        overflow: hidden;
        min-width: 900px;
        transition: background 0.3s ease;
      }
      body.dark-mode #pending-calls table {
        background: #2c3e50;
      }
      #pending-calls th, #pending-calls td {
        padding: 6px 8px; /* ลด padding */
        text-align: left;
        border: 1px solid #ccc;
        white-space: nowrap;
        transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
      }
      body.dark-mode #pending-calls th, body.dark-mode #pending-calls td {
        border-color: #555;
        color: #e0e0e0;
      }
      #pending-calls th {
        background-color: #007bff;
        color: white;
      }
      body.dark-mode #pending-calls th {
        background: linear-gradient(135deg, #1abc9c, #16a085);
        color: #ecf0f1;
      }
      #pending-calls th.sortable {
        cursor: pointer;
      }
      #pending-calls th.sortable:hover {
        background-color: #0056b3;
      }
      body.dark-mode #pending-calls th.sortable:hover {
        background: linear-gradient(135deg, #16a085, #1abc9c);
      }
      #pending-calls .pending-arrow {
        font-size: 10px; /* ลด font-size */
        margin-left: 4px; /* ลด margin */
      }
      #pending-calls tr:hover {
        background-color: #f1f1f1;
      }
      body.dark-mode #pending-calls tr:hover {
        background-color: #3d566e;
      }
      #pending-calls .pending-detail-button {
        padding: 5px 8px; /* ลด padding */
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      #pending-calls .pending-detail-button:hover {
        background-color: #2980b9;
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      }
      #pending-calls .pending-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
        transition: background-color 0.3s ease;
      }
      body.dark-mode #pending-calls .pending-modal {
        background-color: rgba(0,0,0,0.8);
      }
      #pending-calls .pending-modal-content {
        background-color: #fff;
        margin: 10% auto;
        padding: 15px; /* ลด padding */
        border-radius: 12px;
        width: 80%;
        max-width: 500px;
        animation: zoomIn 0.4s ease;
        transition: background-color 0.3s ease;
      }
      body.dark-mode #pending-calls .pending-modal-content {
        background-color: #2c3e50;
        color: #ecf0f1;
      }
      #pending-calls .pending-close {
        color: #aaa;
        float: right;
        font-size: 20px; /* ลด font-size */
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s;
      }
      body.dark-mode #pending-calls .pending-close {
        color: #bdc3c7;
      }
      #pending-calls .pending-close:hover {
        color: #000;
      }
      body.dark-mode #pending-calls .pending-close:hover {
        color: #ecf0f1;
      }
      #pending-calls #modalContentPending span.label {
        color: #007bff;
        font-weight: bold;
        transition: color 0.3s ease;
      }
      body.dark-mode #pending-calls #modalContentPending span.label {
        color: #1abc9c;
      }
      #pending-calls #modalContentPending span.value {
        color: #000;
        transition: color 0.3s ease;
      }
      body.dark-mode #pending-calls #modalContentPending span.value {
        color: #ecf0f1;
      }
      #pending-calls .pending-pagination {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        margin-top: 15px; /* ลด margin */
      }
      #pending-calls .pending-pagination button,
      #pending-calls .pending-pagination select {
        padding: 6px 10px; /* ลด padding */
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px; /* ลด font-size */
        margin: 0 3px; /* ลด margin */
        transition: all 0.3s ease;
      }
      #pending-calls .pending-pagination button:hover,
      #pending-calls .pending-pagination select:hover {
        background-color: #2980b9;
      }
      #pending-calls .pending-pagination .pending-page-number {
        width: 32px; /* ลด width */
        height: 32px;
        background-color: #3498db;
        color: white;
        border-radius: 50%;
        display: inline-flex;
        justify-content: center;
        align-items: center;
        margin: 0 3px; /* ลด margin */
        cursor: pointer;
        font-size: 14px; /* ลด font-size */
        border: none;
        transition: all 0.3s ease;
      }
      #pending-calls .pending-pagination .pending-page-number:hover {
        background-color: #2980b9;
        transform: scale(1.1);
      }
      #pending-calls .pending-pagination .pending-page-number.active {
        background-color: #e67e22;
        color: white;
      }
      #pending-calls .pending-items-per-page {
        margin-left: 8px; /* ลด margin */
        font-size: 14px; /* ลด font-size */
        transition: color 0.3s ease;
      }
      body.dark-mode #pending-calls .pending-items-per-page {
        color: #ecf0f1;
      }
      #pending-calls tr {
        opacity: 0;
        transform: translateY(10px);
        animation: fadeInUp 0.5s ease forwards;
      }
      #pending-calls tr:nth-child(even) {
        animation-delay: 0.1s;
      }
      #pending-calls tr:nth-child(odd) {
        animation-delay: 0.2s;
      }
      @keyframes fadeInUp {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes zoomIn {
        from {
          opacity: 0;
          transform: scale(0.8);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      #pending-calls th:nth-child(3), #pending-calls td:nth-child(3) {
        width: auto;
        min-width: 70px; /* ลด min-width */
        max-width: 120px; /* ลด max-width */
        white-space: normal;
      }
      #pending-calls th:nth-child(5), #pending-calls td:nth-child(5) {
        width: 120px; /* ลด width */
        min-width: 100px; /* ลด min-width */
      }
      #pending-calls td:nth-child(7), #pending-calls th:nth-child(7) {
        min-width: 180px; /* ลด min-width */
      }
      @media (max-width: 768px) {
        #pending-calls th:nth-child(3), #pending-calls td:nth-child(3) {
          min-width: 50px; /* ลด min-width */
          font-size: 11px; /* ลด font-size */
        }
      }
      #pending-calls .pending-highlight-red {
        color: red;
        font-weight: bold;
      }
      #pending-calls .pending-yellow-light {
        background-color: #c9ffc4;
        transition: background-color 0.3s ease;
      }
      body.dark-mode #pending-calls .pending-yellow-light {
        background-color: #2d5016;
      }
      #pending-calls .pending-pink-pastel {
        background-color: #fce4ec;
        transition: background-color 0.3s ease;
      }
      body.dark-mode #pending-calls .pending-pink-pastel {
        background-color: #50162d;
      }
      #pending-calls .pending-text-left {
        text-align: left;
      }
      #pending-calls .pending-text-center {
        text-align: center;
      }
      #pending-calls .pending-call-count-box {
        margin-left: 15px; /* ลด margin */
        padding: 8px 12px; /* ลด padding */
        background-color: #e6f2ff;
        color: #007bff;
        border: 1px solid #d0eaff;
        border-radius: 10px;
        font-size: 14px; /* ลด font-size */
        font-weight: bold;
        display: inline-flex;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
      }
      body.dark-mode #pending-calls .pending-call-count-box {
        background-color: #1e3a5f;
        color: #1abc9c;
        border-color: #2c5282;
      }
      #pending-calls .pending-call-count-box span {
        color: #d63384;
        margin: 0 3px; /* ลด margin */
        font-size: 16px; /* ลด font-size */
        transition: color 0.3s ease;
      }
      body.dark-mode #pending-calls .pending-call-count-box span {
        color: #ff6b9d;
      }
      #pending-calls .pending-modern-label {
        display: inline-block;
        padding: 8px 12px; /* ลด padding */
        background-color: #ffffff;
        color: #007bff;
        border-radius: 10px;
        font-size: 14px; /* ลด font-size */
        font-weight: bold;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid #d0eaff;
        transition: all 0.3s ease, background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        margin-right: 6px; /* ลด margin */
      }
      body.dark-mode #pending-calls .pending-modern-label {
        background-color: #34495e;
        color: #1abc9c;
        border-color: #4a6582;
      }
      #pending-calls .pending-modern-label:hover {
        background-color: #e6f2ff;
        color: #0056b3;
      }
      body.dark-mode #pending-calls .pending-modern-label:hover {
        background-color: #3d566e;
        color: #16a085;
      }
      /* Disclaimer banner for legitimacy */
      .disclaimer {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
        padding: 8px; /* ลด padding */
        margin-bottom: 10px; /* ลด margin */
        border-radius: 8px;
        text-align: center;
        font-size: 12px; /* ลด font-size */
        transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
      }
      body.dark-mode .disclaimer {
        background-color: #7f8c8d;
        border-color: #95a5a6;
        color: #ecf0f1;
      }
      /* Responsive adjustments for mobile devices - Enhanced for Compact */
      @media screen and (max-width: 768px) {
  body {
    font-size: 14px; /* Smaller base font size - รักษาไว้เพื่อความสมดุลโดยรวม */
  }
  .header {
    padding: 6px 10px; /* เพิ่ม padding เล็กน้อยจาก 4px 8px เพื่อให้มีพื้นที่หายใจมากขึ้น แต่ยัง compact */
    flex-wrap: wrap;
    overflow: visible; /* Allow overflow on small screens to prevent clipping */
    justify-content: space-between;
  }
  .header-logo {
    height: 28px; /* ลดจาก 32px เล็กน้อยเพื่อสมดุลกับ font 16px */
  }
  .header-title {
    font-size: 16px; /* เพิ่มจาก 14px เพื่อให้ชัดเจนและสมดุลกับโลโก้ */
    white-space: normal; /* Allow wrapping to prevent overflow */
    text-align: left; /* Align left for better space usage */
    flex-grow: 1;
    flex-basis: 100%; /* Take full width on very small screens if needed */
    margin-bottom: 2px; /* ลดจาก 3px เพื่อ compact มากขึ้น */
  }
  .user-name-small {
    font-size: 13px; /* เพิ่มจาก 12px เพื่อสมดุลกับ header-title แต่ยังเล็กพอสำหรับชื่อ */
    white-space: nowrap;
    max-width: 120px; /* เพิ่มจาก 100px เพื่อให้ชื่อแสดงได้ชัดกว่า */
    overflow: hidden;
    text-overflow: ellipsis;
  }
}
        .bottom-nav {
          padding: 3px 0; /* ลด padding */
        }
        .nav-btn {
          padding: 4px; /* ลด padding */
          font-size: 14px; /* ลด icon size */
        }
        .nav-btn::after {
          font-size: 7px; /* ลด label font-size */
        }
        #parts th, #parts td, #images th, #images td, #today th, #today td {
          padding: 6px 4px; /* ลด padding */
          font-size: 14px; /* ลด font-size */
        }
        #parts table, #images table, #today table {
          min-width: 600px; /* Reduced min-width for mobile */
        }
        #parts #searchInput1, #parts #searchInput2, #images #searchInputImages1, #images #searchInputImages2, #today #searchInputToday {
            font-size: 13px; /* ลด font-size สำหรับ mobile */
    max-width: none; /* ยกเลิก max-width */
    min-width: 60px; /* ลด min-width เพื่อให้พอดีใน mobile */
    padding: 6px; /* ลด padding */
  }
        #parts #searchContainer, #images #searchContainerImages {
          flex-direction: row; /* บังคับให้อยู่แถวเดียวใน mobile */
    gap: 3px; /* ลด gap */
    flex-wrap: nowrap; /* ไม่ให้ตัด */
    overflow-x: auto; /* เพิ่ม scroll ถ้าเกินขอบ */
  }
        .container {
          padding: 8px; /* ลด padding */
          padding-bottom: 60px; /* Adjust for smaller bottom nav on mobile */
        }
        .tab-content {
          padding: 8px; /* ลด padding */
        }
        .disclaimer {
          font-size: 10px; /* ลด font-size */
          padding: 6px; /* ลด padding */
        }
        /* เพิ่มการปรับสำหรับ Swal บนมือถือ */
        .swal2-container {
          z-index: 99998 !important;
        }
        .swal2-popup {
          position: relative !important;
          margin: 0 !important;
          transform: none !important;
          width: 95vw !important;
          max-height: 90vh !important;
          overflow-y: auto !important;
          z-index: 99999 !important;
          padding: 12px !important; /* ลด padding */
          border-radius: 10px !important;
          font-size: 12px !important; /* ลด font-size */
        }
        .swal2-backdrop {
          z-index: 99997 !important;
        }
      }
      @media screen and (max-width: 480px) {
        .header-title {
          font-size: 10px; /* ลด font-size */
        }
        #parts th, #parts td, #images th, #images td, #today th, #today td {
          padding: 3px 1px; /* ลด padding */
          font-size: 12px; /* ลด font-size */
        }
      }
      /* Additional styles for #parts image modal (reuse existing modal styles) */
      #parts .image-modal, #images .image-modal-images {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
      }
      body.dark-mode #parts .image-modal, body.dark-mode #images .image-modal-images {
        background: rgba(0, 0, 0, 0.8);
      }
     #parts .image-modal-content, #images .image-modal-content-images {
  background: linear-gradient(to bottom right, #ffffff, #f5f7fa);
  margin: 5% auto;
  padding: 15px 15px 0px !important;  /* padding-bottom: 0 !important; เพื่อชิดล่างสุด */
  border-radius: 12px;
  width: 90%;
  max-width: 800px;  /* เพิ่มจาก 800px ถ้าต้องการให้กว้างขึ้น */
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  position: relative;
  transition: background 0.3s ease;
  display: flex;  /* เพิ่ม: ใช้ flex เพื่อ layout ชิดล่าง */
  flex-direction: column;  /* เพิ่ม: column layout */
}
     body.dark-mode #parts .image-modal-content, body.dark-mode #images .image-modal-content-images {
  background: linear-gradient(to bottom right, #2c3e50, #34495e);
  color: #ecf0f1;
}
      #parts .image-close, #images .image-close-images {
        color: #78909c;
        float: right;
        font-size: 24px; /* ลด font-size */
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s;
      }
      body.dark-mode #parts .image-close, body.dark-mode #images .image-close-images {
        color: #bdc3c7;
      }
      #parts .image-close:hover, #images .image-close-images:hover {
        color: #e53935;
      }
     #parts #imageModalContent, #images #imageModalContentImages {
  margin-top: 10px; /* ลด margin */
  flex-grow: 1;  /* เพิ่ม: ให้ content ด้านบน grow แต่ไม่เกิน */
  overflow-y: auto;  /* เพิ่ม: scroll เฉพาะ content ด้านบน ถ้าจำเป็น */
}
      #parts #imageModalContent div, #images #imageModalContentImages div {
        padding: 8px 0; /* ลด padding */
        border-bottom: 1px solid #eceff1;
        transition: border-bottom-color 0.3s ease;
      }
      body.dark-mode #parts #imageModalContent div, body.dark-mode #images #imageModalContentImages div {
        border-bottom-color: #555;
      }
      #parts #imageModalContent div:last-child, #images #imageModalContentImages div:last-child {
        border-bottom: none;
      }
      #parts #imageModalContent span.label, #images #imageModalContentImages span.label {
        display: inline-block;
        min-width: 100px; /* ลด min-width */
        font-weight: 500;
        color: #2196f3;
        font-size: 11px; /* ลด font-size */
        transition: color 0.3s ease;
      }
      body.dark-mode #parts #imageModalContent span.label, body.dark-mode #images #imageModalContentImages span.label {
        color: #1abc9c;
      }
      #parts #imageModalContent span.value, #images #imageModalContentImages span.value {
        font-size: 11px; /* ลด font-size */
        color: #37474f;
        transition: color 0.3s ease;
      }
      body.dark-mode #parts #imageModalContent span.value, body.dark-mode #images #imageModalContentImages span.value {
        color: #bdc3c7;
      }
      #parts .image-modal-content h2, #images .image-modal-content-images h2 {
        color: #e91e63;
        font-size: 18px; /* ลด font-size */
        font-weight: bold;
        margin-bottom: 0px; /* ลด margin */
        transition: color 0.3s ease;
      }
      body.dark-mode #parts .image-modal-content h2, body.dark-mode #images .image-modal-content-images h2 {
        color: #ff6b9d;
      }
      #parts .drive-iframe, #images .drive-iframe-images {
  width: 100%;
  height: 300px;  /* ถ้าต้องการเต็มล่าง ให้เปลี่ยนเป็น flex-grow: 1; หรือ calc(100% - height ด้านบน) */
  border: none;
  border-radius: 8px;
  margin: 0 !important;  /* !important เพื่อชิดติด */
  margin-bottom: -8px !important;  /* เพิ่ม: ชดเชย border-radius + shadow ด้านล่าง */
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);  /* ลด shadow กระจายจาก 10px เป็น 5px เพื่อลดช่องว่าง illusion */
  flex-shrink: 0;  /* เพิ่ม: ไม่ให้ iframe หดตัว */
}
     body.dark-mode #parts .drive-iframe, body.dark-mode #images .drive-iframe-images {
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);  /* ลดใน dark mode ด้วย */
}
      /* Additional style for Material row in image modal to accommodate the requisition button */
      #parts #imageModalContent .material-row, #images #imageModalContentImages .material-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      #parts #imageModalContent .material-row .value, #images #imageModalContentImages .material-row .value {
        flex-grow: 1;
        margin-right: 8px; /* ลด margin */
      }
      #parts #imageModalContent .material-row .requisition-button, #images #imageModalContentImages .material-row .requisition-button-images {
        background: linear-gradient(135deg, #4caf50, #388e3c);
        color: white;
        font-size: 11px; /* ลด font-size */
        font-weight: 500;
        padding: 6px 12px; /* ลด padding */
        border: none;
        border-radius: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        white-space: nowrap;
      }
      #parts #imageModalContent .material-row .requisition-button:hover, #images #imageModalContentImages .material-row .requisition-button-images:hover {
        background: linear-gradient(135deg, #388e3c, #4caf50);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }
      body.dark-mode #parts #imageModalContent .material-row .requisition-button, body.dark-mode #images #imageModalContentImages .material-row .requisition-button-images {
        background: linear-gradient(135deg, #1abc9c, #16a085);
      }
      body.dark-mode #parts #imageModalContent .material-row .requisition-button:hover, body.dark-mode #images #imageModalContentImages .material-row .requisition-button-images:hover {
        background: linear-gradient(135deg, #16a085, #1abc9c);
      }
      /* Gallery Styles for #images tab */
      #images .gallery-container-images {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); /* ลด minmax */
        gap: 8px; /* ลด gap */
        max-height: 80vh;
        overflow-y: auto;
        padding: 8px; /* ลด padding */
        background: #f8f9fa;
        border-radius: 8px;
        transition: background 0.3s ease;
      }
      body.dark-mode #images .gallery-container-images {
        background: #2c3e50;
      }
      #images .gallery-item {
        background: white;
        border-radius: 12px;
        padding: 8px; /* ลด padding */
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        text-align: center;
        overflow: hidden;
      }
      body.dark-mode #images .gallery-item {
        background: #34495e;
        color: #ecf0f1;
      }
      #images .gallery-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      }
      #images .gallery-thumbnail {
        width: 100%;
        height: 100px; /* ลด height */
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 8px; /* ลด margin */
        cursor: pointer;
        transition: transform 0.3s ease;
      }
      #images .gallery-thumbnail:hover {
        transform: scale(1.05);
      }
      #images .gallery-info {
        font-size: 10px; /* ลด font-size */
        line-height: 1.2; /* ลด line-height */
      }
      #images .gallery-material {
        font-weight: bold;
        color: #2196f3;
        margin-bottom: 2px; /* ลด margin */
        font-size: 10px; /* ลด font-size */
      }
      body.dark-mode #images .gallery-material {
        color: #1abc9c;
      }
      #images .gallery-description {
        color: #666;
        font-size: 9px; /* ลด font-size */
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
      }
      body.dark-mode #images .gallery-description {
        color: #bdc3c7;
      }
      #images .gallery-actions {
        margin-top: 6px; /* ลด margin */
        display: flex;
        gap: 4px; /* ลด gap */
        justify-content: center;
      }
      #images .gallery-item .requisition-button-images,
      #images .gallery-item .image-button-images {
        padding: 3px 6px; /* ลด padding */
        font-size: 9px; /* ลด font-size */
      }
   </style>
  </head>
  <body class="light-mode">
    <!-- Login Modal -->
    <div id="loginModal" class="login-modal active">
      <div class="login-content">
        <h2>เข้าสู่ระบบ</h2>
        <input type="text" id="username" placeholder="รหัสพนักงาน" />
        <div class="password-container">
          <input type="password" id="password" placeholder="รหัสผ่าน (ให้นึกก่อน)" />
          <i class="fas fa-eye-slash" id="togglePassword" onclick="togglePasswordVisibility()"></i>
        </div>
        <div class="remember-me">
          <input type="checkbox" id="rememberMe" />
          <label for="rememberMe">Remember me</label>
        </div>
        <button onclick="handleLogin()">เข้าสู่ระบบ</button>
        <div id="loginError" class="error">ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง!</div>
      </div>
    </div>
    <!-- App Content -->
    <div id="appContent" class="app-content">
      <!-- Compact Top Header with Logo -->
      <div class="header">
  <div class="header-title">
    <i class="fas fa-warehouse header-logo"></i> <!-- ไอคอน Warehouse -->
    <span> ระบบขอสั่งอะไหล่จากคลังสินค้านวนคร</span>
  </div>
  <span id="userNameSmall" class="user-name-small"></span>
</div>
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <span>กำลังโหลดข้อมูล...</span>
      </div>
      <div class="container">
        <!-- Original tabs hidden -->
        <div class="tabs" style="display: none;">
          <button class="tab-button active" id="tab-parts" onclick="showTab('parts')">
            ค้นหาอะไหล่เพื่อเบิก
          </button>
          <button class="tab-button" id="tab-images" onclick="showTab('images')">
            ค้นหารูป
          </button>
          <button class="tab-button" id="tab-today" onclick="showTab('today')">
            รายการเบิกประจำวันนี้
          </button>
          <button class="tab-button" id="tab-pending-calls" onclick="showTab('pending-calls')">
            อะไหล่จ่ายตาม Call
          </button>
        </div>
        <div id="parts" class="tab-content active">
          <div id="searchContainer">
            <input type="text" id="searchInput1" placeholder="ค้นหา ตัวกรองหลัก" />
            <input type="text" id="searchInput2" placeholder="ค้นหา ตัวกรองย่อย" />
            <button id="searchButton" class="refresh-button">
              <i class="fas fa-redo"></i>
            </button>
          </div>
          <div id="error-container">
            <p id="error-message">เกิดข้อผิดพลาดในการโหลดข้อมูล กรุณาตรวจสอบการเชื่อมต่อหรือลองใหม่</p>
            <button id="retry-button">ลองใหม่</button>
          </div>
          <div class="table-container">
            <table id="data-table">
              <thead>
                <tr>
                  <th>เบิก</th>
                  <th>รูป</th>
                  <th>Material</th>
                  <th>Description</th>
                  <th>วิภาวดี</th>
                  <th>นวนคร</th>
                  <th>Rebuilt</th>
                  <th>หมายเหตุ</th>
                  <th>Product</th>
                  <th>Spec</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <!-- Image Modal for #parts -->
          <div id="imageModal" class="image-modal">
            <div class="image-modal-content">
              <span class="image-close" id="closeImageModal">&times;</span>
              <h2>รายละเอียดอะไหล่</h2>
              <div id="imageModalContent"></div>
            </div>
          </div>
          <div id="pagination" class="pagination">
            <button id="firstPage">
              <i class="fas fa-chevron-left"></i><i class="fas fa-chevron-left"></i>
            </button>
            <button id="prevPage"><i class="fas fa-chevron-left"></i></button>
            <div id="pageNumbers"></div>
            <button id="nextPage"><i class="fas fa-chevron-right"></i></button>
            <button id="lastPage">
              <i class="fas fa-chevron-right"></i><i class="fas fa-chevron-right"></i>
            </button>
            <div class="items-per-page">
              <label for="itemsPerPage">Show</label>
              <select id="itemsPerPage">
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="30">30</option>
              </select>
            </div>
          </div>
        </div>
        <div id="images" class="tab-content">
          <div id="searchContainerImages">
            <input type="text" id="searchInputImages1" placeholder="ค้นหา ตัวกรองหลัก" />
            <input type="text" id="searchInputImages2" placeholder="ค้นหา ตัวกรองย่อย" />
            <button id="searchButtonImages" class="refresh-button-images">
              <i class="fas fa-redo"></i>
            </button>
          </div>
          <div id="error-container-images">
            <p id="error-message-images">เกิดข้อผิดพลาดในการโหลดข้อมูล กรุณาตรวจสอบการเชื่อมต่อหรือลองใหม่</p>
            <button id="retry-button-images">ลองใหม่</button>
          </div>
          <div class="gallery-container-images" id="gallery-container-images">
            <!-- Gallery items will be rendered here -->
          </div>
          <!-- Image Modal for #images -->
          <div id="imageModalImages" class="image-modal-images">
            <div class="image-modal-content-images">
              <span class="image-close-images" id="closeImageModalImages">&times;</span>
              <h2>รายละเอียดอะไหล่</h2>
              <div id="imageModalContentImages"></div>
            </div>
          </div>
          <div id="paginationImages" class="pagination-images">
            <button id="firstPageImages">
              <i class="fas fa-chevron-left"></i><i class="fas fa-chevron-left"></i>
            </button>
            <button id="prevPageImages"><i class="fas fa-chevron-left"></i></button>
            <div id="pageNumbersImages"></div>
            <button id="nextPageImages"><i class="fas fa-chevron-right"></i></button>
            <button id="lastPageImages">
              <i class="fas fa-chevron-right"></i><i class="fas fa-chevron-right"></i>
            </button>
            <div class="items-per-page-images">
              <label for="itemsPerPageImages">Show</label>
              <select id="itemsPerPageImages">
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="30">30</option>
              </select>
            </div>
          </div>
        </div>
        <div id="today" class="tab-content">
          <div id="searchContainer">
            <input type="text" id="searchInputToday" placeholder="ค้นหา Code, Material, ชื่อช่าง หรือ ทีม..." />
            <!-- Toggle button for all data -->
            <button id="toggleAllDataBtn" title="ประวัติเบิก"><i class="fas fa-list-ul"></i></button>
          </div>
          <div id="error-container-today" class="error-container" style="display: none;">
            <p id="error-message-today">เกิดข้อผิดพลาดในการโหลดข้อมูล กรุณาตรวจสอบการเชื่อมต่อหรือลองใหม่</p>
            <button id="retry-button-today">ลองใหม่</button>
          </div>
          <div id="loadingToday" class="spinner-container">
            <div class="spinner"></div>
            <p>กำลังโหลดข้อมูล...</p>
          </div>
          <div class="table-container">
            <table id="data-table-today">
              <thead>
                <tr>
                  <th>Status</th>
                  <th class="sortable" data-column="IDRow">ลำดับ <span class="today-arrow">↓</span></th>
                  <th class="sortable" data-column="Timestamp">วันเวลาบันทึก <span class="today-arrow">↓</span></th>
                  <th>Material</th>
                  <th>Description</th>
                  <th>จำนวน</th>
                  <th>วิภาวดี</th>
                  <th>ชื่อช่าง</th>
                  <th>หน่วยงาน</th>
                  <th>Call</th>
                  <th>CallType</th>
                  <th>หมายเหตุ</th>
                  <th>ดูรายละเอียด</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <!-- Pagination for Today Tab -->
          <div id="paginationToday" class="pagination-today">
            <button id="firstPageToday">
              <i class="fas fa-chevron-left"></i><i class="fas fa-chevron-left"></i>
            </button>
            <button id="prevPageToday"><i class="fas fa-chevron-left"></i></button>
            <div id="pageNumbersToday"></div>
            <button id="nextPageToday"><i class="fas fa-chevron-right"></i></button>
            <button id="lastPageToday">
              <i class="fas fa-chevron-right"></i><i class="fas fa-chevron-right"></i>
            </button>
            <div class="items-per-page-today">
              <label for="itemsPerPageToday">Show</label>
              <select id="itemsPerPageToday">
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="30">30</option>
              </select>
            </div>
          </div>
          <div id="detailModal" class="modal">
            <div class="modal-content">
              <span class="close" id="closeModal">×</span>
              <h2>รายละเอียด</h2>
              <div id="modalContent"></div>
            </div>
          </div>
        </div>
        <div id="all" class="tab-content">
          <div id="searchContainerAll">
            <input type="text" id="searchInputAll" placeholder="ค้นหา Code,Description, ชื่อช่าง หรือ ทีม..." />
          </div>
          <div class="all-table-container">
            <table id="data-table-all">
              <thead>
                <tr>
                  <th>Status</th>
                  <th class="sortable" data-column="Timestamp">วันเวลา <span class="arrow"></span></th>
                  <th class="sortable" data-column="Code">Material <span class="arrow"></span></th>
                  <th class="sortable" data-column="Material Description">Description <span class="arrow"></span></th>
                  <th>จำนวน</th>
                  <th class="sortable" data-column="ชื่อช่าง">ชื่อช่าง <span class="arrow"></span></th>
                  <th>หน่วยงาน</th>
                  <th>เลขที่Call</th>
                  <th>CallType</th>
                  <th class="sortable" data-column="หมายเหตุ">หมายเหตุ <span class="arrow"></span></th>
                  <th>ดูรายละเอียด</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="detailModalAll" class="all-modal">
            <div class="all-modal-content">
              <span class="all-close" id="closeModalAll">&times;</span>
              <h2>รายละเอียด</h2>
              <div id="modalContentAll"></div>
            </div>
          </div>
          <div class="all-pagination">
            <button id="firstPageAll"><i class="fas fa-chevron-left"></i><i class="fas fa-chevron-left"></i></button>
            <button id="prevPageAll"><i class="fas fa-chevron-left"></i></button>
            <div id="pageNumbersAll"></div>
            <button id="nextPageAll"><i class="fas fa-chevron-right"></i></button>
            <button id="lastPageAll">
              <i class="fas fa-chevron-right"></i><i class="fas fa-chevron-right"></i>
            </button>
            <div class="all-items-per-page">
              <label for="itemsPerPageAll">:</label>
              <select id="itemsPerPageAll">
                <option value="10">10 รายการ</option>
                <option value="20">20 รายการ</option>
                <option value="30">30 รายการ</option>
              </select>
            </div>
          </div>
        </div>
        <div id="pending-calls" class="tab-content">
          <div id="searchContainerPending">
            <div class="pending-filter-row">
              <label id="teamFilterLabelPending" for="teamFilterPending" class="pending-modern-label">เลือกทีม</label>
              <select id="teamFilterPending">
                <option value="">ทั้งหมด</option>
              </select>
              <div id="callCountInfoPending" class="pending-call-count-box">
                จำนวน Ticket ค้าง <span id="callCountValuePending">0</span> Call
              </div>
            </div>
            <div class="pending-search-row">
              <input type="text" id="searchInputPending" placeholder="ค้นหา Ticket, Team, สาขา, ค้างหน่วยงาน, Material, Description..." />
              <button id="searchButtonPending"><i class="fas fa-search"></i></button>
            </div>
          </div>
          <div class="pending-table-container">
            <table id="data-table-pending">
              <thead>
                <tr>
                  <th class="sortable" data-column="DateTime">วันที่แจ้ง <span class="pending-arrow"></span></th>
                  <th class="sortable" data-column="Ticket Number">Ticket <span class="pending-arrow"></span></th>
                  <th class="sortable" data-column="Team">Team <span class="pending-arrow"></span></th>
                  <th class="sortable" data-column="Brand">สาขา <span class="pending-arrow"></span></th>
                  <th class="sortable" data-column="ค้างหน่วยงาน">ค้างหน่วยงาน <span class="pending-arrow"></span></th>
                  <th class="sortable" data-column="Material">Material <span class="pending-arrow"></span></th>
                  <th class="sortable" data-column="Description">Description <span class="pending-arrow"></span></th>
                  <th class="sortable" data-column="Vipa">คงเหลือ <span class="pending-arrow"></span></th>
                  <th class="sortable" data-column="DayRepair">ค้าง(วัน) <span class="pending-arrow"></span></th>
                  <th>ดูรายละเอียด</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="detailModalPending" class="pending-modal">
            <div class="pending-modal-content">
              <span class="pending-close" id="closeModalPending">×</span>
              <h2>รายละเอียด</h2>
              <div id="modalContentPending"></div>
            </div>
          </div>
          <div class="pending-pagination">
            <button id="firstPagePending"><i class="fas fa-chevron-left"></i><i class="fas fa-chevron-left"></i></button>
            <button id="prevPagePending"><i class="fas fa-chevron-left"></i></button>
            <div id="pageNumbersPending"></div>
            <button id="nextPagePending"><i class="fas fa-chevron-right"></i></button>
            <button id="lastPagePending">
              <i class="fas fa-chevron-right"></i><i class="fas fa-chevron-right"></i>
            </button>
            <div class="pending-items-per-page">
              <label for="itemsPerPagePending">รายการต่อหน้า:</label>
              <select id="itemsPerPagePending">
                <option value="10">10 รายการ</option>
                <option value="20" selected>20 รายการ</option>
                <option value="30">30 รายการ</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      <!-- Settings Modal -->
      <div id="settingsModal" class="settings-modal">
        <div class="settings-modal-content">
          <span class="close-settings" id="closeSettings">&times;</span>
          <h2>การตั้งค่า</h2>
          <div id="userInfo">
            <p>ชื่อผู้ใช้: <span id="modalUserName"></span></p>
          </div>
          <div style="text-align: left; margin: 12px 0;"> <!-- ลด margin -->
            <label style="display: block; margin-bottom: 8px; font-weight: bold;">โหมดธีม</label> <!-- ลด margin -->
            <select id="themeSelect" style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ccc;"> <!-- ลด padding -->
              <option value="dark">โหมดมืด</option>
              <option value="light">โหมดสว่าง</option>
            </select>
          </div>
          <button class="modal-qr-btn" onclick="showQRCode()" title="QR Code"><i class="fas fa-qrcode"></i></button>
          <button class="modal-logout-btn" onclick="handleLogout()" title="ออกจากระบบ"><i class="fas fa-sign-out-alt"></i></button>
        </div>
      </div>
      <!-- Bottom Navigation -->
      <div class="bottom-nav">
        <button class="nav-btn active" id="nav-parts" data-tab="parts" onclick="showTab('parts')" data-label="ค้นหาอะไหล่"><i class="fas fa-search"></i></button>
        <button class="nav-btn" id="nav-images" data-tab="images" onclick="showTab('images')" data-label="รูปภาพ"><i class="fas fa-images"></i></button>
        <button class="nav-btn" id="nav-today" data-tab="today" onclick="showTab('today')" data-label="เบิกวันนี้"><i class="fas fa-calendar-day"></i></button>
        <button class="nav-btn" id="nav-pending" data-tab="pending-calls" onclick="showTab('pending-calls')" data-label="Call"><i class="fas fa-phone"></i></button>
        <button class="nav-btn setting-nav" onclick="showSettings()" data-label="ตั้งค่า"><i class="fas fa-cog"></i></button>
      </div>
      <div class="footer">
        <p>⚠️ ระบบนี้สำหรับคลังสินค้าวิภาวดี 62 เท่านั้น | ข้อมูลถูกส่งไปยัง Google Sheet อย่างปลอดภัย | หากมีข้อสงสัย ติดต่อ คลังสินค้าวิภาวดี 62</p>
        <p>© 2025 คลังสินค้า SparePart วิภาวดี 62 | สงวนลิขสิทธิ์</p>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      // Global employee data
      let employeeData = [];
      // Global search values for syncing between parts and images tabs
      let globalSearch1 = '';
      let globalSearch2 = '';
      // Global for today tab: toggle pending only
      let pendingOnly = true;
      // Sort config for today tab
      let sortConfigToday = { column: 'IDRow', direction: 'desc' }; // Default to descending IDRow
      // Pagination config for today tab
      let currentPageToday = 1;
      let itemsPerPageToday = 20; // Default to 20 items per page
      // Opensheet URL for Request sheet
      const requestSheetUrl = 'https://opensheet.elk.sh/1xyy70cq2vAxGv4gPIGiL_xA5czDXqS2i6YYqW4yEVbE/Request';
      // GAS URL for the new Code.gs deployment (update with your new script ID after deployment)
      const gasUrl = 'https://script.google.com/macros/s/AKfycbwVF2HAC8EYARt6Ku2ThUZWgeVxXWDhRQCQ0vCgGvilEMg8h5Hg3BlrcJJn2qMMqpGr/exec'; // Replace with new deployment URL if different
      // Parts tab variables (moved up to avoid initialization error)
      const sheetID = "1nbhLKxs7NldWo_y0s4qZ8rlpIfyyGkR_Dqq8INmhYlw";
      const sheetName = "MainSap";
      const url = `https://opensheet.elk.sh/${sheetID}/${sheetName}`;
      const searchInput1 = document.getElementById("searchInput1");
      const searchInput2 = document.getElementById("searchInput2");
      const searchButton = document.getElementById("searchButton");
      const tableBody = document.querySelector("#data-table tbody");
          const tableContainerParts = document.querySelector("#parts .table-container");
      const pagination = document.getElementById("pagination");
      const pageNumbers = document.getElementById("pageNumbers");
      const itemsPerPageSelect = document.getElementById("itemsPerPage");
      const firstPageButton = document.getElementById("firstPage");
      const prevPageButton = document.getElementById("prevPage");
      const nextPageButton = document.getElementById("nextPage");
      const lastPageButton = document.getElementById("lastPage");
      const errorContainer = document.getElementById("error-container");
      const retryButton = document.getElementById("retry-button");
      let allData = [];
      let tempFilteredData = [];
      let currentPage = 1;
      let itemsPerPage = 10;
      let currentFilteredData = [];
      // Images tab variables (moved up)
      const searchInputImages1 = document.getElementById("searchInputImages1");
      const searchInputImages2 = document.getElementById("searchInputImages2");
      const searchButtonImages = document.getElementById("searchButtonImages");
      const galleryContainer = document.getElementById("gallery-container-images");
      const paginationImages = document.getElementById("paginationImages");
      const pageNumbersImages = document.getElementById("pageNumbersImages");
      const itemsPerPageSelectImages = document.getElementById("itemsPerPageImages");
      const firstPageButtonImages = document.getElementById("firstPageImages");
      const prevPageButtonImages = document.getElementById("prevPageImages");
      const nextPageButtonImages = document.getElementById("nextPageImages");
      const lastPageButtonImages = document.getElementById("lastPageImages");
      const errorContainerImages = document.getElementById("error-container-images");
      const retryButtonImages = document.getElementById("retry-button-images");
      let allDataImages = [];
      let tempFilteredDataImages = [];
      let currentPageImages = 1;
      let itemsPerPageImages = 10;
      let currentFilteredDataImages = [];
      // Today tab variables (moved up)
      const modal = document.getElementById("detailModal");
      const modalContent = document.getElementById("modalContent");
      const closeModal = document.getElementById("closeModal");
      const searchInputToday = document.getElementById("searchInputToday");
      const tableBodyToday = document.querySelector("#data-table-today tbody");
      const errorContainerToday = document.getElementById("error-container-today");
      const retryButtonToday = document.getElementById("retry-button-today");
      const toggleAllDataBtn = document.getElementById("toggleAllDataBtn");
      // Pagination elements for today tab
      const paginationToday = document.getElementById("paginationToday");
      const pageNumbersToday = document.getElementById("pageNumbersToday");
      const itemsPerPageSelectToday = document.getElementById("itemsPerPageToday");
      const firstPageButtonToday = document.getElementById("firstPageToday");
      const prevPageButtonToday = document.getElementById("prevPageToday");
      const nextPageButtonToday = document.getElementById("nextPageToday");
      const lastPageButtonToday = document.getElementById("lastPageToday");
      let allDataToday = [];
      let currentFilteredDataToday = [];
      // All tab variables (moved up)
      const modalAll = document.getElementById("detailModalAll");
      const modalContentAll = document.getElementById("modalContentAll");
      const closeModalAll = document.getElementById("closeModalAll");
      const searchInputAll = document.getElementById("searchInputAll");
      const tableBodyAll = document.querySelector("#data-table-all tbody");
      const pageNumbersContainerAll = document.getElementById("pageNumbersAll");
      const firstPageButtonAll = document.getElementById("firstPageAll");
      const prevPageButtonAll = document.getElementById("prevPageAll");
      const nextPageButtonAll = document.getElementById("nextPageAll");
      const lastPageButtonAll = document.getElementById("lastPageAll");
      const itemsPerPageSelectAll = document.getElementById("itemsPerPageAll");
      let allDataAll = [];
      let currentPageAll = 1;
      let itemsPerPageAll = parseInt(itemsPerPageSelectAll.value);
      // Pending calls tab variables (moved up)
      const sheetIDPending = '1dzE4Xjc7H0OtNUmne62u0jFQT-CiGsG2eBo-1v6mrZk';
      const sheetNamePending = 'Call_Report';
      const urlPending = `https://opensheet.elk.sh/${sheetIDPending}/${sheetNamePending}`;
      const modalPending = document.getElementById("detailModalPending");
      const modalContentPending = document.getElementById("modalContentPending");
      const closeModalPending = document.getElementById("closeModalPending");
      const teamFilterPending = document.getElementById("teamFilterPending");
      const searchInputPending = document.getElementById("searchInputPending");
      const searchButtonPending = document.getElementById("searchButtonPending");
      const tableBodyPending = document.querySelector("#data-table-pending tbody");
      const pageNumbersContainerPending = document.getElementById("pageNumbersPending");
      const firstPageButtonPending = document.getElementById("firstPagePending");
      const prevPageButtonPending = document.getElementById("prevPagePending");
      const nextPageButtonPending = document.getElementById("nextPagePending");
      const lastPageButtonPending = document.getElementById("lastPagePending");
      const itemsPerPageSelectPending = document.getElementById("itemsPerPagePending");
      let allDataPending = [];
      let currentPagePending = 1;
      let itemsPerPagePending = 20;
      let sortConfigPending = { column: null, direction: 'asc' };
      // Image Modal Handling for #parts (moved up)
      const imageModal = document.getElementById('imageModal');
      const imageModalContent = document.getElementById('imageModalContent');
      const closeImageModal = document.getElementById('closeImageModal');
      closeImageModal.onclick = () => {
        imageModal.style.display = 'none';
      };
      window.onclick = (event) => {
        if (event.target === imageModal) {
          imageModal.style.display = 'none';
        }
      };
      // Image Modal Handling for #images (moved up)
      const imageModalImages = document.getElementById('imageModalImages');
      const imageModalContentImages = document.getElementById('imageModalContentImages');
      const closeImageModalImages = document.getElementById('closeImageModalImages');
      closeImageModalImages.onclick = () => {
        imageModalImages.style.display = 'none';
      };
      window.onclick = (event) => {
        if (event.target === imageModalImages) {
          imageModalImages.style.display = 'none';
        }
      };
      // Theme Management
      function setTheme(theme) {
        localStorage.setItem('theme', theme);
        document.body.classList.remove('dark-mode', 'light-mode');
        document.body.classList.add(theme + '-mode');
      }
      function loadTheme() {
        const theme = localStorage.getItem('theme') || 'light';
        setTheme(theme);
        if (document.getElementById('themeSelect')) {
          document.getElementById('themeSelect').value = theme;
        }
      }
      function showSettings() {
        const currentTheme = localStorage.getItem('theme') || 'light';
        document.getElementById('modalUserName').textContent = localStorage.getItem('userName') || '';
        document.getElementById('themeSelect').value = currentTheme;
        document.getElementById('settingsModal').style.display = 'block';
        // Add event for theme change in modal
        document.getElementById('themeSelect').onchange = (e) => {
          setTheme(e.target.value);
        };
      }
      // Close settings modal
      document.getElementById('closeSettings').onclick = () => {
        document.getElementById('settingsModal').style.display = 'none';
      };
      window.onclick = (event) => {
        const settingsModal = document.getElementById('settingsModal');
        if (event.target === settingsModal) {
          settingsModal.style.display = 'none';
        }
        // Existing modals...
        if (event.target == modal) closeModal.click();
        if (event.target == modalAll) closeModalAll.click();
        if (event.target == modalPending) closeModalPending.click();
      };
      // Login System
      const loginModal = document.getElementById('loginModal');
      const appContent = document.getElementById('appContent');
      const logoutBtn = document.getElementById('logoutBtn');
      const usernameInput = document.getElementById('username');
      const passwordInput = document.getElementById('password');
      const loginError = document.getElementById('loginError');
      const rememberMeCheckbox = document.getElementById('rememberMe');
      const togglePasswordIcon = document.getElementById('togglePassword');
      const userNameSmall = document.getElementById('userNameSmall');
      function togglePasswordVisibility() {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        togglePasswordIcon.classList.toggle('fa-eye-slash');
        togglePasswordIcon.classList.toggle('fa-eye');
      }
      async function loadEmployeeData() {
        const employeeSheetID = "1eqVoLsZxGguEbRCC5rdI4iMVtQ7CK4T3uXRdx8zE3uw";
        const employeeSheetName = "Employee";
        const employeeUrl = `https://opensheet.elk.sh/${employeeSheetID}/${employeeSheetName}`;
        try {
          const response = await fetch(employeeUrl);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          return data;
        } catch (error) {
          console.error("Error loading employee data:", error);
          throw error;
        }
      }
      async function handleLogin() {
        const username = usernameInput.value.trim();
        const password = passwordInput.value.trim();
        loginError.style.display = 'none';
        if (!username || !password) {
          loginError.textContent = 'กรุณากรอกชื่อผู้ใช้และรหัสผ่าน';
          loginError.style.display = 'block';
          return;
        }
        try {
          employeeData = await loadEmployeeData();
          const expectedPassword = username.slice(-4);
          const employee = employeeData.find(e => e.IDRec && e.IDRec.toString().trim() === username && expectedPassword === password);
          if (employee && employee.Name) {
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('username', username);
            localStorage.setItem('userName', employee.Name);
            if (rememberMeCheckbox.checked) {
              localStorage.setItem('savedUsername', username);
              localStorage.setItem('rememberMe', 'true');
            } else {
              localStorage.removeItem('savedUsername');
              localStorage.removeItem('rememberMe');
            }
            checkLoginStatus();
            // Focus on search input after login
            setTimeout(() => {
              const searchInput = document.getElementById('searchInput1');
              if (searchInput) searchInput.focus();
            }, 500);
          } else {
            loginError.textContent = 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง!';
            loginError.style.display = 'block';
            passwordInput.value = ''; // Clear password on error
          }
        } catch (error) {
          loginError.textContent = 'เกิดข้อผิดพลาดในการโหลดข้อมูลพนักงาน กรุณาลองใหม่';
          loginError.style.display = 'block';
          console.error('Login error:', error);
        }
      }
      function checkLoginStatus() {
        const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
        const savedUsername = localStorage.getItem('username');
        if (isLoggedIn && savedUsername) {
          loginModal.classList.remove('active');
          appContent.classList.add('logged-in');
          userNameSmall.textContent = localStorage.getItem('userName') || '';
          // Auto-load default tab if needed
          if (document.querySelector('.nav-btn.active')) {
            showTab('parts');
          }
        } else {
          loginModal.classList.add('active');
          appContent.classList.remove('logged-in');
          userNameSmall.textContent = '';
          // Clear invalid session
          localStorage.removeItem('isLoggedIn');
          localStorage.removeItem('username');
          localStorage.removeItem('userName');
          localStorage.removeItem('savedPassword'); // Clear saved password on invalid session
        }
        // Load saved credentials if remember me was checked
        if (localStorage.getItem('rememberMe') === 'true') {
          const savedUsername = localStorage.getItem('savedUsername');
          if (savedUsername) usernameInput.value = savedUsername;
          rememberMeCheckbox.checked = true;
        }
      }
      function handleLogout() {
        localStorage.removeItem('isLoggedIn');
        localStorage.removeItem('username');
        localStorage.removeItem('userName');
        localStorage.removeItem('savedUsername');
        localStorage.removeItem('savedPassword');
        localStorage.removeItem('rememberMe');
        checkLoginStatus();
        // Close settings modal if open
        document.getElementById('settingsModal').style.display = 'none';
      }
      // Allow Enter key for login
      passwordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          handleLogin();
        }
      });
      function showTab(tabId) {
        const contents = document.querySelectorAll(".tab-content");
        contents.forEach((tab) => tab.classList.remove("active"));
        const targetTab = document.getElementById(tabId);
        targetTab.classList.add("active");
        // Update bottom nav active state
        const navButtons = document.querySelectorAll(".nav-btn");
        navButtons.forEach((btn) => btn.classList.remove("active"));
        const clickedNav = document.querySelector(`[data-tab="${tabId}"]`);
        if (clickedNav) clickedNav.classList.add("active");
        document.getElementById("loading").style.display = "flex";
        if (tabId === "parts") {
          document.getElementById('searchInput1').value = globalSearch1;
          document.getElementById('searchInput2').value = globalSearch2;
          loadData();
        } else if (tabId === "images") {
          document.getElementById('searchInputImages1').value = globalSearch1;
          document.getElementById('searchInputImages2').value = globalSearch2;
          loadImagesData();
        } else if (tabId === "today") {
          loadTodayData();
        } else if (tabId === "all") {
          loadAllData();
        } else if (tabId === "pending-calls") {
          loadPendingCallsData();
        }
        hideLoading();
      }
      function hideLoading() {
        document.getElementById("loading").style.display = "none";
      }
      function showQRCode() {
        Swal.fire({
          title: '📷 สแกน QR Code',
          html: `
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://request-nawanakorn.vercel.app/" alt="QR Code" class="swal2-qrcode" style="width: 150px; height: 150px;">
            <p>สแกนเพื่อเข้าสู่ระบบขอเบิกอะไหล่</p>
          `,
          confirmButtonText: 'ปิด',
          customClass: {
            popup: 'swal2-popup',
            title: 'swal2-title',
            confirmButton: 'swal2-confirm'
          }
        });
      }
      // Parts tab functions (now after variables)
      itemsPerPageSelect.addEventListener("change", () => {
        itemsPerPage = parseInt(itemsPerPageSelect.value, 10);
        currentPage = 1;
        renderTableData();
        renderPagination(allData.length);
      });
      retryButton.addEventListener("click", () => {
        errorContainer.style.display = "none";
        loadData();
      });
      function showImageModal(row) {
        const fields = [
          { key: 'Material', label: 'Material' },
          { key: 'Description', label: 'Description' },
          { key: 'วิภาวดี', label: 'วิภาวดี' },
          { key: 'Unrestricted', label: 'นวนคร' },
          { key: 'Rebuilt', label: 'Rebuilt' },
          { key: 'หมายเหตุ', label: 'หมายเหตุ' },
          { key: 'Product', label: 'Product' },
          { key: 'OCRTAXT', label: 'Spec' }
        ];
        let html = '';
        fields.forEach(field => {
          let value = row[field.key] || '';
          if (field.key === 'วิภาวดี' || field.key === 'Unrestricted') {
            if (value && !isNaN(value)) {
              value = Number(value).toLocaleString('en-US', { maximumFractionDigits: 0 });
            } else if (value === '0' || value === 0) {
              value = '';
            }
          }
          if ((field.key === 'หมายเหตุ' || field.key === 'Rebuilt') && value) {
            value = `<span style="color: red; font-weight: bold;">${value}</span>`;
          }
          if (field.key === 'Material') {
            // Special handling for Material row: add flex layout and requisition button
            html += `
              <div class="material-row">
                <span class="label">${field.label}:</span>
                <div style="display: flex; align-items: center; flex-grow: 1;">
                  <span class="value">${value}</span>
                  <button class="requisition-button" onclick="showRequisitionDialog(${JSON.stringify(row).replace(/"/g, '&quot;')})">เบิก</button>
                </div>
              </div>
            `;
          } else {
            html += `<div><span class="label">${field.label}:</span> <span class="value">${value}</span></div>`;
          }
        });
        // Add iframe for Google Drive image using 'id' column
        if (row.id) {
          html += `
            <div style="margin-top: 20px;">
              <strong>รูปภาพอะไหล่:</strong>
              <iframe class="drive-iframe" src="https://drive.google.com/file/d/${row.id}/preview" allowfullscreen></iframe>
            </div>
          `;
        } else {
          html += '<div><span class="label">รูปภาพ:</span> <span class="value">ไม่พบข้อมูลรูปภาพ</span></div>';
        }
        imageModalContent.innerHTML = html;
        imageModal.style.display = 'block';
      }
      function renderTable(data) {
        if (!tableBody) {
          console.error("Table body for #data-table not found");
          Swal.fire({
            icon: "error",
            title: "ข้อผิดพลาด",
            text: "ไม่พบตารางข้อมูล กรุณาตรวจสอบโครงสร้างหน้าเว็บ",
            confirmButtonText: "ตกลง",
          });
          return;
        }
        tableBody.innerHTML = "";
        data.forEach((row) => {
          const tr = document.createElement("tr");
          const requisitionTd = document.createElement("td");
          const btn = document.createElement("button");
          btn.textContent = "เบิก";
          btn.className = "requisition-button";
          btn.onclick = () => showRequisitionDialog(row);
          requisitionTd.appendChild(btn);
          tr.appendChild(requisitionTd);
          const columns = [
            "UrlWeb",
            "Material",
            "Description",
            "วิภาวดี",
            "Unrestricted",
            "Rebuilt",
            "หมายเหตุ",
            "Product",
            "OCRTAXT"
          ];
          // Convert values to numbers for comparison
          const vibhavadiValue = parseFloat(row["วิภาวดี"]) || 0;
          const unrestrictedValue = parseFloat(row["Unrestricted"]) || 0;
          // Determine styling based on conditions
          let textColor = "";
          let fontWeight = "";
          if (vibhavadiValue > 0) {
            textColor = "#4caf50"; // Green
            fontWeight = "bold";
          } else if (vibhavadiValue === 0 && unrestrictedValue > 0) {
            textColor = "#2196f3"; // Blue
            fontWeight = "bold";
          }
          columns.forEach((col) => {
            const td = document.createElement("td");
            let value = row[col] || "";
            if (col === "วิภาวดี" || col === "Unrestricted") {
              if (value && !isNaN(value)) {
                value = Number(value).toLocaleString("en-US", {
                  maximumFractionDigits: 0,
                });
              } else if (value === "0" || value === 0) {
                value = "";
              }
            }
            if ((col === "หมายเหตุ" || col === "Rebuilt") && value) {
              td.style.color = "red";
              td.style.fontWeight = "bold";
            }
            // Apply conditional styling to Material, Description, วิภาวดี, and Unrestricted
            if (
              col === "Material" ||
              col === "Description" ||
              col === "วิภาวดี" ||
              col === "Unrestricted"
            ) {
              if (textColor) td.style.color = textColor;
              if (fontWeight) td.style.fontWeight = fontWeight;
            }
            if (col === "UrlWeb" && value) {
              // Changed to button that opens modal instead of external link
              const imageBtn = document.createElement("button");
              imageBtn.innerHTML = '<i class="fas fa-image"></i>';
              imageBtn.className = "image-button";
              imageBtn.onclick = () => showImageModal(row); // Use row.id for iframe
              td.appendChild(imageBtn);
            } else {
              td.textContent = value;
            }
            tr.appendChild(td);
          });
          tableBody.appendChild(tr);
        });
      }
      async function showRequisitionDialog(row) {
        document.body.style.overflow = 'hidden';
        const history = {
          employeeCode: getFromLocalStorage('employeeCode'),
          team: getFromLocalStorage('team'),
          contact: getFromLocalStorage('contact'),
          callNumber: getFromLocalStorage('callNumber'),
          callType: getFromLocalStorage('callType'),
        };
        if (employeeData.length === 0) {
          employeeData = await loadEmployeeData();
        }
        Swal.fire({
          title: '📋 เบิกอะไหล่นวนคร',
          html: `
            <style>
              .autocomplete-items {
                position: absolute;
                border: 1px solid #ccc;
                border-top: none;
                z-index: 9999;
                background-color: white;
                width: 100%;
                max-height: 120px;
                overflow-y: auto;
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                margin-top: 2px;
                border-radius: 6px;
              }
              .autocomplete-item {
                padding: 6px;
                cursor: pointer;
                font-size: 14px;
              }
              .autocomplete-item:hover {
                background-color: #f1f1f1;
              }
              .swal2-label {
                text-align: left !important;
                display: block !important;
                margin: 8px 0 4px !important;
                font-weight: bold !important;
                width: 100% !important;
              }
              .swal2-input, .swal2-select {
                width: 100% !important;
                margin: 4px 0 !important;
                padding: 6px !important;
                box-sizing: border-box !important;
                font-size: 14px !important;
                height: 36px !important;
              }
              .error-message {
                color: red !important;
                font-size: 12px !important;
                margin-top: 2px !important;
                display: block !important;
                text-align: left !important;
              }
              .invalid-input {
                border: 2px solid red !important;
                box-shadow: 0 0 5px rgba(255, 0, 0, 0.5) !important;
              }
              #swal-employee-name-display, #swal-team-display {
                color: #4caf50 !important;
                font-weight: bold !important;
                margin: 4px 0 !important;
                padding: 4px !important;
                background: #e8f5e8 !important;
                border-radius: 4px !important;
                text-align: left !important;
              }
            </style>
            <div class="swal2-label">📦 Material: ${row.Material || ''}</div>
            <div class="swal2-label">📝 Description: ${row.Description || ''}</div>
            <label class="swal2-label">🔢 จำนวน</label>
            <input id="swal-quantity" class="swal2-input" type="number" value="1" min="1">
            <span id="swal-quantity-error" class="error-message"></span>
            <label class="swal2-label">🆔 รหัสพนักงาน</label>
            <input id="swal-employee-code" class="swal2-input" placeholder="7xxxxxx">
            <div id="employee-code-history" class="autocomplete-items" style="display:none;"></div>
            <span id="swal-employee-code-error" class="error-message"></span>
            <label class="swal2-label">👤 ชื่อพนักงาน</label>
            <div id="swal-employee-name-display"></div>
            <label class="swal2-label">👥 ทีม</label>
            <div id="swal-team-display"></div>
            <label class="swal2-label">📞 เบอร์ติดต่อ</label>
            <input id="swal-contact" class="swal2-input" placeholder="เช่น 08xxxxxxxx">
            <div id="contact-history" class="autocomplete-items" style="display:none;"></div>
            <span id="swal-contact-error" class="error-message"></span>
            <label class="swal2-label">📄 เลขที่ Call</label>
            <input id="swal-call-number" class="swal2-input" placeholder="2... หรือ ...">
            <div id="call-number-history" class="autocomplete-items" style="display:none;"></div>
            <span id="swal-call-number-error" class="error-message"></span>
            <label class="swal2-label">🗳️ Call Type</label>
            <select id="swal-call-type" class="swal2-select">
              <option value="" disabled selected>เลือก Call Type</option>
              <option value="I">I</option>
              <option value="P">P</option>
              <option value="Q">Q</option>
              <option value="R">R</option>
            </select>
            <span id="swal-call-type-error" class="error-message"></span>
            <label class="swal2-label">🗒️ หมายเหตุ</label>
            <input id="swal-remark" class="swal2-input" placeholder="ไม่บังคับ">
            <span id="swal-remark-error" class="error-message"></span>
          `,
          focusConfirm: false,
          showCancelButton: true,
          confirmButtonText: 'ยืนยัน',
          cancelButtonText: 'ยกเลิก',
          allowOutsideClick: false,
          allowEscapeKey: false,
          didOpen: () => {
            // Force high z-index and ensure backdrop covers full screen (logic เดิม)
            const swalContainer = document.querySelector('.swal2-container');
            if (swalContainer) {
              swalContainer.style.zIndex = '99998';
              swalContainer.style.position = 'fixed';
              swalContainer.style.top = '0';
              swalContainer.style.left = '0';
              swalContainer.style.width = '100vw';
              swalContainer.style.height = '100vh';
              swalContainer.style.display = 'flex';
              swalContainer.style.justifyContent = 'center';
              swalContainer.style.alignItems = 'center';
            }
            const swalBackdrop = document.querySelector('.swal2-backdrop');
            if (swalBackdrop) {
              swalBackdrop.style.zIndex = '99997';
              swalBackdrop.style.position = 'fixed';
              swalBackdrop.style.top = '0';
              swalBackdrop.style.left = '0';
              swalBackdrop.style.width = '100vw';
              swalBackdrop.style.height = '100vh';
              swalBackdrop.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
              swalBackdrop.style.backdropFilter = 'blur(8px)';
            }
            const swalPopup = document.querySelector('.swal2-popup');
            if (swalPopup) {
              swalPopup.style.zIndex = '99999';
              swalPopup.style.position = 'relative';
              swalPopup.style.margin = '0';
              swalPopup.style.transform = 'none';
              swalPopup.style.maxHeight = '90vh';
              swalPopup.style.overflowY = 'auto';
              swalPopup.style.width = 'auto';
              swalPopup.style.maxWidth = '90vw';
              if (window.innerWidth <= 768) {
                swalPopup.style.width = '95vw';
                swalPopup.style.padding = '15px';
              }
            }
            const quantityInput = document.getElementById('swal-quantity');
            const employeeCodeInput = document.getElementById('swal-employee-code');
            const contactInput = document.getElementById('swal-contact');
            const callNumberInput = document.getElementById('swal-call-number');
            const callTypeInput = document.getElementById('swal-call-type');
            const remarkInput = document.getElementById('swal-remark'); // เปลี่ยนจาก readonly เป็น editable
            const confirmButton = document.querySelector('.swal2-confirm');
            confirmButton.disabled = true;
            function setupAutocomplete(input, key, containerId) {
              input.addEventListener('input', () => {
                const container = document.getElementById(containerId);
                const val = input.value.toLowerCase();
                const items = getFromLocalStorage(key).filter(item => item.toLowerCase().includes(val));
                container.innerHTML = '';
                items.forEach(item => {
                  const div = document.createElement('div');
                  div.className = 'autocomplete-item';
                  div.textContent = item;
                  div.onclick = () => {
                    input.value = item;
                    container.style.display = 'none';
                    validateInputs();
                  };
                  container.appendChild(div);
                });
                container.style.display = items.length ? 'block' : 'none';
              });
              input.addEventListener('blur', () => {
                setTimeout(() => {
                  const container = document.getElementById(containerId);
                  container.style.display = 'none';
                }, 200);
              });
            }
            setupAutocomplete(contactInput, 'contact', 'contact-history');
            setupAutocomplete(callNumberInput, 'callNumber', 'call-number-history');
            // setupAutocomplete(callTypeInput, 'callType', 'call-type-history'); // ถ้าต้องการ autocomplete สำหรับ callType
            const lastContact = getFromLocalStorage('contact')[0];
            if (lastContact) contactInput.value = lastContact;
            const inputs = [quantityInput, employeeCodeInput, contactInput, callNumberInput, callTypeInput, remarkInput];
            function validateInputs() {
              const errors = {
                quantityError: document.getElementById('swal-quantity-error'),
                employeeCodeError: document.getElementById('swal-employee-code-error'),
                contactError: document.getElementById('swal-contact-error'),
                callNumberError: document.getElementById('swal-call-number-error'),
                callTypeError: document.getElementById('swal-call-type-error'),
                remarkError: document.getElementById('swal-remark-error')
              };
              inputs.forEach(input => input.classList.remove('invalid-input'));
              Object.values(errors).forEach(el => el.textContent = '');
              let isValid = true;
              if (!quantityInput.value || quantityInput.value < 1) {
                errors.quantityError.textContent = 'กรุณากรอกจำนวนที่มากกว่าหรือเท่ากับ 1';
                quantityInput.classList.add('invalid-input');
                isValid = false;
              }
              const employeeCode = employeeCodeInput.value.trim();
              if (!employeeCode || !/^\d{7}$/.test(employeeCode) || employeeCode[0] !== '7') {
                errors.employeeCodeError.textContent = 'รหัสพนักงานต้องเป็นตัวเลข 7 หลัก เริ่มด้วย 7 (เช่น 7512411)';
                employeeCodeInput.classList.add('invalid-input');
                document.getElementById('swal-employee-name-display').textContent = '';
                document.getElementById('swal-team-display').textContent = '';
                isValid = false;
              } else {
                const employee = employeeData.find(e => e.IDRec && e.IDRec.toString().trim() === employeeCode);
                if (!employee || !employee.Name) {
                  errors.employeeCodeError.textContent = 'ไม่พบรหัสพนักงานนี้ในระบบ';
                  employeeCodeInput.classList.add('invalid-input');
                  document.getElementById('swal-employee-name-display').textContent = '';
                  document.getElementById('swal-team-display').textContent = '';
                  isValid = false;
                } else {
                  document.getElementById('swal-employee-name-display').textContent = `${employee.Name}`;
                  document.getElementById('swal-team-display').textContent = `${employee.หน่วยงาน || ''}`;
                  errors.employeeCodeError.textContent = '';
                }
              }
              if (!contactInput.value || !/^(0|\+66)[6-9][0-9]{7,8}$/.test(contactInput.value)) {
                errors.contactError.textContent = 'กรุณากรอกเบอร์ติดต่อที่ถูกต้อง (เช่น 08xxxxxxxx)';
                contactInput.classList.add('invalid-input');
                isValid = false;
              }
              const hasRemark = remarkInput.value.trim().length > 0;
              if (!hasRemark) {
                if (!callNumberInput.value) {
                  errors.callNumberError.textContent = 'กรุณากรอกเลขที่ Call';
                  callNumberInput.classList.add('invalid-input');
                  isValid = false;
                } else if (
                  (callNumberInput.value.startsWith('2') && callNumberInput.value.length !== 11) ||
                  (!callNumberInput.value.startsWith('2') && callNumberInput.value.length !== 7)
                ) {
                  errors.callNumberError.textContent = 'เลขที่ Call ต้องขึ้นต้นด้วย 2 (11 ตัวอักษร) หรือ (7 ตัวอักษร)';
                  callNumberInput.classList.add('invalid-input');
                  isValid = false;
                }
                if (!callTypeInput.value) {
                  errors.callTypeError.textContent = 'กรุณาเลือก Call Type';
                  callTypeInput.classList.add('invalid-input');
                  isValid = false;
                }
              }
              confirmButton.disabled = !isValid;
            }
            quantityInput.addEventListener('input', validateInputs);
            employeeCodeInput.addEventListener('input', validateInputs);
            contactInput.addEventListener('input', validateInputs);
            callNumberInput.addEventListener('input', validateInputs);
            callTypeInput.addEventListener('change', validateInputs);
            remarkInput.addEventListener('input', validateInputs);
            validateInputs();
            quantityInput.focus();
          },
          didClose: () => {
            document.body.style.overflow = 'auto';
          },
          preConfirm: () => {
            const quantityInput = document.getElementById('swal-quantity');
            const employeeCodeInput = document.getElementById('swal-employee-code');
            const contactInput = document.getElementById('swal-contact');
            const callNumberInput = document.getElementById('swal-call-number');
            const callTypeInput = document.getElementById('swal-call-type');
            const remarkInput = document.getElementById('swal-remark');
            const errors = {
              quantityError: document.getElementById('swal-quantity-error'),
              employeeCodeError: document.getElementById('swal-employee-code-error'),
              contactError: document.getElementById('swal-contact-error'),
              callNumberError: document.getElementById('swal-call-number-error'),
              callTypeError: document.getElementById('swal-call-type-error'),
              remarkError: document.getElementById('swal-remark-error')
            };
            [quantityInput, employeeCodeInput, contactInput, callNumberInput, callTypeInput, remarkInput].forEach(input => {
              input.classList.remove('invalid-input');
            });
            Object.values(errors).forEach(el => el.textContent = '');
            let isValid = true;
            if (!quantityInput.value || quantityInput.value < 1) {
              errors.quantityError.textContent = 'กรุณากรอกจำนวนที่มากกว่าหรือเท่ากับ 1';
              quantityInput.classList.add('invalid-input');
              isValid = false;
            }
            const employeeCode = employeeCodeInput.value.trim();
            if (!employeeCode || !/^\d{7}$/.test(employeeCode) || employeeCode[0] !== '7') {
              errors.employeeCodeError.textContent = 'รหัสพนักงานต้องเป็นตัวเลข 7 หลัก เริ่มด้วย 7 (เช่น 7512411)';
              employeeCodeInput.classList.add('invalid-input');
              isValid = false;
            } else {
              const employee = employeeData.find(e => e.IDRec && e.IDRec.toString().trim() === employeeCode);
              if (!employee || !employee.Name) {
                errors.employeeCodeError.textContent = 'ไม่พบรหัสพนักงานนี้ในระบบ';
                employeeCodeInput.classList.add('invalid-input');
                isValid = false;
              }
            }
            if (!contactInput.value || !/^(0|\+66)[6-9][0-9]{7,8}$/.test(contactInput.value)) {
              errors.contactError.textContent = 'กรุณากรอกเบอร์ติดต่อที่ถูกต้อง (เช่น 08xxxxxxxx)';
              contactInput.classList.add('invalid-input');
              isValid = false;
            }
            const hasRemark = remarkInput.value.trim().length > 0;
            if (!hasRemark) {
              if (!callNumberInput.value) {
                errors.callNumberError.textContent = 'กรุณากรอกเลขที่ Call';
                callNumberInput.classList.add('invalid-input');
                isValid = false;
              } else if (
                (callNumberInput.value.startsWith('2') && callNumberInput.value.length !== 11) ||
                (!callNumberInput.value.startsWith('2') && callNumberInput.value.length !== 7)
              ) {
                errors.callNumberError.textContent = 'เลขที่ Call ต้องขึ้นต้นด้วย 2 (11 ตัวอักษร) หรือ (7 ตัวอักษร)';
                callNumberInput.classList.add('invalid-input');
                isValid = false;
              }
              if (!callTypeInput.value) {
                errors.callTypeError.textContent = 'กรุณาเลือก Call Type';
                callTypeInput.classList.add('invalid-input');
                isValid = false;
              }
            }
            if (isValid) {
              const employee = employeeData.find(e => e.IDRec && e.IDRec.toString().trim() === employeeCode);
              saveToLocalStorage('employeeCode', employeeCode);
              saveToLocalStorage('contact', contactInput.value);
              if (callNumberInput.value) {
                saveToLocalStorage('callNumber', callNumberInput.value);
              }
              if (callTypeInput.value) {
                saveToLocalStorage('callType', callTypeInput.value);
              }
              return {
                quantity: quantityInput.value,
                employeeCode: employeeCode,
                employeeName: employee ? employee.Name : '',
                team: employee ? (employee.หน่วยงาน || '') : '',
                contact: contactInput.value,
                callNumber: callNumberInput.value,
                callType: callTypeInput.value,
                remark: remarkInput.value // เพิ่ม remark
              };
            }
            return false;
          }
        }).then(async (result) => {
          if (result.isConfirmed) {
            const formValues = result.value;
            const vibhavadiValue = parseFloat(row["วิภาวดี"]) || 0;
            const quantity = parseFloat(formValues.quantity) || 0;
            // เช็คเงื่อนไขเตือน
            if (quantity <= vibhavadiValue) {
              await Swal.fire({
                icon: 'warning',
                title: '⚠️ คำเตือน',
                text: `ที่คลังวิภาวดีมีอะไหล่ ${vibhavadiValue.toLocaleString()} ชิ้น (จำนวนที่เบิก ${quantity} ชิ้น)`,
                confirmButtonText: 'ยืนยันดำเนินการต่อ',
                allowOutsideClick: false,
                allowEscapeKey: false
              });
            }
            // Popup สรุปข้อมูล (logic เดิม)
            let imageHtml = '';
            if (row.UrlWeb && row.UrlWeb.trim()) {
              imageHtml = `<img src="${row.UrlWeb}" alt="Product Image" class="summary-image" onerror="this.style.display='none'">`;
            }
            const summaryResult = await Swal.fire({
              title: 'สรุปข้อมูลการเบิก',
              html: `
                ${imageHtml}
                <div style="text-align: left; font-size: 14px;">
                  <p><strong>Material:</strong> ${row.Material || ''}</p>
                  <p><strong>Description:</strong> ${row.Description || ''}</p>
                  <p><strong>จำนวน:</strong> ${formValues.quantity}</p>
                  <p><strong>รหัสพนักงาน:</strong> ${formValues.employeeCode}</p>
                  <p><strong>ชื่อพนักงาน:</strong> ${formValues.employeeName}</p>
                  <p><strong>ทีม:</strong> ${formValues.team}</p>
                  <p><strong>เบอร์ติดต่อ:</strong> ${formValues.contact}</p>
                  <p><strong>เลขที่ Call:</strong> ${formValues.callNumber || 'ไม่มี'}</p>
                  <p><strong>Call Type:</strong> ${formValues.callType || 'ไม่มี'}</p>
                  <p><strong>หมายเหตุ:</strong> ${formValues.remark || 'ไม่มี'}</p>
                  <hr style="margin: 10px 0;">
                </div>
              `,
              icon: 'info',
              showCancelButton: true,
              confirmButtonText: 'ยืนยันการเบิก',
              cancelButtonText: 'แก้ไข',
              allowOutsideClick: false,
              allowEscapeKey: false,
              customClass: {
                title: 'dark-blue-title'
              },
              didOpen: () => {
                // Ensure full blur backdrop for summary popup (logic เดิม)
                const swalContainer = document.querySelector('.swal2-container');
                if (swalContainer) {
                  swalContainer.style.zIndex = '99998';
                  swalContainer.style.position = 'fixed';
                  swalContainer.style.top = '0';
                  swalContainer.style.left = '0';
                  swalContainer.style.width = '100vw';
                  swalContainer.style.height = '100vh';
                  swalContainer.style.display = 'flex';
                  swalContainer.style.justifyContent = 'center';
                  swalContainer.style.alignItems = 'center';
                }
                const swalBackdrop = document.querySelector('.swal2-backdrop');
                if (swalBackdrop) {
                  swalBackdrop.style.zIndex = '99997';
                  swalBackdrop.style.position = 'fixed';
                  swalBackdrop.style.top = '0';
                  swalBackdrop.style.left = '0';
                  swalBackdrop.style.width = '100vw';
                  swalBackdrop.style.height = '100vh';
                  swalBackdrop.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                  swalBackdrop.style.backdropFilter = 'blur(8px)';
                }
                const swalPopup = document.querySelector('.swal2-popup');
                if (swalPopup) {
                  swalPopup.style.zIndex = '99999';
                  swalPopup.style.position = 'relative';
                  swalPopup.style.margin = '0';
                  swalPopup.style.transform = 'none';
                  swalPopup.style.maxHeight = '90vh';
                  swalPopup.style.overflowY = 'auto';
                  swalPopup.style.width = 'auto';
                  swalPopup.style.maxWidth = '90vw';
                  if (window.innerWidth <= 768) {
                    swalPopup.style.width = '95vw';
                    swalPopup.style.padding = '15px';
                  }
                }
              }
            });
            if (summaryResult.isConfirmed) {
              // สร้าง JSON payload
              const jsonPayload = {
                material: row.Material || '',
                description: row.Description || '',
                quantity: parseInt(formValues.quantity),
                contact: formValues.contact,
                employeeCode: formValues.employeeCode,
                team: formValues.team,
                employeeName: formValues.employeeName, // เพิ่ม employeeName (ปรับ Code.gs headers ให้รวม 'employeeName' หลัง 'team')
                callNumber: formValues.callNumber || '',
                callType: formValues.callType || '',
                remark: formValues.remark || '',
                vibhavadi: vibhavadiValue.toString() // เพิ่ม vibhavadi
              };
              // แสดง loading
              Swal.fire({
                title: 'กำลังบันทึกข้อมูล...',
                html: `
                  <div class="swal2-spinner-container">
                    <div class="swal2-spinner"></div>
                    <p>กรุณารอสักครู่...</p>
                  </div>
                `,
                showConfirmButton: false,
                allowOutsideClick: false,
                allowEscapeKey: false,
                didOpen: () => {
                  // Ensure full blur for loading popup (logic เดิม)
                  const swalContainer = document.querySelector('.swal2-container');
                  if (swalContainer) {
                    swalContainer.style.zIndex = '99998';
                    swalContainer.style.position = 'fixed';
                    swalContainer.style.top = '0';
                    swalContainer.style.left = '0';
                    swalContainer.style.width = '100vw';
                    swalContainer.style.height = '100vh';
                    swalContainer.style.display = 'flex';
                    swalContainer.style.justifyContent = 'center';
                    swalContainer.style.alignItems = 'center';
                  }
                  const swalBackdrop = document.querySelector('.swal2-backdrop');
                  if (swalBackdrop) {
                    swalBackdrop.style.zIndex = '99997';
                    swalBackdrop.style.position = 'fixed';
                    swalBackdrop.style.top = '0';
                    swalBackdrop.style.left = '0';
                    swalBackdrop.style.width = '100vw';
                    swalBackdrop.style.height = '100vh';
                    swalBackdrop.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                    swalBackdrop.style.backdropFilter = 'blur(8px)';
                  }
                  const swalPopup = document.querySelector('.swal2-popup');
                  if (swalPopup) {
                    swalPopup.style.zIndex = '99999';
                    swalPopup.style.position = 'relative';
                    swalPopup.style.margin = '0';
                    swalPopup.style.transform = 'none';
                    swalPopup.style.maxHeight = '90vh';
                    swalPopup.style.overflowY = 'auto';
                    swalPopup.style.width = 'auto';
                    swalPopup.style.maxWidth = '90vw';
                    if (window.innerWidth <= 768) {
                      swalPopup.style.width = '95vw';
                      swalPopup.style.padding = '15px';
                    }
                  }
                }
              });
              try {
                const response = await fetch(gasUrl, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                  },
                  body: `action=insertRequest&payload=${encodeURIComponent(JSON.stringify(jsonPayload))}` // <- แก้ไขตรงนี้
                });
                const gasResult = await response.json();
                if (gasResult.status === 'success') {
                  Swal.fire({
                    icon: 'success',
                    title: 'ส่งข้อมูลสำเร็จ!',
                    text: gasResult.data.message || 'ข้อมูลได้ถูกบันทึกเรียบร้อยแล้ว',
                    confirmButtonText: 'OK'
                  }).then((result) => {
                    if (result.isConfirmed) {
                      Swal.fire({
                        title: 'กำลังเปลี่ยนหน้า...',
                        html: `
                          <div class="swal2-spinner-container">
                            <div class="swal2-spinner"></div>
                            <p>กรุณารอสักครู่...</p>
                          </div>
                        `,
                        showConfirmButton: false,
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        didOpen: () => {
                          // Ensure full blur for redirect popup (logic เดิม)
                          const swalContainer = document.querySelector('.swal2-container');
                          if (swalContainer) {
                            swalContainer.style.zIndex = '99998';
                            swalContainer.style.position = 'fixed';
                            swalContainer.style.top = '0';
                            swalContainer.style.left = '0';
                            swalContainer.style.width = '100vw';
                            swalContainer.style.height = '100vh';
                            swalContainer.style.display = 'flex';
                            swalContainer.style.justifyContent = 'center';
                            swalContainer.style.alignItems = 'center';
                          }
                          const swalBackdrop = document.querySelector('.swal2-backdrop');
                          if (swalBackdrop) {
                            swalBackdrop.style.zIndex = '99997';
                            swalBackdrop.style.position = 'fixed';
                            swalBackdrop.style.top = '0';
                            swalBackdrop.style.left = '0';
                            swalBackdrop.style.width = '100vw';
                            swalBackdrop.style.height = '100vh';
                            swalBackdrop.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                            swalBackdrop.style.backdropFilter = 'blur(8px)';
                          }
                          const swalPopup = document.querySelector('.swal2-popup');
                          if (swalPopup) {
                            swalPopup.style.zIndex = '99999';
                            swalPopup.style.position = 'relative';
                            swalPopup.style.margin = '0';
                            swalPopup.style.transform = 'none';
                            swalPopup.style.maxHeight = '90vh';
                            swalPopup.style.overflowY = 'auto';
                            swalPopup.style.width = 'auto';
                            swalPopup.style.maxWidth = '90vw';
                            if (window.innerWidth <= 768) {
                              swalPopup.style.width = '95vw';
                              swalPopup.style.padding = '15px';
                            }
                          }
                        }
                      });
                      setTimeout(() => {
                        Swal.close();
                        showTab('today');
                        // Fix for mobile scroll lock after tab switch
                        setTimeout(() => {
                          document.body.style.overflow = 'auto';
                          const searchInputToday = document.getElementById('searchInputToday');
                          if (searchInputToday) {
                            searchInputToday.focus();
                            searchInputToday.blur(); // Trigger a touch event to unlock scroll on mobile
                          }
                          // Simulate a touch event to unlock scroll
                          if ('ontouchstart' in window) {
                            const event = new Event('touchstart', { bubbles: true });
                            document.body.dispatchEvent(event);
                          }
                        }, 100);
                      }, 2000);
                    }
                  });
                } else {
                  throw new Error(gasResult.data || 'GAS return error');
                }
              } catch (error) {
                console.error('เกิดข้อผิดพลาดในการส่งข้อมูลไป GAS:', error);
                Swal.fire({
                  icon: 'error',
                  title: 'เกิดข้อผิดพลาด',
                  text: `ไม่สามารถบันทึกข้อมูลได้: ${error.message}. กรุณาลองใหม่หรือติดต่อ admin.`,
                  confirmButtonText: 'ตกลง'
                });
              }
            }
          }
        });
      }
      function saveToLocalStorage(key, value) {
        let items = JSON.parse(localStorage.getItem(key)) || [];
        if (!items.includes(value)) {
          items.unshift(value);
          if (items.length > 5) items.pop();
          localStorage.setItem(key, JSON.stringify(items));
        }
      }
      function getFromLocalStorage(key) {
        return JSON.parse(localStorage.getItem(key)) || [];
      }
      function renderPagination(totalItems) {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        pageNumbers.innerHTML = "";
        if (totalPages === 0) {
          firstPageButton.disabled = true;
          prevPageButton.disabled = true;
          nextPageButton.disabled = true;
          lastPageButton.disabled = true;
          return;
        }
        // แสดงเฉพาะหน้าปัจจุบัน
        const button = document.createElement("button");
        button.textContent = currentPage;
        button.className = "active";
        button.disabled = true; // ไม่ให้คลิกได้เพราะเป็นหน้าปัจจุบัน
        pageNumbers.appendChild(button);
        firstPageButton.disabled = currentPage === 1;
        prevPageButton.disabled = currentPage === 1;
        nextPageButton.disabled = currentPage === totalPages;
        lastPageButton.disabled = currentPage === totalPages;
      }
      function changePage(page) {
        currentPage = page;
        renderTableData();
        renderPagination(currentFilteredData.length);
      }
      function renderTableData() {
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        renderTable(currentFilteredData.slice(startIndex, endIndex));
      }
      function applyFilters() {
        const keyword1 = searchInput1.value.trim().toLowerCase();
        let filtered1 = allData;
        if (keyword1) {
          // ค้นหาในทุกคอลัมน์สำหรับ Filter 1
          filtered1 = allData.filter((row) => {
            const searchFields = ["Material", "Description", "Product", "OCRTAXT", "หมายเหตุ", "Rebuilt", "วิภาวดี", "Unrestricted"];
            return searchFields.some(field => (row[field] || "").toLowerCase().includes(keyword1));
          });
        }
        tempFilteredData = filtered1;
        const keyword2 = searchInput2.value.trim().toLowerCase();
        let filtered2 = tempFilteredData;
        if (keyword2) {
          // ค้นหาในทุกคอลัมน์สำหรับ Filter 2 (จาก tempFilteredData)
          filtered2 = tempFilteredData.filter((row) => {
            const searchFields = ["Material", "Description", "Product", "OCRTAXT", "หมายเหตุ", "Rebuilt", "วิภาวดี", "Unrestricted"];
            return searchFields.some(field => (row[field] || "").toLowerCase().includes(keyword2));
          });
        }
        currentFilteredData = filtered2;
        currentPage = 1;
        renderTableData();
        renderPagination(currentFilteredData.length);
      }
      searchInput1.addEventListener("input", (e) => {
        globalSearch1 = e.target.value;
        document.getElementById("searchInputImages1").value = globalSearch1;
        applyFilters();
      });
      searchInput2.addEventListener("input", (e) => {
        globalSearch2 = e.target.value;
        document.getElementById("searchInput2").value = globalSearch2;
        applyFilters();
      });
               // ปุ่มแว่นตาใกล้ searchInput2 -> เคลียร์เฉพาะช่องของแท็บอะไหล่
      searchButton.addEventListener("click", () => {
        // เคลียร์ช่องค้นหาแท็บอะไหล่
        searchInput1.value = "";
        searchInput2.value = "";

        // เคลียร์ตัวแปร global ของฝั่งอะไหล่
        globalSearch1 = "";
        globalSearch2 = "";

        // คำนวณใหม่ (จะแสดงข้อมูลทั้งหมดเพราะช่องว่าง)
        triggerFadeAndFilter(tableContainerParts, applyFilters);
      });


      searchInput1.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          applyFilters();
          searchInput1.blur();
        }
      });
      searchInput2.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          applyFilters();
          searchInput2.blur();
        }
      });
      firstPageButton.addEventListener("click", () => {
        currentPage = 1;
        renderTableData();
        renderPagination(currentFilteredData.length);
      });
      prevPageButton.addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage--;
          renderTableData();
          renderPagination(currentFilteredData.length);
        }
      });
      nextPageButton.addEventListener("click", () => {
        const totalPages = Math.ceil(currentFilteredData.length / itemsPerPage);
        if (currentPage < totalPages) {
          currentPage++;
          renderTableData();
          renderPagination(currentFilteredData.length);
        }
      });
      lastPageButton.addEventListener("click", () => {
        const totalPages = Math.ceil(currentFilteredData.length / itemsPerPage);
        currentPage = totalPages;
        renderTableData();
        renderPagination(currentFilteredData.length);
      });
      async function loadData() {
        document.getElementById("loading").style.display = "flex";
        errorContainer.style.display = "none";
        console.log("Starting data load from:", url);
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 30000); // เพิ่ม timeout เป็น 30 วินาที
          const response = await fetch(url, {
            signal: controller.signal,
            mode: 'cors', // เพิ่ม mode: 'cors' เพื่อแก้ปัญหา CORS
            cache: 'no-cache' // เพิ่ม cache: 'no-cache' เพื่อให้ข้อมูลสดใหม่
          });
          clearTimeout(timeoutId);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          console.log("Data loaded successfully:", data);
          if (!Array.isArray(data) || data.length === 0) {
            throw new Error("No data received or data is empty");
          }
          allData = data;
          tempFilteredData = [...data];
          currentFilteredData = [...data];
          applyFilters();
          document.getElementById("loading").style.display = "none";
        } catch (error) {
          console.error("Error loading data:", error);
          document.getElementById("loading").style.display = "none";
          errorContainer.style.display = "block";
          if (error.name === 'AbortError') {
            document.getElementById("error-message").textContent = "การโหลดข้อมูลใช้เวลานานเกินไป กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ตหรือลองใหม่";
          } else if (error.message.includes('HTTP error! status: 403') || error.message.includes('CORS')) {
            document.getElementById("error-message").textContent = "ไม่สามารถเข้าถึงข้อมูลได้ กรุณาตรวจสอบการแชร์ Google Sheets ให้เป็น Public (Anyone with the link can view)";
          } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
            document.getElementById("error-message").textContent = "เกิดปัญหาการเชื่อมต่อเครือข่าย กรุณาตรวจสอบอินเทอร์เน็ตและลองใหม่";
          } else {
            document.getElementById("error-message").textContent = `ไม่สามารถโหลดข้อมูลได้: ${error.message}. กรุณาตรวจสอบ Sheet ID หรือชื่อ Sheet`;
          }
          Swal.fire({
            icon: "error",
            title: "ไม่สามารถโหลดข้อมูล",
            text: error.name === 'AbortError'
              ? "การเชื่อมต่อช้าเกินไป กรุณาตรวจสอบเครือข่ายหรือลองใหม่"
              : error.message.includes('HTTP error! status: 403') || error.message.includes('CORS')
              ? "Google Sheets ต้องแชร์เป็น Public (ดูได้โดยไม่ต้องล็อกอิน) กรุณาตรวจสอบการแชร์"
              : "ไม่สามารถโหลดข้อมูลจาก Google Sheets ได้ กรุณาตรวจสอบ Sheet ID, ชื่อ Sheet หรือการแชร์สาธารณะ",
            confirmButtonText: "ตกลง",
          });
        }
      }
      // Images tab functions (now after variables)
      itemsPerPageSelectImages.addEventListener("change", () => {
        itemsPerPageImages = parseInt(itemsPerPageSelectImages.value, 10);
        currentPageImages = 1;
        renderTableDataImages();
        renderPaginationImages(allDataImages.length);
      });
      retryButtonImages.addEventListener("click", () => {
        errorContainerImages.style.display = "none";
        loadImagesData();
      });
      function showImageModalImages(row) {
        const fields = [
          { key: 'Material', label: 'Material' },
          { key: 'Description', label: 'Description' },
          { key: 'วิภาวดี', label: 'วิภาวดี' },
          { key: 'Unrestricted', label: 'นวนคร' },
          { key: 'Rebuilt', label: 'Rebuilt' },
          { key: 'หมายเหตุ', label: 'หมายเหตุ' },
          { key: 'Product', label: 'Product' },
          { key: 'OCRTAXT', label: 'Spec' }
        ];
        let html = '';
        fields.forEach(field => {
          let value = row[field.key] || '';
          if (field.key === 'วิภาวดี' || field.key === 'Unrestricted') {
            if (value && !isNaN(value)) {
              value = Number(value).toLocaleString('en-US', { maximumFractionDigits: 0 });
            } else if (value === '0' || value === 0) {
              value = '';
            }
          }
          if ((field.key === 'หมายเหตุ' || field.key === 'Rebuilt') && value) {
            value = `<span style="color: red; font-weight: bold;">${value}</span>`;
          }
          if (field.key === 'Material') {
            // Special handling for Material row: add flex layout and requisition button
            html += `
              <div class="material-row">
                <span class="label">${field.label}:</span>
                <div style="display: flex; align-items: center; flex-grow: 1;">
                  <span class="value">${value}</span>
                  <button class="requisition-button-images" onclick="showRequisitionDialog(${JSON.stringify(row).replace(/"/g, '&quot;')})">เบิก</button>
                </div>
              </div>
            `;
          } else {
            html += `<div><span class="label">${field.label}:</span> <span class="value">${value}</span></div>`;
          }
        });
        // Add iframe for Google Drive image using 'id' column
        if (row.id) {
          html += `
            <div style="margin-top: 20px;">
              <strong>รูปภาพอะไหล่:</strong>
              <iframe class="drive-iframe-images" src="https://drive.google.com/file/d/${row.id}/preview" allowfullscreen></iframe>
            </div>
          `;
        } else {
          html += '<div><span class="label">รูปภาพ:</span> <span class="value">ไม่พบข้อมูลรูปภาพ</span></div>';
        }
        imageModalContentImages.innerHTML = html;
        imageModalImages.style.display = 'block';
      }
      // Updated render function for gallery
      function renderGalleryDataImages(data) {
        if (!galleryContainer) {
          console.error("Gallery container not found");
          Swal.fire({
            icon: "error",
            title: "ข้อผิดพลาด",
            text: "ไม่พบ container สำหรับแสดง gallery กรุณาตรวจสอบโครงสร้างหน้าเว็บ",
            confirmButtonText: "ตกลง",
          });
          return;
        }
        galleryContainer.innerHTML = "";
        data.forEach((row) => {
          const galleryItem = document.createElement("div");
          galleryItem.className = "gallery-item";
          // Convert values to numbers for comparison
          const vibhavadiValue = parseFloat(row["วิภาวดี"]) || 0;
          const unrestrictedValue = parseFloat(row["Unrestricted"]) || 0;
          // Determine styling based on conditions
          let textColor = "";
          let fontWeight = "";
          if (vibhavadiValue > 0) {
            textColor = "#4caf50"; // Green
            fontWeight = "bold";
          } else if (vibhavadiValue === 0 && unrestrictedValue > 0) {
            textColor = "#2196f3"; // Blue
            fontWeight = "bold";
          }
          const thumbnailSrc = row.id ? `https://drive.google.com/thumbnail?id=${row.id}&sz=w300-h300` : '';
          galleryItem.innerHTML = `
            <img src="${thumbnailSrc}" alt="${row.Description || 'Image'}" class="gallery-thumbnail"
              style="color: ${textColor}; font-weight: ${fontWeight};"
              onclick="showImageModalImages(${JSON.stringify(row).replace(/"/g, '&quot;')})"
              onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg=='; this.onclick=null;">
            <div class="gallery-info">
              <div class="gallery-material" style="color: ${textColor}; font-weight: ${fontWeight};">${row.Material || ''}</div>
              <div class="gallery-description">${row.Description || ''}</div>
            </div>
            <div class="gallery-actions">
              <button class="requisition-button-images" onclick="showRequisitionDialog(${JSON.stringify(row).replace(/"/g, '&quot;')})">
                เบิก
              </button>
            </div>
          `;
          galleryContainer.appendChild(galleryItem);
        });
      }
      function renderPaginationImages(totalItems) {
        const totalPages = Math.ceil(totalItems / itemsPerPageImages);
        pageNumbersImages.innerHTML = "";
        if (totalPages === 0) {
          firstPageButtonImages.disabled = true;
          prevPageButtonImages.disabled = true;
          nextPageButtonImages.disabled = true;
          lastPageButtonImages.disabled = true;
          return;
        }
        // แสดงเฉพาะหน้าปัจจุบัน
        const button = document.createElement("button");
        button.textContent = currentPageImages;
        button.className = "active";
        button.disabled = true; // ไม่ให้คลิกได้เพราะเป็นหน้าปัจจุบัน
        pageNumbersImages.appendChild(button);
        firstPageButtonImages.disabled = currentPageImages === 1;
        prevPageButtonImages.disabled = currentPageImages === 1;
        nextPageButtonImages.disabled = currentPageImages === totalPages;
        lastPageButtonImages.disabled = currentPageImages === totalPages;
      }
      function changePageImages(page) {
        currentPageImages = page;
        renderTableDataImages();
        renderPaginationImages(currentFilteredDataImages.length);
      }
      function renderTableDataImages() {
        const startIndex = (currentPageImages - 1) * itemsPerPageImages;
        const endIndex = startIndex + itemsPerPageImages;
        renderGalleryDataImages(currentFilteredDataImages.slice(startIndex, endIndex));
      }
      function applyFiltersImages() {
        const keyword1 = searchInputImages1.value.trim().toLowerCase();
        let filtered1 = allDataImages;
        if (keyword1) {
          // ค้นหาในทุกคอลัมน์สำหรับ Filter 1
          filtered1 = allDataImages.filter((row) => {
            const searchFields = ["Material", "Description", "Product", "OCRTAXT", "หมายเหตุ", "Rebuilt", "วิภาวดี", "Unrestricted"];
            return searchFields.some(field => (row[field] || "").toLowerCase().includes(keyword1));
          });
        }
        tempFilteredDataImages = filtered1;
        const keyword2 = searchInputImages2.value.trim().toLowerCase();
        let filtered2 = tempFilteredDataImages;
        if (keyword2) {
          // ค้นหาในทุกคอลัมน์สำหรับ Filter 2 (จาก tempFilteredDataImages)
          filtered2 = tempFilteredDataImages.filter((row) => {
            const searchFields = ["Material", "Description", "Product", "OCRTAXT", "หมายเหตุ", "Rebuilt", "วิภาวดี", "Unrestricted"];
            return searchFields.some(field => (row[field] || "").toLowerCase().includes(keyword2));
          });
        }
        currentFilteredDataImages = filtered2;
        currentPageImages = 1;
        renderTableDataImages();
        renderPaginationImages(currentFilteredDataImages.length);
      }
      searchInputImages1.addEventListener("input", (e) => {
        globalSearch1 = e.target.value;
        document.getElementById("searchInput1").value = globalSearch1;
        applyFiltersImages();
      });
      searchInputImages2.addEventListener("input", (e) => {
        globalSearch2 = e.target.value;
        document.getElementById("searchInput2").value = globalSearch2;
        applyFiltersImages();
      });
     // ปุ่มแว่นตาใกล้ searchInputImages2 -> เคลียร์ทั้งคู่ + เคลียร์ฝั่งอะไหล่ด้วย ให้ค้นใหม่แบบว่าง
searchButtonImages.addEventListener("click", () => {
  // เคลียร์ช่องค้นหาแท็บรูปภาพ
  searchInputImages1.value = "";
  searchInputImages2.value = "";

  // เคลียร์ค่าที่ sync ไปแท็บอะไหล่ด้วย (ให้สองแท็บตรงกัน)
  searchInput1.value = "";
  searchInput2.value = "";

  // เคลียร์ตัวแปร global
  globalSearch1 = "";
  globalSearch2 = "";

  // เรียก filter อีกรอบ (จะกลายเป็นแสดงข้อมูลทั้งหมด เพราะช่องค้นหาว่าง)
  triggerFadeAndFilter(galleryContainer, applyFiltersImages);
});

      searchInputImages1.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          applyFiltersImages();
          searchInputImages1.blur();
        }
      });
      searchInputImages2.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          applyFiltersImages();
          searchInputImages2.blur();
        }
      });
      firstPageButtonImages.addEventListener("click", () => {
        currentPageImages = 1;
        renderTableDataImages();
        renderPaginationImages(currentFilteredDataImages.length);
      });
      prevPageButtonImages.addEventListener("click", () => {
        if (currentPageImages > 1) {
          currentPageImages--;
          renderTableDataImages();
          renderPaginationImages(currentFilteredDataImages.length);
        }
      });
      nextPageButtonImages.addEventListener("click", () => {
        const totalPages = Math.ceil(currentFilteredDataImages.length / itemsPerPageImages);
        if (currentPageImages < totalPages) {
          currentPageImages++;
          renderTableDataImages();
          renderPaginationImages(currentFilteredDataImages.length);
        }
      });
      lastPageButtonImages.addEventListener("click", () => {
        const totalPages = Math.ceil(currentFilteredDataImages.length / itemsPerPageImages);
        currentPageImages = totalPages;
        renderTableDataImages();
        renderPaginationImages(currentFilteredDataImages.length);
      });
      async function loadImagesData() {
        document.getElementById("loading").style.display = "flex";
        errorContainerImages.style.display = "none";
        console.log("Starting data load for images from:", url);
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 30000); // เพิ่ม timeout เป็น 30 วินาที
          const response = await fetch(url, {
            signal: controller.signal,
            mode: 'cors', // เพิ่ม mode: 'cors' เพื่อแก้ปัญหา CORS
            cache: 'no-cache' // เพิ่ม cache: 'no-cache' เพื่อให้ข้อมูลสดใหม่
          });
          clearTimeout(timeoutId);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          console.log("Images data loaded successfully:", data);
          if (!Array.isArray(data) || data.length === 0) {
            throw new Error("No data received or data is empty");
          }
          allDataImages = data.filter(row => row.id); // Filter only rows with 'id' data
          tempFilteredDataImages = [...allDataImages];
          currentFilteredDataImages = [...allDataImages];
          applyFiltersImages();
          document.getElementById("loading").style.display = "none";
        } catch (error) {
          console.error("Error loading images data:", error);
          document.getElementById("loading").style.display = "none";
          errorContainerImages.style.display = "block";
          if (error.name === 'AbortError') {
            document.getElementById("error-message-images").textContent = "การโหลดข้อมูลใช้เวลานานเกินไป กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ตหรือลองใหม่";
          } else if (error.message.includes('HTTP error! status: 403') || error.message.includes('CORS')) {
            document.getElementById("error-message-images").textContent = "ไม่สามารถเข้าถึงข้อมูลได้ กรุณาตรวจสอบการแชร์ Google Sheets ให้เป็น Public (Anyone with the link can view)";
          } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
            document.getElementById("error-message-images").textContent = "เกิดปัญหาการเชื่อมต่อเครือข่าย กรุณาตรวจสอบอินเทอร์เน็ตและลองใหม่";
          } else {
            document.getElementById("error-message-images").textContent = `ไม่สามารถโหลดข้อมูลได้: ${error.message}. กรุณาตรวจสอบ Sheet ID หรือชื่อ Sheet`;
          }
          Swal.fire({
            icon: "error",
            title: "ไม่สามารถโหลดข้อมูล",
            text: error.name === 'AbortError'
              ? "การเชื่อมต่อช้าเกินไป กรุณาตรวจสอบเครือข่ายหรือลองใหม่"
              : error.message.includes('HTTP error! status: 403') || error.message.includes('CORS')
              ? "Google Sheets ต้องแชร์เป็น Public (ดูได้โดยไม่ต้องล็อกอิน) กรุณาตรวจสอบการแชร์"
              : "ไม่สามารถโหลดข้อมูลจาก Google Sheets ได้ กรุณาตรวจสอบ Sheet ID, ชื่อ Sheet หรือการแชร์สาธารณะ",
            confirmButtonText: "ตกลง",
          });
        }
      }
      // Today tab functions (now after variables)
      retryButtonToday.addEventListener("click", () => {
        errorContainerToday.style.display = "none";
        loadTodayData();
      });
      closeModal.onclick = () => {
        modal.style.opacity = "0";
        modal.style.transform = "scale(0.95)";
        setTimeout(() => (modal.style.display = "none"), 300);
      };
      window.onclick = (event) => {
        if (event.target == modal) closeModal.click();
      };
      // Toggle pending only button event
      toggleAllDataBtn.addEventListener('click', () => {
        pendingOnly = !pendingOnly;
        if (pendingOnly) {
          toggleAllDataBtn.innerHTML = '<i class="fas fa-list-ul"></i>';
          toggleAllDataBtn.title = 'ประวัติเบิก';
        } else {
          toggleAllDataBtn.innerHTML = '<i class="fas fa-clock"></i>';
          toggleAllDataBtn.title = 'รอเบิก';
        }
        currentPageToday = 1; // Reset page on toggle
        updateTableToday();
      });
      // Items per page change event for today tab
      itemsPerPageSelectToday.addEventListener("change", () => {
        itemsPerPageToday = parseInt(itemsPerPageSelectToday.value, 10);
        currentPageToday = 1;
        updateTableToday();
      });
      // Pagination button events for today tab
      firstPageButtonToday.addEventListener("click", () => {
        currentPageToday = 1;
        updateTableToday();
      });
      prevPageButtonToday.addEventListener("click", () => {
        if (currentPageToday > 1) {
          currentPageToday--;
          updateTableToday();
        }
      });
      nextPageButtonToday.addEventListener("click", () => {
        const totalPages = Math.ceil(currentFilteredDataToday.length / itemsPerPageToday);
        if (currentPageToday < totalPages) {
          currentPageToday++;
          updateTableToday();
        }
      });
      lastPageButtonToday.addEventListener("click", () => {
        const totalPages = Math.ceil(currentFilteredDataToday.length / itemsPerPageToday);
        currentPageToday = totalPages;
        updateTableToday();
      });
      // Function to sort data by column (for sortable headers)
      function sortByColumn(a, b, column, direction) {
        let valueA = a[column] || "";
        let valueB = b[column] || "";
        if (column === 'IDRow' || column === 'Timestamp') {
          // Custom sort for IDRow (descending by default) and Timestamp
          const parseDateOrId = (value) => {
            if (!value) return 0;
            if (column === 'IDRow') {
              return parseInt(value, 10) || 0;
            }
            // For Timestamp
            const [datePart, timePart] = value.split(' ');
            const [day, month, yearBE] = datePart.split('/');
            const yearCE = parseInt(yearBE) - 543;
            if (!timePart) return new Date(yearCE, parseInt(month) - 1, parseInt(day)).getTime();
            const [hour, minute, second] = timePart.split(':').map(Number);
            return new Date(yearCE, parseInt(month) - 1, parseInt(day), hour || 0, minute || 0, second || 0).getTime();
          };
          const numA = parseDateOrId(valueA);
          const numB = parseDateOrId(valueB);
          return direction === 'asc' ? numA - numB : numB - numA;
        } else {
          // Default string/numeric sort
          if (!isNaN(valueA) && !isNaN(valueB)) {
            valueA = parseFloat(valueA);
            valueB = parseFloat(valueB);
            return direction === 'asc' ? valueA - valueB : valueB - valueA;
          }
          valueA = valueA.toString().toLowerCase();
          valueB = valueB.toString().toLowerCase();
          return direction === 'asc' ? valueA.localeCompare(valueB) : valueB.localeCompare(valueA);
        }
      }
      // Add sort listeners for today tab
      function addSortListenersToday() {
        const sortableHeaders = document.querySelectorAll("#today th.sortable");
        sortableHeaders.forEach(header => {
          header.addEventListener("click", () => {
            const column = header.getAttribute("data-column");
            if (sortConfigToday.column === column) {
              sortConfigToday.direction = sortConfigToday.direction === 'asc' ? 'desc' : 'asc';
            } else {
              sortConfigToday.column = column;
              sortConfigToday.direction = column === 'IDRow' ? 'desc' : 'asc'; // Default descending for IDRow
            }
            updateSortArrowsToday();
            updateTableToday();
          });
        });
      }
      function updateSortArrowsToday() {
        const sortableHeaders = document.querySelectorAll("#today th.sortable");
        sortableHeaders.forEach(header => {
          const arrow = header.querySelector(".today-arrow");
          const column = header.getAttribute("data-column");
          if (column === sortConfigToday.column) {
            arrow.textContent = sortConfigToday.direction === 'asc' ? '↑' : '↓';
          } else {
            arrow.textContent = '';
          }
        });
      }
      // Initial call to add listeners after load
      document.addEventListener('DOMContentLoaded', () => {
        addSortListenersToday();
      });
                // ฟังก์ชัน fade-out ก่อน refresh
      function triggerFadeAndFilter(container, filterFn) {
        if (!container) {
          filterFn();
          return;
        }
        container.classList.add("fade-out");
        setTimeout(() => {
          filterFn();
          container.classList.remove("fade-out");
        }, 200);
      }

      function filterByStatus(data) {
        let filtered = data;
        if (pendingOnly) {
          filtered = data.filter(row => row["status"] === "รอเบิก");
        }
        // Apply sort based on config
        if (sortConfigToday.column) {
          filtered.sort((a, b) => sortByColumn(a, b, sortConfigToday.column, sortConfigToday.direction));
        }
        return filtered;
      }
      function updateTableToday() {
        let dataToFilter = allDataToday;
        const keyword = searchInputToday.value.toLowerCase();
        if (keyword) {
          dataToFilter = allDataToday.filter((row) => {
            return (
              (row["IDRow"] || "").toLowerCase().includes(keyword) ||
              (row["material"] || "").toLowerCase().includes(keyword) ||
              (row["description"] || "").toLowerCase().includes(keyword) ||
              (row["employeeName"] || "").toLowerCase().includes(keyword) ||
              (row["team"] || "").toLowerCase().includes(keyword)
            );
          });
        }
        const filteredData = filterByStatus(dataToFilter);
        currentFilteredDataToday = filteredData;
        // Paginate
        const startIndex = (currentPageToday - 1) * itemsPerPageToday;
        const endIndex = startIndex + itemsPerPageToday;
        const paginatedData = filteredData.slice(startIndex, endIndex);
        renderTableToday(paginatedData);
        renderPaginationToday(filteredData.length);
      }
      function renderTableToday(data) {
        tableBodyToday.innerHTML = "";
        data.forEach((row) => {
          const tr = document.createElement("tr");
          const statusTd = document.createElement("td");
          const status = row["status"] || "";
          statusTd.textContent = status;
          statusTd.className = status === "สั่งเบิกแล้ว" ? "status-green" : "status-red";
          tr.appendChild(statusTd);
          // Add IDRow column
          const idRowTd = document.createElement("td");
          idRowTd.textContent = row["IDRow"] || "";
          tr.appendChild(idRowTd);
          const columns = [
            "Timestamp",
            "material",
            "description",
            "quantity",
            "vibhavadi",
            "employeeName",
            "team",
            "CallNumber",
            "CallType",
            "remark",
          ];
          columns.forEach((col) => {
            const td = document.createElement("td");
            let value = row[col] || "";
            if (col === "quantity" || col === "vibhavadi") {
              if (value && !isNaN(value)) {
                value = Number(value).toLocaleString("en-US", { maximumFractionDigits: 0 });
              } else if (value === "0" || value === 0) {
                value = "";
              }
            }
            if (col === "remark" && value) {
              td.style.color = "red";
              td.style.fontWeight = "bold";
            }
            if (col === "material" && (row["remark"] || "").trim() !== "") {
              td.style.color = "red";
              td.style.fontWeight = "bold";
            }
            if (col === "description" && (row["remark"] || "").trim() !== "") {
              td.style.color = "red";
              td.style.fontWeight = "bold";
            }
            if (col === "Timestamp" && (row["remark"] || "").trim() !== "") {
              td.style.color = "red";
              td.style.fontWeight = "bold";
            }
            if (col === "vibhavadi" && value) {
              td.style.color = "#4caf50"; // Green color
              td.style.fontWeight = "bold";
            }
            td.textContent = value;
            tr.appendChild(td);
          });
          const detailTd = document.createElement("td");
          const btn = document.createElement("button");
          btn.textContent = "ดูรายละเอียด";
          btn.className = "detail-button";
          btn.onclick = () => {
            modalContent.innerHTML = ["IDRow", ...columns]
              .map((col) => {
                let label = "";
                switch (col) {
                  case "IDRow": label = "🆔 ลำดับ"; break;
                  case "Timestamp": label = "📅 วันเวลา"; break;
                  case "material": label = "🔢 Material"; break;
                  case "description": label = "🛠️ Description"; break;
                  case "quantity": label = "🔢 จำนวน"; break;
                  case "employeeName": label = "👷‍♂️ ชื่อช่าง"; break;
                  case "team": label = "🏢 หน่วยงาน"; break;
                  case "CallNumber": label = "📄 Call"; break;
                  case "CallType": label = "🗳️ CallType"; break;
                  case "vibhavadi": label = "📦 คลังวิภาวดี"; break;
                  case "remark": label = "📝 หมายเหตุ"; break;
                  default: label = col;
                }
                const value = row[col] || "";
                const valueHtml = col === "remark" && value
                  ? `<span class='value' style='color:red'>${value}</span>`
                  : `<span class='value'>${value}</span>`;
                return `<div><span class='label'>${label}:</span> ${valueHtml}</div>`;
              })
              .join("");
            modal.style.display = "block";
            setTimeout(() => {
              modal.style.opacity = "1";
              modal.style.transform = "scale(1)";
            }, 10);
          };
          detailTd.appendChild(btn);
          tr.appendChild(detailTd);
          tableBodyToday.appendChild(tr);
        });
      }
      function renderPaginationToday(totalItems) {
        const totalPages = Math.ceil(totalItems / itemsPerPageToday);
        pageNumbersToday.innerHTML = "";
        if (totalPages === 0) {
          firstPageButtonToday.disabled = true;
          prevPageButtonToday.disabled = true;
          nextPageButtonToday.disabled = true;
          lastPageButtonToday.disabled = true;
          return;
        }
        // แสดงเฉพาะหน้าปัจจุบัน
        const button = document.createElement("button");
        button.textContent = currentPageToday;
        button.className = "active";
        button.disabled = true; // ไม่ให้คลิกได้เพราะเป็นหน้าปัจจุบัน
        pageNumbersToday.appendChild(button);
        firstPageButtonToday.disabled = currentPageToday === 1;
        prevPageButtonToday.disabled = currentPageToday === 1;
        nextPageButtonToday.disabled = currentPageToday === totalPages;
        lastPageButtonToday.disabled = currentPageToday === totalPages;
      }
      searchInputToday.addEventListener("input", () => {
        currentPageToday = 1; // Reset page on search
        updateTableToday();
      });
      async function loadTodayData() {
        document.getElementById("loading").style.display = "flex";
        document.getElementById("loadingToday").style.display = "block";
        errorContainerToday.style.display = "none";
        console.log("Starting data load from Opensheet:", requestSheetUrl);
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 30000); // เพิ่ม timeout เป็น 30 วินาที
          const response = await fetch(requestSheetUrl, {
            signal: controller.signal,
            mode: 'cors', // เพิ่ม mode: 'cors' เพื่อแก้ปัญหา CORS
            cache: 'no-cache' // เพิ่ม cache: 'no-cache' เพื่อให้ข้อมูลสดใหม่
          });
          clearTimeout(timeoutId);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          console.log("Today data loaded successfully:", data);
          if (!Array.isArray(data) || data.length === 0) {
            throw new Error("No data received or data is empty");
          }
          allDataToday = data;
          currentPageToday = 1; // Reset page on load
          updateTableToday();
          document.getElementById("loading").style.display = "none";
          document.getElementById("loadingToday").style.display = "none";
          document.getElementById("data-table-today").style.display = "table";
          // Fix for mobile scroll after loading
          setTimeout(() => {
            document.body.style.overflow = 'auto';
            if ('ontouchstart' in window) {
              const event = new Event('touchstart', { bubbles: true });
              document.body.dispatchEvent(event);
            }
          }, 100);
        } catch (error) {
          console.error("Error loading today data:", error);
          document.getElementById("loading").style.display = "none";
          document.getElementById("loadingToday").style.display = "none";
          errorContainerToday.style.display = "block";
          if (error.name === 'AbortError') {
            document.getElementById("error-message-today").textContent = "การโหลดข้อมูลใช้เวลานานเกินไป กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ตหรือลองใหม่";
          } else if (error.message.includes('HTTP error! status: 403') || error.message.includes('CORS')) {
            document.getElementById("error-message-today").textContent = "ไม่สามารถเข้าถึงข้อมูลได้ กรุณาตรวจสอบการแชร์ Google Sheets ให้เป็น Public (Anyone with the link can view)";
          } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
            document.getElementById("error-message-today").textContent = "เกิดปัญหาการเชื่อมต่อเครือข่าย กรุณาตรวจสอบอินเทอร์เน็ตและลองใหม่";
          } else {
            document.getElementById("error-message-today").textContent = `ไม่สามารถโหลดข้อมูลได้: ${error.message}. กรุณาตรวจสอบ Sheet ID หรือชื่อ Sheet`;
          }
          Swal.fire({
            icon: "error",
            title: "ไม่สามารถโหลดข้อมูล",
            text: error.name === 'AbortError'
              ? "การเชื่อมต่อช้าเกินไป กรุณาตรวจสอบเครือข่ายหรือลองใหม่"
              : error.message.includes('HTTP error! status: 403') || error.message.includes('CORS')
              ? "Google Sheets ต้องแชร์เป็น Public (ดูได้โดยไม่ต้องล็อกอิน) กรุณาตรวจสอบการแชร์"
              : "ไม่สามารถโหลดข้อมูลจาก Google Sheets ได้ กรุณาตรวจสอบ Sheet ID, ชื่อ Sheet หรือการแชร์สาธารณะ",
            confirmButtonText: "ตกลง",
          });
        }
      }
      // All tab functions (now after variables)
      closeModalAll.onclick = () => modalAll.style.display = "none";
      window.onclick = event => {
        if (event.target == modalAll) modalAll.style.display = "none";
      };
      itemsPerPageSelectAll.addEventListener("change", (e) => {
        itemsPerPageAll = parseInt(e.target.value);
        currentPageAll = 1;
        renderTableAll(allDataAll);
      });
      function renderTableAll(data) {
        tableBodyAll.innerHTML = '';
        const startIdx = (currentPageAll - 1) * itemsPerPageAll;
        const endIdx = startIdx + itemsPerPageAll;
        const paginatedData = data.slice(startIdx, endIdx);
        paginatedData.forEach((row, i) => {
          const tr = document.createElement("tr");
          tr.style.animationDelay = `${i * 0.05}s`; // Fade-in ทีละแถว
            const status = row["status"] || "";
            const statusTd = document.createElement("td");
            statusTd.textContent = status;
            statusTd.className = status === "สั่งเบิกแล้ว" ? "status-green" : "status-red";
            tr.appendChild(statusTd);
            const columns = ["timestamp", "material", "description", "quantity", "employeeName", "team","callNumber","callType", "remark"];
            columns.forEach(col => {
              const td = document.createElement("td");
              td.textContent = row[col] || "";
              tr.appendChild(td);
            });
            const detailTd = document.createElement("td");
            const btn = document.createElement("button");
            btn.textContent = "ดูรายละเอียด";
            btn.className = "detail-button";
            btn.onclick = () => {
              modalContentAll.innerHTML = columns.map(col => {
                const label = col === "timestamp" ? "วันเวลา" : col;
                return `<div><span class='label'>${label}:</span> <span class='value'>${row[col] || ''}</span></div>`;
              }).join('');
              modalAll.style.display = "block";
            };
            detailTd.appendChild(btn);
            tr.appendChild(detailTd);
            tableBodyAll.appendChild(tr);
        });
        updatePaginationAll(data);
      }
      function updatePaginationAll(data) {
        const totalPages = Math.ceil(data.length / itemsPerPageAll);
        pageNumbersContainerAll.innerHTML = '';
        if (totalPages === 0) {
          firstPageButtonAll.disabled = true;
          prevPageButtonAll.disabled = true;
          nextPageButtonAll.disabled = true;
          lastPageButtonAll.disabled = true;
          return;
        }
        // แสดงเฉพาะหน้าปัจจุบัน
        const pageNumberButton = document.createElement("button");
        pageNumberButton.className = `all-page-number active`;
        pageNumberButton.textContent = currentPageAll;
        pageNumberButton.disabled = true; // ไม่ให้คลิกได้เพราะเป็นหน้าปัจจุบัน
        pageNumbersContainerAll.appendChild(pageNumberButton);
        firstPageButtonAll.disabled = currentPageAll === 1;
        prevPageButtonAll.disabled = currentPageAll === 1;
        nextPageButtonAll.disabled = currentPageAll === totalPages;
        lastPageButtonAll.disabled = currentPageAll === totalPages;
      }
      // ปุ่มเลื่อนไปหน้าแรก
      firstPageButtonAll.onclick = () => {
        currentPageAll = 1;
        renderTableAll(allDataAll);
      };
      // ปุ่มย้อนกลับ
      prevPageButtonAll.onclick = () => {
        if (currentPageAll > 1) {
          currentPageAll--;
          renderTableAll(allDataAll);
        }
      };
      // ปุ่มไปหน้า next
      nextPageButtonAll.onclick = () => {
        const totalPages = Math.ceil(allDataAll.length / itemsPerPageAll);
        if (currentPageAll < totalPages) {
          currentPageAll++;
          renderTableAll(allDataAll);
        }
      };
      // ปุ่มไปหน้าสุดท้าย
      lastPageButtonAll.onclick = () => {
        currentPageAll = Math.ceil(allDataAll.length / itemsPerPageAll);
        renderTableAll(allDataAll);
      };
      searchInputAll.addEventListener("input", e => {
        const keyword = e.target.value.toLowerCase();
        const filtered = allDataAll.filter(row => {
          return (
            (row["material"] || "").toLowerCase().includes(keyword) ||
            (row["description"] || "").toLowerCase().includes(keyword) ||
            (row["employeeName"] || "").toLowerCase().includes(keyword) ||
            (row["team"] || "").toLowerCase().includes(keyword) ||
            (row["remark"] || "").toLowerCase().includes(keyword)
          );
        });
        renderTableAll(filtered);
      });
      async function loadAllData() {
        try {
          const response = await fetch(`${gasUrl}?action=getRequests`);
          const res = await response.json();
          if (res.status === 'success') {
            allDataAll = res.data;
            renderTableAll(allDataAll);
          } else {
            throw new Error(res.data || 'GAS error');
          }
        } catch (error) {
          console.error("ไม่สามารถโหลดข้อมูลได้:", error);
          tableBodyAll.innerHTML = '<tr><td colspan="11">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>';
        }
      }
      // Pending-calls tab functions (now after variables)
      closeModalPending.onclick = () => modalPending.style.display = "none";
      window.onclick = event => {
        if (event.target == modalPending) modalPending.style.display = "none";
      };
      itemsPerPageSelectPending.addEventListener("change", (e) => {
        itemsPerPagePending = parseInt(e.target.value);
        currentPagePending = 1; // รีเซ็ตหน้าเมื่อเปลี่ยนจำนวนรายการต่อหน้า
        filterAndRenderTablePending();
      });
      searchInputPending.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          currentPagePending = 1; // รีเซ็ตหน้าเมื่อค้นหาใหม่
          filterAndRenderTablePending();
        }
      });
      searchButtonPending.addEventListener("click", () => {
        currentPagePending = 1; // รีเซ็ตหน้าเมื่อค้นหาใหม่
        filterAndRenderTablePending();
      });
      function populateTeamFilterPending(data) {
        const filteredData = data.filter(row => {
          const vipa = Number(row["Vipa"] || 0);
          const pendingDept = (row["ค้างหน่วยงาน"] || "").toLowerCase();
          return vipa > 0 &&
                 !pendingDept.includes("stock วิภาวดี 62") &&
                 !pendingDept.includes("nec_ยกเลิกผลิต");
        });
        const teams = [...new Set(filteredData.map(row => row["Team"]).filter(team => team && team.trim() !== ""))].sort();
        teamFilterPending.innerHTML = '<option value="">ทั้งหมด</option>';
        if (teams.length === 0) {
          const option = document.createElement("option");
          option.value = "";
          option.textContent = "ไม่มีทีมที่ตรงตามเงื่อนไข";
          option.disabled = true;
          teamFilterPending.appendChild(option);
        } else {
          teams.forEach(team => {
            const option = document.createElement("option");
            option.value = team;
            option.textContent = team;
            teamFilterPending.appendChild(option);
          });
        }
      }
      function addSortListenersPending() {
        const sortableHeaders = document.querySelectorAll("#pending-calls th.sortable");
        sortableHeaders.forEach(header => {
          header.addEventListener("click", () => {
            const column = header.getAttribute("data-column");
            if (sortConfigPending.column === column) {
              sortConfigPending.direction = sortConfigPending.direction === 'asc' ? 'desc' : 'asc';
            } else {
              sortConfigPending.column = column;
              sortConfigPending.direction = 'asc';
            }
            updateSortArrowsPending();
            filterAndRenderTablePending();
          });
        });
      }
      function updateSortArrowsPending() {
        const sortableHeaders = document.querySelectorAll("#pending-calls th.sortable");
        sortableHeaders.forEach(header => {
          const arrow = header.querySelector(".pending-arrow");
          const column = header.getAttribute("data-column");
          if (column === sortConfigPending.column) {
            arrow.textContent = sortConfigPending.direction === 'asc' ? '↑' : '↓';
          } else {
            arrow.textContent = '';
          }
        });
      }
      function filterAndRenderTablePending() {
        const selectedTeam = teamFilterPending.value;
        const keyword = searchInputPending.value.toLowerCase().trim();
        let filteredData = allDataPending.filter(row => {
          const pendingDept = (row["ค้างหน่วยงาน"] || "").toLowerCase();
          return Number(row["Vipa"] || 0) > 0 &&
                 !pendingDept.includes("stock วิภาวดี 62") &&
                 !pendingDept.includes("nec_ยกเลิกผลิต") &&
                 (!selectedTeam || row["Team"] === selectedTeam) &&
                 (!keyword ||
                  (row["DateTime"] || "").toLowerCase().includes(keyword) ||
                  (row["Ticket Number"] || "").toLowerCase().includes(keyword) ||
                  (row["Team"] || "").toLowerCase().includes(keyword) ||
                  (row["Brand"] || "").toLowerCase().includes(keyword) ||
                  (row["ค้างหน่วยงาน"] || "").toLowerCase().includes(keyword) ||
                  (row["Material"] || "").toLowerCase().includes(keyword) ||
                  (row["Description"] || "").toLowerCase().includes(keyword) ||
                  (row["Vipa"] || "").toLowerCase().includes(keyword) ||
                  (row["DayRepair"] || "").toLowerCase().includes(keyword)
                 );
        });
        if (sortConfigPending.column) {
          filteredData.sort((a, b) => {
            let valueA = a[sortConfigPending.column] || "";
            let valueB = b[sortConfigPending.column] || "";
            if (sortConfigPending.column === 'DayRepair' || sortConfigPending.column === 'Vipa') {
              valueA = Number(valueA) || 0;
              valueB = Number(valueB) || 0;
              return sortConfigPending.direction === 'asc' ? valueA - valueB : valueB - valueA;
            } else {
              valueA = valueA.toString().toLowerCase();
              valueB = valueB.toString().toLowerCase();
              return sortConfigPending.direction === 'asc' ? valueA.localeCompare(valueB) : valueB.localeCompare(valueA);
            }
          });
        }
        // ตรวจสอบว่า currentPage อยู่ในช่วงที่ถูกต้อง
        const totalPages = Math.ceil(filteredData.length / itemsPerPagePending);
        if (currentPagePending > totalPages) {
          currentPagePending = totalPages || 1;
        }
        renderTablePending(filteredData);
        updateCallCountPending(filteredData);
      }
      teamFilterPending.addEventListener("change", () => {
        currentPagePending = 1; // รีเซ็ตหน้าเมื่อเปลี่ยนทีม
        filterAndRenderTablePending();
      });
      function updateCallCountPending(data) {
        const uniqueTickets = [...new Set(data.map(row => row["Ticket Number"]))];
        const count = uniqueTickets.length;
        const callCountValue = document.getElementById("callCountValuePending");
        callCountValue.textContent = count;
      }
      function formatDateTimePending(dateTime) {
        if (!dateTime) return "";
        const datePart = dateTime.split(" ")[0];
        return datePart;
      }
      function renderTablePending(data) {
        tableBodyPending.innerHTML = '';
        const startIdx = (currentPagePending - 1) * itemsPerPagePending;
        const endIdx = startIdx + itemsPerPagePending;
        const paginatedData = data.slice(startIdx, endIdx);
        if (paginatedData.length === 0) {
          tableBodyPending.innerHTML = '<tr><td colspan="10" class="pending-text-center">ไม่พบข้อมูลที่ตรงกับเงื่อนไข</td></tr>';
          updatePaginationPending(data);
          return;
        }
        const ticketGroups = {};
        data.forEach(row => {
          const ticket = row["Ticket Number"];
          if (!ticketGroups[ticket]) {
            ticketGroups[ticket] = [];
          }
          ticketGroups[ticket].push(row);
        });
        const uniqueTickets = Object.keys(ticketGroups).sort();
        const colorMap = {};
        uniqueTickets.forEach((ticket, index) => {
          if (ticket === "24103102058") {
            colorMap[ticket] = "pending-yellow-light";
          } else if (ticket === "25011101274") {
            colorMap[ticket] = "pending-pink-pastel";
          } else {
            colorMap[ticket] = index % 2 === 0 ? "pending-yellow-light" : "pending-pink-pastel";
          }
        });
        paginatedData.forEach((row, i) => {
          const tr = document.createElement("tr");
          tr.style.animationDelay = `${i * 0.05}s`;
          const ticket = row["Ticket Number"];
          tr.className = colorMap[ticket];
          const columns = ["DateTime", "Ticket Number", "Team", "Brand", "ค้างหน่วยงาน", "Material", "Description", "Vipa", "DayRepair"];
          columns.forEach(col => {
            const td = document.createElement("td");
            let cellValue = row[col] || "";
            if (col === "DateTime") {
              cellValue = formatDateTimePending(cellValue);
            } else if (col === "DayRepair" || col === "Vipa") {
              const numValue = Number(cellValue);
              cellValue = isNaN(numValue) ? "" : numValue.toString();
            }
            td.textContent = cellValue;
            if (col === "Description") {
              td.classList.add("pending-text-left");
            } else if (col === "Vipa" || col === "DayRepair") {
              td.classList.add("pending-text-center");
            }
            if ((col === "Material" || col === "Description") && row["Description"] === "Code ผิด") {
              td.className = "pending-highlight-red";
            }
            tr.appendChild(td);
          });
          const detailTd = document.createElement("td");
          const btn = document.createElement("button");
          btn.textContent = "ดูรายละเอียด";
          btn.className = "pending-detail-button";
          btn.onclick = () => {
            modalContentPending.innerHTML = columns.map(col => {
              let value = row[col] || "";
              if (col === "DateTime") {
                value = formatDateTimePending(value);
              } else if (col === "DayRepair" || col === "Vipa") {
                const numValue = Number(value);
                value = isNaN(numValue) ? "" : numValue.toString();
              }
              let valueClass = (col === "Material" || col === "Description") && row["Description"] === "Code ผิด" ? "pending-highlight-red" : "value";
              return `<div><span class='label'>${col}:</span> <span class='${valueClass}'>${value}</span></div>`;
            }).join('');
            modalPending.style.display = "block";
          };
          detailTd.appendChild(btn);
          tr.appendChild(detailTd);
          tableBodyPending.appendChild(tr);
        });
        updatePaginationPending(data);
      }
      function updatePaginationPending(data) {
        const totalPages = Math.ceil(data.length / itemsPerPagePending);
        pageNumbersContainerPending.innerHTML = '';
        if (totalPages === 0) {
          firstPageButtonPending.disabled = true;
          prevPageButtonPending.disabled = true;
          nextPageButtonPending.disabled = true;
          lastPageButtonPending.disabled = true;
          return;
        }
        // แสดงเฉพาะหน้าปัจจุบัน
        const pageNumberButton = document.createElement("button");
        pageNumberButton.className = `pending-page-number active`;
        pageNumberButton.textContent = currentPagePending;
        pageNumberButton.disabled = true; // ไม่ให้คลิกได้เพราะเป็นหน้าปัจจุบัน
        pageNumbersContainerPending.appendChild(pageNumberButton);
        firstPageButtonPending.disabled = currentPagePending === 1;
        prevPageButtonPending.disabled = currentPagePending === 1;
        nextPageButtonPending.disabled = currentPagePending === totalPages;
        lastPageButtonPending.disabled = currentPagePending === totalPages;
      }
      firstPageButtonPending.onclick = () => {
        currentPagePending = 1;
        filterAndRenderTablePending();
      };
      prevPageButtonPending.onclick = () => {
        if (currentPagePending > 1) {
          currentPagePending--;
          filterAndRenderTablePending();
        }
      };
      nextPageButtonPending.onclick = () => {
        const totalPages = Math.ceil(allDataPending.filter(row => {
          const pendingDept = (row["ค้างหน่วยงาน"] || "").toLowerCase();
          return Number(row["Vipa"] || 0) > 0 &&
                 !pendingDept.includes("stock วิภาวดี 62") &&
                 !pendingDept.includes("nec_ยกเลิกผลิต");
        }).length / itemsPerPagePending);
        if (currentPagePending < totalPages) {
          currentPagePending++;
          filterAndRenderTablePending();
        }
      };
      lastPageButtonPending.onclick = () => {
        currentPagePending = Math.ceil(allDataPending.filter(row => {
          const pendingDept = (row["ค้างหน่วยงาน"] || "").toLowerCase();
          return Number(row["Vipa"] || 0) > 0 &&
                 !pendingDept.includes("stock วิภาวดี 62") &&
                 !pendingDept.includes("nec_ยกเลิกผลิต");
        }).length / itemsPerPagePending);
        filterAndRenderTablePending();
      };
      async function loadPendingCallsData() {
        console.log("Starting data load for pending calls from:", urlPending);
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 30000); // เพิ่ม timeout เป็น 30 วินาที
          const response = await fetch(urlPending, {
            signal: controller.signal,
            mode: 'cors', // เพิ่ม mode: 'cors' เพื่อแก้ปัญหา CORS
            cache: 'no-cache' // เพิ่ม cache: 'no-cache' เพื่อให้ข้อมูลสดใหม่
          });
          clearTimeout(timeoutId);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          console.log("Pending calls data loaded successfully:", data);
          if (!Array.isArray(data) || data.length === 0) {
            throw new Error("No data received or data is empty");
          }
          allDataPending = data;
          populateTeamFilterPending(allDataPending);
          addSortListenersPending();
          filterAndRenderTablePending();
        } catch (error) {
          console.error("Error loading pending calls data:", error);
          if (error.name === 'AbortError') {
            tableBodyPending.innerHTML = '<tr><td colspan="10" class="pending-text-center">การโหลดข้อมูลใช้เวลานานเกินไป กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ตหรือลองใหม่</td></tr>';
          } else if (error.message.includes('HTTP error! status: 403') || error.message.includes('CORS')) {
            tableBodyPending.innerHTML = '<tr><td colspan="10" class="pending-text-center">ไม่สามารถเข้าถึงข้อมูลได้ กรุณาตรวจสอบการแชร์ Google Sheets ให้เป็น Public (Anyone with the link can view)</td></tr>';
          } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
            tableBodyPending.innerHTML = '<tr><td colspan="10" class="pending-text-center">เกิดปัญหาการเชื่อมต่อเครือข่าย กรุณาตรวจสอบอินเทอร์เน็ตและลองใหม่</td></tr>';
          } else {
            tableBodyPending.innerHTML = `<tr><td colspan="10" class="pending-text-center">เกิดข้อผิดพลาดในการโหลดข้อมูล: ${error.message}</td></tr>`;
          }
          Swal.fire({
            icon: "error",
            title: "ไม่สามารถโหลดข้อมูล",
            text: error.name === 'AbortError'
              ? "การเชื่อมต่อช้าเกินไป กรุณาตรวจสอบเครือข่ายหรือลองใหม่"
              : error.message.includes('HTTP error! status: 403') || error.message.includes('CORS')
              ? "Google Sheets ต้องแชร์เป็น Public (ดูได้โดยไม่ต้องล็อกอิน) กรุณาตรวจสอบการแชร์"
              : "ไม่สามารถโหลดข้อมูลจาก Google Sheets ได้ กรุณาตรวจสอบ Sheet ID, ชื่อ Sheet หรือการแชร์สาธารณะ",
            confirmButtonText: "ตกลง",
          });
        }
      }
      // Initial calls (now safe after all variables defined)
      loadTheme();
      checkLoginStatus();
      // Auto-load default data if logged in
      if (appContent.classList.contains('logged-in')) {
        loadData();
      }
      // Add sort listeners for pending calls
      document.addEventListener('DOMContentLoaded', () => {
        addSortListenersPending();
      });
    </script>
  </body>
</html>
