<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ระบบขอเบิกอะไหล่คลังสินค้านวนคร</title>
    <!-- Enhanced Content Security Policy to reduce phishing risks -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com https://code.jquery.com https://opensheet.elk.sh https://docs.google.com https://script.google.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: https: blob:; connect-src 'self' https://opensheet.elk.sh https://docs.google.com https://script.google.com; frame-src https://docs.google.com; object-src 'none'; base-uri 'self'; form-action 'self' https://docs.google.com;">
    <!-- Additional security headers via meta -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <!-- Verification meta to help with Safe Browsing (add your site verification if available) -->
    <meta name="google-site-verification" content="your-verification-token-if-any">
    <!-- Clear description to indicate legitimacy -->
    <meta name="description" content="ระบบภายในสำหรับขอเบิกอะไหล่คลังสินค้านวนคร - เครื่องมือสำหรับพนักงานเท่านั้น ไม่ใช่เว็บไซต์ภายนอก">
    <link href="https://fonts.googleapis.com/css2?family=Itim&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <style>
      body {
        margin: 0;
        padding: 0;
        background-color: #eceff1;
        font-family: "Kanit", sans-serif;
      }
      /* Login Modal Styles */
      .login-modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
      }
      .login-modal.active {
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .login-content {
        background: linear-gradient(135deg, #ffffff, #f5f7fa);
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        width: 90%;
        max-width: 400px;
        text-align: center;
        animation: fadeInUp 0.4s ease;
        position: relative;
      }
      .login-content::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(135deg, #42a5f5, #2196f3);
        border-radius: 12px 12px 0 0;
      }
      .login-content h2 {
        color: #1a3c87;
        margin-bottom: 20px;
        font-family: "Itim", cursive;
        font-size: 24px;
      }
      .login-content input {
        width: 100%;
        padding: 12px;
        margin: 10px 0;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        font-size: 16px;
        box-sizing: border-box;
        transition: all 0.3s ease;
      }
      .login-content input:focus {
        border-color: #2196f3;
        outline: none;
        box-shadow: 0 0 5px rgba(33, 150, 243, 0.3);
        transform: translateY(-1px);
      }
      .login-content .password-container {
        position: relative;
      }
      .login-content .password-container i {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        color: #666;
        font-size: 16px;
        transition: color 0.3s ease;
      }
      .login-content .password-container i:hover {
        color: #2196f3;
      }
      .login-content .remember-me {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 15px 0;
        font-size: 14px;
        text-align: left;
        padding: 0 4px;
      }
      .login-content .remember-me input[type="checkbox"] {
        margin-right: 8px;
        transform: scale(1.2);
        margin-left: 0;
      }
      .login-content .remember-me label {
        cursor: pointer;
        font-family: "Poppins", sans-serif;
        font-weight: 400;
        margin: 0;
        flex-shrink: 0;
      }
      .login-content button {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #42a5f5, #2196f3);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 10px;
        transition: all 0.3s ease;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .login-content button:hover {
        background: linear-gradient(135deg, #1976d2, #1565c0);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
      }
      .login-content button:active {
        transform: translateY(0);
      }
      .login-content .error {
        color: #ef5350;
        font-size: 14px;
        margin-top: 10px;
        display: none;
        background: #ffebee;
        padding: 8px;
        border-radius: 4px;
        border-left: 3px solid #ef5350;
      }
      .logout-btn {
        background: linear-gradient(135deg, #f44336, #d32f2f);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        margin-left: 10px;
        transition: all 0.3s ease;
      }
      .logout-btn:hover {
        background: linear-gradient(135deg, #d32f2f, #b71c1c);
        transform: translateY(-1px);
      }
      .app-content {
        display: none;
      }
      .app-content.logged-in {
        display: block;
      }
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #1a3c87;
        padding: 10px 20px;
        border-bottom: 2px solid #ff80ab;
        border-radius: 12px;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
        font-family: "Itim", cursive;
        position: relative;
        background: linear-gradient(135deg, #fff3e0, #ffebee);
        margin: 10px auto;
        max-width: 1500px;
        transition: transform 0.3s ease;
      }
      .header:hover {
        transform: translateY(-2px);
      }
      .header h1 {
        color: #1a3c87;
        margin: 0;
        font-size: 30px;
        font-weight: normal;
        text-shadow: 0.5px 0.5px 1px rgba(0, 0, 0, 0.1);
        white-space: nowrap;
        text-align: center;
        flex-grow: 1;
      }
      .header-right {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 2px;
      }
      .user-name-small {
        font-size: 12px;
        color: #e91e63;
        font-weight: bold;
        text-align: right;
        white-space: nowrap;
      }
      .container {
        max-width: 1500px;
        margin: 0 auto;
        padding: 15px;
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        font-family: "Kanit", sans-serif;
      }
      .tabs {
        display: flex;
        margin-top: 5px;
        gap: 10px;
      }
      .tab-button {
        flex: 1;
        padding: 12px 16px;
        text-align: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        cursor: pointer;
        border: none;
        outline: none;
        font-size: 16px;
        font-weight: 500;
        border-radius: 50px;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        position: relative;
        overflow: hidden;
      }
      .tab-button::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
      }
      .tab-button:hover::before {
        left: 100%;
      }
      .tab-button:hover {
        background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
      }
      .tab-button.active {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        box-shadow: 0 8px 25px rgba(245, 87, 108, 0.4);
        transform: translateY(-3px) scale(1.02);
      }
      .tab-content {
        display: none;
        padding: 15px;
        background-color: #fafafa;
        border-radius: 10px;
        margin-top: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      }
      .tab-content.active {
        display: block;
      }
      .loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 22px;
        color: #2196f3;
        z-index: 9999;
        display: none;
      }
      iframe {
        width: 100%;
        height: 800px;
        border: none;
        border-radius: 10px;
      }
      .footer {
        background: linear-gradient(135deg, #0d47a1, #1565c0);
        color: white;
        text-align: center;
        padding: 10px 0;
        margin-top: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }
      .footer p {
        margin: 0;
        font-size: 14px;
      }
      .social-buttons {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 10px;
        padding: 10px;
      }
      .social-button {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        color: white;
        font-size: 18px;
        text-decoration: none;
        transition: all 0.3s ease;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      }
      .social-button:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      }
      .social-button.facebook {
        background: linear-gradient(135deg, #3b5998, #2a4373);
      }
      .social-button.tiktok {
        background: linear-gradient(135deg, #000000, #333333);
      }
      .social-button.telegram {
        background: linear-gradient(135deg, #26A5E4, #1b87b9);
      }
      .social-button.qrcode {
        background: linear-gradient(135deg, #4caf50, #388e3c);
      }
      @media screen and (max-width: 360px) {
        .social-button {
          width: 36px;
          height: 36px;
          font-size: 16px;
        }
        .social-buttons {
          gap: 8px;
        }
      }
      #parts, #today {
        font-family: "Poppins", sans-serif;
        background-color: #f0f4f8;
        padding: 15px;
        border-radius: 8px;
      }
      #parts #searchContainer, #today #searchContainer {
        display: flex;
        justify-content: flex-start;
        margin-bottom: 15px;
      }
      #parts #searchInput, #today #searchInputToday {
        width: 100%;
        max-width: 300px;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
        font-size: 15px;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
      }
      #parts #searchInput:focus, #today #searchInputToday:focus {
        border-color: #2196f3;
        box-shadow: 0 0 5px rgba(33, 150, 243, 0.3);
        outline: none;
      }
      #parts .refresh-button {
        background: linear-gradient(135deg, #42a5f5, #2196f3);
        color: #fff;
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        margin-left: 10px;
      }
      #parts .refresh-button:hover {
        background: linear-gradient(135deg, #1976d2, #1565c0);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }
      #parts table, #today table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
        border-radius: 8px;
        overflow: hidden;
      }
      #parts th, #parts td, #today th, #today td {
        padding: 10px;
        text-align: center;
        border: 1px solid #e0e0e0;
        font-size: 15px;
      }
      #parts th, #today th {
        background: linear-gradient(135deg, #2196f3, #1976d2);
        color: white;
        position: sticky;
        top: 0;
        z-index: 1;
      }
      #parts tr:hover, #today tr:hover {
        background-color: #f5f5f5;
      }
      #parts .table-container, #today .table-container {
        max-height: 80vh;
        overflow-y: auto;
        overflow-x: auto;
        background: white;
        border-radius: 8px;
      }
      #parts .pagination {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        margin-top: 12px;
      }
      #parts .pagination button {
        background: linear-gradient(135deg, #42a5f5, #2196f3);
        color: white;
        padding: 8px;
        border: none;
        border-radius: 50%;
        margin: 0 5px;
        cursor: pointer;
        width: 36px;
        height: 36px;
        font-size: 13px;
        transition: all 0.3s ease;
      }
      #parts .pagination button:hover {
        background: linear-gradient(135deg, #1976d2, #1565c0);
        transform: translateY(-2px);
      }
      #parts .pagination .active {
        background: linear-gradient(135deg, #ff9800, #f57c00);
      }
      #parts .pagination button:disabled {
        background: #b0bec5;
        cursor: not-allowed;
      }
      #parts .pagination select {
        padding: 8px;
        border-radius: 6px;
        margin: 0 10px;
        font-size: 14px;
      }
      #parts .table-container, #today .table-container {
        overflow-x: auto;
        width: 100%;
      }
      #parts table, #today table {
        min-width: 900px;
      }
      #parts td, #today td {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      #parts td:nth-child(3), #today td:nth-child(4) {
        text-align: left;
      }
      #parts th:nth-child(4), #parts td:nth-child(4) {
        min-width: 300px;
      }
      #parts th:nth-child(5), #parts td:nth-child(5) {
        min-width: 50px;
      }
      #parts th:nth-child(6), #parts td:nth-child(6) {
        min-width: 50px;
      }
      #parts th:nth-child(7), #parts td:nth-child(7) {
        min-width: 250px;
      }
      #parts th:nth-child(8), #parts td:nth-child(8) {
        min-width: 150px;
      }
      #parts .requisition-button, #today .detail-button {
        background: linear-gradient(135deg, #4caf50, #388e3c);
        color: white;
        font-size: 13px;
        font-weight: 500;
        padding: 8px 16px;
        border: none;
        border-radius: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
      }
      #parts .requisition-button:hover, #today .detail-button:hover {
        background: linear-gradient(135deg, #388e3c, #4caf50);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }
      #parts .requisition-button:focus, #today .detail-button:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.3);
      }
      #parts .requisition-button:active, #today .detail-button:active {
        transform: translateY(1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      #parts .swal2-input {
        margin: 4px 0;
        width: 100%;
        box-sizing: border-box;
        border-radius: 6px;
        font-size: 14px;
        padding: 6px;
        height: 36px;
      }
      #parts .swal2-select {
        margin: 4px 0;
        width: 100%;
        padding: 6px;
        box-sizing: border-box;
        border-radius: 6px;
        font-size: 14px;
        height: 36px;
      }
      #parts .swal2-label {
        font-weight: 500;
        margin: 8px 0 4px;
        display: block;
        text-align: left;
        font-size: 14px;
      }
      #parts .invalid-input {
        border: 2px solid #ef5350 !important;
        box-shadow: 0 0 5px rgba(239, 83, 80, 0.3);
      }
      #parts .error-message {
        color: #ef5350;
        font-size: 12px;
        margin-top: 2px;
        display: block;
        text-align: left;
      }
      #parts a {
        text-decoration: none;
        color: #2196f3;
        target="_blank" rel="noopener noreferrer";
      }
      #parts a:hover {
        color: #1565c0;
      }
      #parts img {
        transition: transform 0.2s ease;
      }
      #parts img:hover {
        transform: scale(1.1);
      }
      #today .status-green {
        color: #4caf50;
        font-weight: bold;
      }
      #today .status-red {
        color: #ef5350;
        font-weight: bold;
      }
      #today .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        opacity: 0;
        transform: scale(0.95);
        transition: opacity 0.3s ease, transform 0.3s ease;
      }
      #today .modal-content {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(to bottom right, #ffffff, #f5f7fa);
        padding: 20px;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        animation: fadeIn 0.3s ease;
        font-family: "Poppins", sans-serif;
        z-index: 1001;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
      }
      #today .close {
        color: #78909c;
        float: right;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s;
      }
      #today .close:hover {
        color: #e53935;
      }
      #today #modalContent {
        margin-top: 15px;
      }
      #today #modalContent div {
        padding: 10px 0;
        border-bottom: 1px solid #eceff1;
      }
      #today #modalContent div:last-child {
        border-bottom: none;
      }
      #today #modalContent span.label {
        display: inline-block;
        min-width: 120px;
        font-weight: 500;
        color: #2196f3;
        font-size: 15px;
      }
      #today #modalContent span.value {
        font-size: 15px;
        color: #37474f;
      }
      #today .modal-content h2 {
        color: #e91e63;
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 15px;
      }
      #today .spinner-container {
        text-align: center;
        padding: 40px 20px;
        color: #2196f3;
        font-size: 15px;
      }
      #today .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #eceff1;
        border-top: 4px solid #2196f3;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px auto;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      #error-container, #error-container-today {
        display: none;
        text-align: center;
        padding: 15px;
        color: #ef5350;
        font-size: 15px;
        background-color: #ffebee;
        border-radius: 8px;
        margin-bottom: 15px;
      }
      #retry-button, #retry-button-today {
        background: linear-gradient(135deg, #ff7043, #f44336);
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        margin-top: 10px;
        transition: all 0.3s ease;
      }
      #retry-button:hover, #retry-button-today:hover {
        background: linear-gradient(135deg, #f44336, #ff7043);
        transform: translateY(-2px);
      }
      .swal2-container {
        position: fixed !important;
        z-index: 9999;
        overflow-y: auto;
        max-height: 80vh;
      }
      .swal2-popup {
        max-width: 320px !important;
        padding: 15px !important;
        font-size: 14px !important;
        border-radius: 10px !important;
      }
      .swal2-content {
        padding-bottom: 150px !important;
      }
      .swal2-title {
        font-size: 18px !important;
        margin-bottom: 10px !important;
      }
      .swal2-actions {
        margin-top: 10px !important;
      }
      .swal2-confirm, .swal2-cancel {
        font-size: 14px !important;
        padding: 8px 16px !important;
      }
      .swal2-confirm:disabled {
        background: #b0bec5 !important;
        cursor: not-allowed !important;
        opacity: 0.6;
      }
      .autocomplete-items {
        max-height: 120px;
        border-radius: 6px;
      }
      .autocomplete-item {
        padding: 6px;
        font-size: 14px;
      }
      .swal2-qrcode {
        display: block;
        margin: 10px auto;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      .swal2-spinner-container {
        text-align: center;
        padding: 20px;
        color: #2196f3;
        font-size: 15px;
      }
      .swal2-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #eceff1;
        border-top: 4px solid #2196f3;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px auto;
      }
      @media screen and (max-width: 360px) {
        .swal2-popup {
          max-width: 300px !important;
        }
        .swal2-input, .swal2-select {
          font-size: 13px;
          height: 34px;
        }
        .swal2-label {
          font-size: 13px;
        }
        .autocomplete-item {
          font-size: 13px;
        }
        .swal2-qrcode {
          width: 120px !important;
          height: 120px !important;
        }
      }
      /* Styles for #all tab */
      #all {
        font-family: 'Prompt', sans-serif;
        background-color: #f0f4f8;
        padding: 15px;
        border-radius: 8px;
      }
      #all #searchContainerAll {
        display: flex;
        justify-content: flex-start;
        margin-bottom: 20px;
      }
      #all #searchInputAll {
        width: 100%;
        max-width: 300px;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 16px;
      }
      #all table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border-radius: 12px;
        overflow: hidden;
      }
      #all th, #all td {
        padding: 6px 12px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
        cursor: pointer;
      }
      #all th {
        background-color: #007bff;
        color: white;
      }
      #all td:nth-child(6) {
        min-width: 180px;
      }
      #all tr:hover {
        background-color: #f1f1f1;
      }
      #all .status-green {
        color: green;
        font-weight: bold;
      }
      #all .status-red {
        color: red;
        font-weight: bold;
      }
      #all .detail-button {
        padding: 6px 10px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
      #all .detail-button:hover {
        background-color: #2980b9;
      }
      #all .all-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
      }
      #all .all-modal-content {
        background-color: #fff;
        margin: 10% auto;
        padding: 20px;
        border-radius: 12px;
        width: 80%;
        max-width: 500px;
      }
      #all .all-close {
        color: #aaa;
        float: right;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
      }
      #all .all-close:hover {
        color: #000;
      }
      #all #modalContentAll span.label {
        color: #007bff;
        font-weight: bold;
      }
      #all #modalContentAll span.value {
        color: #000;
      }
      #all .all-pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 20px;
      }
      #all .all-pagination button,
      #all .all-pagination select {
        padding: 8px 12px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        margin: 0 5px;
      }
      #all .all-pagination button:hover,
      #all .all-pagination select:hover {
        background-color: #2980b9;
      }
      #all .all-pagination .all-page-number {
        padding: 6px 10px;
        background-color: #ecf0f1;
        color: #3498db;
        border-radius: 6px;
        margin: 0 3px;
        cursor: pointer;
      }
      #all .all-pagination .all-page-number.active {
        background-color: #3498db;
        color: white;
      }
      #all .all-pagination img {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }
      #all .all-items-per-page {
        margin-left: 10px;
        font-size: 16px;
      }
      #all .all-pagination .all-page-number {
        width: 36px;
        height: 36px;
        background-color: #3498db; /* น้ำเงิน */
        color: white;
        border-radius: 50%;
        display: inline-flex;
        justify-content: center;
        align-items: center;
        margin: 0 5px;
        cursor: pointer;
        font-size: 16px;
        border: none;
        transition: background-color 0.3s; /* ลื่นตอน hover */
      }
      #all .all-pagination .all-page-number:hover {
        background-color: #2980b9; /* น้ำเงินเข้ม ตอน hover */
      }
      #all .all-pagination .all-page-number.active {
        background-color: #e67e22; /* ส้มเข้ม สำหรับหน้าปัจจุบัน */
        color: white;
      }
      /* ใส่ CSS ส่วนอื่น ๆ ตามที่ได้บอกในคำตอบก่อนหน้านี้ */
      #all .all-pagination img {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }
      /* เพิ่มเส้นตาราง */
      #all table,
      #all th,
      #all td {
        border: 1px solid #ccc;
      }
      /* --- สไตล์เดิมของคุณคงอยู่ตรงนี้ --- */
      /* --- ปรับความกว้างเฉพาะบางคอลัมน์ --- */
      #all th:nth-child(3), #all td:nth-child(3) {
        width: 180px; /* Material */
        min-width: 150px;
      }
      #all th:nth-child(4), #all td:nth-child(4) {
        width: 300px; /* Description */
        min-width: 250px;
      }
      #all th:nth-child(9), #all td:nth-child(9) {
        width: 200px; /* หมายเหตุ */
        min-width: 180px;
      }
      /* --- Responsive: เวลาจอแคบให้เลื่อนตารางได้ --- */
      #all .all-table-container {
        overflow-x: auto;
        width: 100%;
      }
      #all table {
        width: 100%;
        border-collapse: collapse;
        min-width: 900px; /* กันตารางแคบเกิน */
      }
      #all th, #all td {
        padding: 8px;
        text-align: left;
        white-space: nowrap; /* กันบรรทัดตก */
      }
      @media (max-width: 768px) {
        #all th, #all td {
          padding: 6px;
          font-size: 14px;
        }
      }
       #all tr {
          opacity: 0;
          transform: translateY(10px);
          animation: fadeInUp 0.5s ease forwards;
        }
        #all tr:nth-child(even) {
          animation-delay: 0.1s;
        }
        #all tr:nth-child(odd) {
          animation-delay: 0.2s;
        }
        /* Modal Animation */
        #all .all-modal-content {
          animation: zoomIn 0.4s ease;
        }
        @keyframes zoomIn {
          from {
            opacity: 0;
            transform: scale(0.8);
          }
          to {
            opacity: 1;
            transform: scale(1);
          }
        }
        /* ปุ่ม smooth */
        #all button, #all .all-page-number, #all .detail-button {
          transition: all 0.3s ease;
        }
        #all .detail-button:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        #all .all-pagination .all-page-number:hover {
          transform: scale(1.1);
        }
        #all th:nth-child(9), #all td:nth-child(9) {
          width: 80px; /* หรือเล็กกว่านี้ เช่น 60px */
          min-width: 60px;
          max-width: 100px;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }
      /* Styles for #pending-calls tab */
      #pending-calls {
        font-family: 'Prompt', sans-serif;
        background-color: #f0f4f8;
        padding: 15px;
        border-radius: 8px;
      }
      #pending-calls #searchContainerPending {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        margin-bottom: 20px;
      }
      #pending-calls .pending-filter-row {
        display: flex;
        align-items: center;
      }
      #pending-calls .pending-search-row {
        display: flex;
        align-items: center;
        margin-top: 10px;
      }
      #pending-calls #teamFilterLabelPending {
        font-size: 16px;
        color: #333;
      }
      #pending-calls #teamFilterPending {
        margin-left: 5px;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 16px;
        background-color: #fff;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      #pending-calls #teamFilterPending:hover {
        border-color: #2980b9;
      }
      #pending-calls #searchInputPending {
        width: 300px;
        padding: 10px;
        border-radius: 8px 0 0 8px;
        border: 1px solid #ccc;
        border-right: none;
        font-size: 16px;
      }
      #pending-calls #searchButtonPending {
        padding: 10px;
        background-color: #3498db;
        color: white;
        border: 1px solid #ccc;
        border-left: none;
        border-radius: 0 8px 8px 0;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      #pending-calls #searchButtonPending:hover {
        background-color: #2980b9;
      }
      #pending-calls .pending-table-container {
        overflow-x: auto;
        width: 100%;
      }
      #pending-calls table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border-radius: 12px;
        overflow: hidden;
        min-width: 900px;
      }
      #pending-calls th, #pending-calls td {
        padding: 8px 12px;
        text-align: left;
        border: 1px solid #ccc;
        white-space: nowrap;
      }
      #pending-calls th {
        background-color: #007bff;
        color: white;
      }
      #pending-calls th.sortable {
        cursor: pointer;
      }
      #pending-calls th.sortable:hover {
        background-color: #0056b3;
      }
      #pending-calls .pending-arrow {
        font-size: 12px;
        margin-left: 5px;
      }
      #pending-calls tr:hover {
        background-color: #f1f1f1;
      }
      #pending-calls .pending-detail-button {
        padding: 6px 10px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      #pending-calls .pending-detail-button:hover {
        background-color: #2980b9;
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      }
      #pending-calls .pending-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
      }
      #pending-calls .pending-modal-content {
        background-color: #fff;
        margin: 10% auto;
        padding: 20px;
        border-radius: 12px;
        width: 80%;
        max-width: 500px;
        animation: zoomIn 0.4s ease;
      }
      #pending-calls .pending-close {
        color: #aaa;
        float: right;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
      }
      #pending-calls .pending-close:hover {
        color: #000;
      }
      #pending-calls #modalContentPending span.label {
        color: #007bff;
        font-weight: bold;
      }
      #pending-calls #modalContentPending span.value {
        color: #000;
      }
      #pending-calls .pending-pagination {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        margin-top: 20px;
      }
      #pending-calls .pending-pagination button,
      #pending-calls .pending-pagination select {
        padding: 8px 12px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        margin: 0 5px;
        transition: all 0.3s ease;
      }
      #pending-calls .pending-pagination button:hover,
      #pending-calls .pending-pagination select:hover {
        background-color: #2980b9;
      }
      #pending-calls .pending-pagination .pending-page-number {
        width: 36px;
        height: 36px;
        background-color: #3498db;
        color: white;
        border-radius: 50%;
        display: inline-flex;
        justify-content: center;
        align-items: center;
        margin: 0 5px;
        cursor: pointer;
        font-size: 16px;
        border: none;
        transition: all 0.3s ease;
      }
      #pending-calls .pending-pagination .pending-page-number:hover {
        background-color: #2980b9;
        transform: scale(1.1);
      }
      #pending-calls .pending-pagination .pending-page-number.active {
        background-color: #e67e22;
        color: white;
      }
      #pending-calls .pending-items-per-page {
        margin-left: 10px;
        font-size: 16px;
      }
      #pending-calls tr {
        opacity: 0;
        transform: translateY(10px);
        animation: fadeInUp 0.5s ease forwards;
      }
      #pending-calls tr:nth-child(even) {
        animation-delay: 0.1s;
      }
      #pending-calls tr:nth-child(odd) {
        animation-delay: 0.2s;
      }
      @keyframes fadeInUp {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes zoomIn {
        from {
          opacity: 0;
          transform: scale(0.8);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      #pending-calls th:nth-child(3), #pending-calls td:nth-child(3) {
        width: auto;
        min-width: 80px;
        max-width: 150px;
        white-space: normal;
      }
      #pending-calls th:nth-child(5), #pending-calls td:nth-child(5) {
        width: 150px;
        min-width: 120px;
      }
      #pending-calls td:nth-child(7), #pending-calls th:nth-child(7) {
        min-width: 200px;
      }
      @media (max-width: 768px) {
        #pending-calls th:nth-child(3), #pending-calls td:nth-child(3) {
          min-width: 60px;
          font-size: 14px;
        }
      }
      #pending-calls .pending-highlight-red {
        color: red;
        font-weight: bold;
      }
      #pending-calls .pending-yellow-light {
        background-color: #c9ffc4;
      }
      #pending-calls .pending-pink-pastel {
        background-color: #fce4ec;
      }
      #pending-calls .pending-text-left {
        text-align: left;
      }
      #pending-calls .pending-text-center {
        text-align: center;
      }
      #pending-calls .pending-call-count-box {
        margin-left: 20px;
        padding: 10px 16px;
        background-color: #e6f2ff;
        color: #007bff;
        border: 1px solid #d0eaff;
        border-radius: 10px;
        font-size: 16px;
        font-weight: bold;
        display: inline-flex;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: background-color 0.3s ease;
      }
      #pending-calls .pending-call-count-box span {
        color: #d63384;
        margin: 0 4px;
        font-size: 18px;
      }
      #pending-calls .pending-modern-label {
        display: inline-block;
        padding: 10px 16px;
        background-color: #ffffff;
        color: #007bff;
        border-radius: 10px;
        font-size: 16px;
        font-weight: bold;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid #d0eaff;
        transition: all 0.3s ease;
        margin-right: 8px;
      }
      #pending-calls .pending-modern-label:hover {
        background-color: #e6f2ff;
        color: #0056b3;
      }
      /* Disclaimer banner for legitimacy */
      .disclaimer {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
        padding: 10px;
        margin-bottom: 15px;
        border-radius: 8px;
        text-align: center;
        font-size: 14px;
      }
      /* Responsive adjustments for mobile devices */
      @media screen and (max-width: 768px) {
        .header {
          padding: 8px 15px;
          flex-wrap: wrap;
          overflow: visible; /* Allow overflow on small screens to prevent clipping */
          justify-content: space-between;
        }
        .header h1 {
          font-size: 20px; /* Reduce font size for better fit */
          white-space: normal; /* Allow wrapping to prevent overflow */
          text-align: left; /* Align left for better space usage */
          flex-grow: 1;
          flex-basis: 100%; /* Take full width on very small screens if needed */
          margin-bottom: 5px;
        }
        .header-right {
          flex-direction: row; /* Change to row for better horizontal space usage */
          align-items: center;
          gap: 5px;
          flex-shrink: 0;
        }
        .logout-btn {
          padding: 6px 10px; /* Smaller padding */
          font-size: 12px; /* Smaller font */
          margin-left: 0; /* Remove margin to save space */
          white-space: nowrap; /* Prevent wrapping */
        }
        .user-name-small {
          font-size: 10px; /* Smaller font for name */
          white-space: nowrap;
          max-width: 120px; /* Limit width to prevent overflow */
          overflow: hidden;
          text-overflow: ellipsis;
        }
      }
      @media screen and (max-width: 480px) {
        .header h1 {
          font-size: 18px; /* Even smaller on very small screens */
        }
        .header-right {
          flex-direction: column; /* Stack vertically if still too tight */
          align-items: flex-end;
        }
      }
    </style>
  </head>
  <body>
    <!-- Login Modal -->
    <div id="loginModal" class="login-modal active">
      <div class="login-content">
        <h2>เข้าสู่ระบบ</h2>
        <input type="text" id="username" placeholder="รหัสพนักงาน (เช่น 7512411)" />
        <div class="password-container">
          <input type="password" id="password" placeholder="รหัสผ่าน (คิดสิ)" />
          <i class="fas fa-eye-slash" id="togglePassword" onclick="togglePasswordVisibility()"></i>
        </div>
        <div class="remember-me">
          <input type="checkbox" id="rememberMe" />
          <label for="rememberMe">Remember me</label>
        </div>
        <button onclick="handleLogin()">เข้าสู่ระบบ</button>
        <div id="loginError" class="error">ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง!</div>
      </div>
    </div>
    <!-- App Content -->
    <div id="appContent" class="app-content">
      <div class="header">
        <h1>ระบบขอเบิกอะไหล่คลังสินค้านวนคร</h1>
        <div class="header-right">
          <button class="logout-btn" onclick="handleLogout()" id="logoutBtn" style="display: none;">
            <i class="fas fa-sign-out-alt"></i> ออกจากระบบ
          </button>
          <span id="userNameSmall" class="user-name-small"></span>
        </div>
      </div>
      <div class="loading" id="loading">
        <span>กำลังโหลดข้อมูล...</span>
      </div>
      <div class="container">
        <!-- Added disclaimer to clarify this is an internal tool -->
        <div class="disclaimer">
          ⚠️ ระบบนี้สำหรับคลังสินค้าวิภาวดี 62 เท่านั้น | ข้อมูลถูกส่งไปยัง Google Forms อย่างปลอดภัย | หากมีข้อสงสัย ติดต่อ คลังสินค้าวิภาวดี 62
        </div>
        <div class="tabs">
          <button class="tab-button active" id="tab-parts" onclick="showTab('parts')">
            ค้นหาอะไหล่เพื่อเบิก
          </button>
          <button class="tab-button" id="tab-today" onclick="showTab('today')">
            รายการเบิกประจำวันนี้
          </button>
          <button class="tab-button" id="tab-all" onclick="showTab('all')">
            ประวัติการเบิกอะไหล่
          </button>
          <button class="tab-button" id="tab-pending-calls" onclick="showTab('pending-calls')">
            อะไหล่จ่ายตาม Call
          </button>
        </div>
        <div id="parts" class="tab-content active">
          <div id="searchContainer">
            <input type="text" id="searchInput" placeholder="ค้นหา Code, Description...." />
            <button id="searchButton" class="refresh-button">
              <i class="fas fa-search"></i>
            </button>
          </div>
          <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
          <div id="error-container">
            <p id="error-message">เกิดข้อผิดพลาดในการโหลดข้อมูล กรุณาตรวจสอบการเชื่อมต่อหรือลองใหม่</p>
            <button id="retry-button">ลองใหม่</button>
          </div>
          <div class="table-container">
            <table id="data-table">
              <thead>
                <tr>
                  <th>เบิก</th>
                  <th>Image</th>
                  <th>Material</th>
                  <th>Description</th>
                  <th>วิภาวดี</th>
                  <th>นวนคร</th>
                  <th>Rebuilt</th>
                  <th>หมายเหตุ</th>
                  <th>Product</th>
                  <th>Spec</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="pagination" class="pagination">
            <button id="firstPage">
              <i class="fas fa-chevron-left"></i><i class="fas fa-chevron-left"></i>
            </button>
            <button id="prevPage"><i class="fas fa-chevron-left"></i></button>
            <div id="pageNumbers"></div>
            <button id="nextPage"><i class="fas fa-chevron-right"></i></button>
            <button id="lastPage">
              <i class="fas fa-chevron-right"></i><i class="fas fa-chevron-right"></i>
            </button>
            <div class="items-per-page">
              <label for="itemsPerPage">Show</label>
              <select id="itemsPerPage">
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="30">30</option>
              </select>
            </div>
          </div>
        </div>
        <div id="today" class="tab-content">
          <div id="searchContainer">
            <input type="text" id="searchInputToday" placeholder="ค้นหา Code, Material, ชื่อช่าง หรือ ทีม..." />
          </div>
          <div id="error-container-today" class="error-container" style="display: none;">
            <p id="error-message-today">เกิดข้อผิดพลาดในการโหลดข้อมูล กรุณาตรวจสอบการเชื่อมต่อหรือลองใหม่</p>
            <button id="retry-button-today">ลองใหม่</button>
          </div>
          <div id="loadingToday" class="spinner-container">
            <div class="spinner"></div>
            <p>กำลังโหลดข้อมูล...</p>
          </div>
          <div class="table-container">
            <table id="data-table-today">
              <thead>
                <tr>
                  <th>Status</th>
                  <th>วันเวลาบันทึก</th>
                  <th>Material</th>
                  <th>Description</th>
                  <th>จำนวน</th>
                  <th>วิภาวดี</th>
                  <th>ชื่อช่าง</th>
                  <th>หน่วยงาน</th>
                  <th>Call</th>
                  <th>CallType</th>
                  <th>หมายเหตุ</th>
                  <th>ดูรายละเอียด</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="detailModal" class="modal">
            <div class="modal-content">
              <span class="close" id="closeModal">×</span>
              <h2>รายละเอียด</h2>
              <div id="modalContent"></div>
            </div>
          </div>
        </div>
        <div id="all" class="tab-content">
          <div id="searchContainerAll">
            <input type="text" id="searchInputAll" placeholder="ค้นหา Code,Description, ชื่อช่าง หรือ ทีม..." />
          </div>
          <div class="all-table-container">
            <table id="data-table-all">
              <thead>
                <tr>
                  <th>Status</th>
                  <th class="sortable" data-column="Timestamp">วันเวลา <span class="arrow"></span></th>
                  <th class="sortable" data-column="Code">Material <span class="arrow"></span></th>
                  <th class="sortable" data-column="Material Description">Description <span class="arrow"></span></th>
                  <th>จำนวน</th>
                  <th class="sortable" data-column="ชื่อช่าง">ชื่อช่าง <span class="arrow"></span></th>
                  <th>หน่วยงาน</th>
                  <th>เลขที่Call</th>
                  <th>CallType</th>
                  <th class="sortable" data-column="หมายเหตุ">หมายเหตุ <span class="arrow"></span></th>
                  <th>ดูรายละเอียด</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="detailModalAll" class="all-modal">
            <div class="all-modal-content">
              <span class="all-close" id="closeModalAll">&times;</span>
              <h2>รายละเอียด</h2>
              <div id="modalContentAll"></div>
            </div>
          </div>
          <div class="all-pagination">
            <button id="firstPageAll"><i class="fas fa-chevron-left"></i><i class="fas fa-chevron-left"></i></button>
            <button id="prevPageAll"><i class="fas fa-chevron-left"></i></button>
            <div id="pageNumbersAll"></div>
            <button id="nextPageAll"><i class="fas fa-chevron-right"></i></button>
            <button id="lastPageAll">
              <i class="fas fa-chevron-right"></i><i class="fas fa-chevron-right"></i>
            </button>
            <div class="all-items-per-page">
              <label for="itemsPerPageAll">:</label>
              <select id="itemsPerPageAll">
                <option value="10">10 รายการ</option>
                <option value="20">20 รายการ</option>
                <option value="30">30 รายการ</option>
              </select>
            </div>
          </div>
        </div>
        <div id="pending-calls" class="tab-content">
          <div id="searchContainerPending">
            <div class="pending-filter-row">
              <label id="teamFilterLabelPending" for="teamFilterPending" class="pending-modern-label">เลือกทีม</label>
              <select id="teamFilterPending">
                <option value="">ทั้งหมด</option>
              </select>
              <div id="callCountInfoPending" class="pending-call-count-box">
                จำนวน Ticket ค้าง <span id="callCountValuePending">0</span> Call
              </div>
            </div>
            <div class="pending-search-row">
              <input type="text" id="searchInputPending" placeholder="ค้นหา Ticket, Team, สาขา, ค้างหน่วยงาน, Material, Description..." />
              <button id="searchButtonPending"><i class="fas fa-search"></i></button>
            </div>
          </div>
          <div class="pending-table-container">
            <table id="data-table-pending">
              <thead>
                <tr>
                  <th class="sortable" data-column="DateTime">วันที่แจ้ง <span class="pending-arrow"></span></th>
                  <th class="sortable" data-column="Ticket Number">Ticket <span class="pending-arrow"></span></th>
                  <th class="sortable" data-column="Team">Team <span class="pending-arrow"></span></th>
                  <th class="sortable" data-column="Brand">สาขา <span class="pending-arrow"></span></th>
                  <th class="sortable" data-column="ค้างหน่วยงาน">ค้างหน่วยงาน <span class="pending-arrow"></span></th>
                  <th class="sortable" data-column="Material">Material <span class="pending-arrow"></span></th>
                  <th class="sortable" data-column="Description">Description <span class="pending-arrow"></span></th>
                  <th class="sortable" data-column="Vipa">คงเหลือ <span class="pending-arrow"></span></th>
                  <th class="sortable" data-column="DayRepair">ค้าง(วัน) <span class="pending-arrow"></span></th>
                  <th>ดูรายละเอียด</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="detailModalPending" class="pending-modal">
            <div class="pending-modal-content">
              <span class="pending-close" id="closeModalPending">×</span>
              <h2>รายละเอียด</h2>
              <div id="modalContentPending"></div>
            </div>
          </div>
          <div class="pending-pagination">
            <button id="firstPagePending"><i class="fas fa-chevron-left"></i><i class="fas fa-chevron-left"></i></button>
            <button id="prevPagePending"><i class="fas fa-chevron-left"></i></button>
            <div id="pageNumbersPending"></div>
            <button id="nextPagePending"><i class="fas fa-chevron-right"></i></button>
            <button id="lastPagePending">
              <i class="fas fa-chevron-right"></i><i class="fas fa-chevron-right"></i>
            </button>
            <div class="pending-items-per-page">
              <label for="itemsPerPagePending">รายการต่อหน้า:</label>
              <select id="itemsPerPagePending">
                <option value="10">10 รายการ</option>
                <option value="20" selected>20 รายการ</option>
                <option value="30">30 รายการ</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      <div class="footer">
        <p>© 2025 คลังสินค้า SparePart วิภาวดี 62 | สงวนลิขสิทธิ์</p>
      </div>
     <div class="social-buttons">
    <button class="social-button qrcode" onclick="showQRCode()">
      <i class="fas fa-qrcode"></i>
    </button>
  </div>
    </div>
    <script>
      // Global employee data
      let employeeData = [];
      // Login System
      const loginModal = document.getElementById('loginModal');
      const appContent = document.getElementById('appContent');
      const logoutBtn = document.getElementById('logoutBtn');
      const usernameInput = document.getElementById('username');
      const passwordInput = document.getElementById('password');
      const loginError = document.getElementById('loginError');
      const rememberMeCheckbox = document.getElementById('rememberMe');
      const togglePasswordIcon = document.getElementById('togglePassword');
      const userNameSmall = document.getElementById('userNameSmall');
      function togglePasswordVisibility() {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        togglePasswordIcon.classList.toggle('fa-eye-slash');
        togglePasswordIcon.classList.toggle('fa-eye');
      }
      async function loadEmployeeData() {
        const employeeSheetID = "1eqVoLsZxGguEbRCC5rdI4iMVtQ7CK4T3uXRdx8zE3uw";
        const employeeSheetName = "Employee";
        const employeeUrl = `https://opensheet.elk.sh/${employeeSheetID}/${employeeSheetName}`;
        try {
          const response = await fetch(employeeUrl);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          return data;
        } catch (error) {
          console.error("Error loading employee data:", error);
          throw error;
        }
      }
      async function handleLogin() {
        const username = usernameInput.value.trim();
        const password = passwordInput.value.trim();
        loginError.style.display = 'none';
        if (!username || !password) {
          loginError.textContent = 'กรุณากรอกชื่อผู้ใช้และรหัสผ่าน';
          loginError.style.display = 'block';
          return;
        }
        try {
          employeeData = await loadEmployeeData();
          const expectedPassword = username.slice(-4);
          const employee = employeeData.find(e => e.IDRec && e.IDRec.toString().trim() === username && expectedPassword === password);
          if (employee && employee.Name) {
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('username', username);
            localStorage.setItem('userName', employee.Name);
            if (rememberMeCheckbox.checked) {
              localStorage.setItem('savedUsername', username);
              localStorage.setItem('rememberMe', 'true');
            } else {
              localStorage.removeItem('savedUsername');
              localStorage.removeItem('rememberMe');
            }
            checkLoginStatus();
            // Focus on search input after login
            setTimeout(() => {
              const searchInput = document.getElementById('searchInput');
              if (searchInput) searchInput.focus();
            }, 500);
          } else {
            loginError.textContent = 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง!';
            loginError.style.display = 'block';
            passwordInput.value = ''; // Clear password on error
          }
        } catch (error) {
          loginError.textContent = 'เกิดข้อผิดพลาดในการโหลดข้อมูลพนักงาน กรุณาลองใหม่';
          loginError.style.display = 'block';
          console.error('Login error:', error);
        }
      }
      function checkLoginStatus() {
        const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
        const savedUsername = localStorage.getItem('username');
        if (isLoggedIn && savedUsername) {
          loginModal.classList.remove('active');
          appContent.classList.add('logged-in');
          logoutBtn.style.display = 'block';
          userNameSmall.textContent = localStorage.getItem('userName') || '';
          // Auto-load default tab if needed
          if (document.querySelector('.tab-button.active')) {
            showTab('parts');
          }
        } else {
          loginModal.classList.add('active');
          appContent.classList.remove('logged-in');
          logoutBtn.style.display = 'none';
          userNameSmall.textContent = '';
          // Clear invalid session
          localStorage.removeItem('isLoggedIn');
          localStorage.removeItem('username');
          localStorage.removeItem('userName');
          localStorage.removeItem('savedPassword'); // Clear saved password on invalid session
        }
        // Load saved credentials if remember me was checked
        if (localStorage.getItem('rememberMe') === 'true') {
          const savedUsername = localStorage.getItem('savedUsername');
          if (savedUsername) usernameInput.value = savedUsername;
          rememberMeCheckbox.checked = true;
        }
      }
      function handleLogout() {
        localStorage.removeItem('isLoggedIn');
        localStorage.removeItem('username');
        localStorage.removeItem('userName');
        localStorage.removeItem('savedUsername');
        localStorage.removeItem('savedPassword');
        localStorage.removeItem('rememberMe');
        checkLoginStatus();
      }
      // Allow Enter key for login
      passwordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          handleLogin();
        }
      });
      // Initial check on load
      checkLoginStatus();
      function showTab(tabId) {
        const buttons = document.querySelectorAll(".tab-button");
        const contents = document.querySelectorAll(".tab-content");
        document.getElementById("loading").style.display = "flex";
        buttons.forEach((btn) => btn.classList.remove("active"));
        contents.forEach((tab) => tab.classList.remove("active"));
        const targetTab = document.getElementById(tabId);
        targetTab.classList.add("active");
        const clickedButton = Array.from(buttons).find(
          (btn) => btn.id === `tab-${tabId}`
        );
        if (clickedButton) clickedButton.classList.add("active");
        if (tabId === "parts") {
          loadData();
        } else if (tabId === "today") {
          loadTodayData();
        } else if (tabId === "all") {
          loadAllData();
        } else if (tabId === "pending-calls") {
          loadPendingCallsData();
        }
        hideLoading();
      }
      function hideLoading() {
        document.getElementById("loading").style.display = "none";
      }
      function showQRCode() {
        Swal.fire({
          title: '📷 สแกน QR Code',
          html: `
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://request888.vercel.app/" alt="QR Code" class="swal2-qrcode" style="width: 150px; height: 150px;">
            <p>สแกนเพื่อเข้าสู่ระบบขอเบิกอะไหล่</p>
          `,
          confirmButtonText: 'ปิด',
          customClass: {
            popup: 'swal2-popup',
            title: 'swal2-title',
            confirmButton: 'swal2-confirm'
          }
        });
      }
      // Parts tab script (original)
      const sheetID = "1nbhLKxs7NldWo_y0s4qZ8rlpIfyyGkR_Dqq8INmhYlw";
      const sheetName = "MainSap";
      const url = `https://opensheet.elk.sh/${sheetID}/${sheetName}`;
      const searchInput = document.getElementById("searchInput");
      const searchButton = document.getElementById("searchButton");
      const tableBody = document.querySelector("#data-table tbody");
      const pagination = document.getElementById("pagination");
      const pageNumbers = document.getElementById("pageNumbers");
      const itemsPerPageSelect = document.getElementById("itemsPerPage");
      const firstPageButton = document.getElementById("firstPage");
      const prevPageButton = document.getElementById("prevPage");
      const nextPageButton = document.getElementById("nextPage");
      const lastPageButton = document.getElementById("lastPage");
      const errorContainer = document.getElementById("error-container");
      const retryButton = document.getElementById("retry-button");
      let allData = [];
      let currentPage = 1;
      let itemsPerPage = 10;
      let currentFilteredData = [];
      itemsPerPageSelect.addEventListener("change", () => {
        itemsPerPage = parseInt(itemsPerPageSelect.value, 10);
        currentPage = 1;
        renderTableData();
        renderPagination(allData.length);
      });
      retryButton.addEventListener("click", () => {
        errorContainer.style.display = "none";
        loadData();
      });
      function renderTable(data) {
        if (!tableBody) {
          console.error("Table body for #data-table not found");
          Swal.fire({
            icon: "error",
            title: "ข้อผิดพลาด",
            text: "ไม่พบตารางข้อมูล กรุณาตรวจสอบโครงสร้างหน้าเว็บ",
            confirmButtonText: "ตกลง",
          });
          return;
        }
        tableBody.innerHTML = "";
        data.forEach((row) => {
          const tr = document.createElement("tr");
          const requisitionTd = document.createElement("td");
          const btn = document.createElement("button");
          btn.textContent = "เบิก";
          btn.className = "requisition-button";
          btn.onclick = () => showRequisitionDialog(row);
          requisitionTd.appendChild(btn);
          tr.appendChild(requisitionTd);
          const columns = [
            "UrlWeb",
            "Material",
            "Description",
            "วิภาวดี",
            "Unrestricted",
            "Rebuilt",
            "หมายเหตุ",
            "Product",
            "OCRTAXT"
          ];
          // Convert values to numbers for comparison
          const vibhavadiValue = parseFloat(row["วิภาวดี"]) || 0;
          const unrestrictedValue = parseFloat(row["Unrestricted"]) || 0;
          // Determine styling based on conditions
          let textColor = "";
          let fontWeight = "";
          if (vibhavadiValue > 0) {
            textColor = "#4caf50"; // Green
            fontWeight = "bold";
          } else if (vibhavadiValue === 0 && unrestrictedValue > 0) {
            textColor = "#2196f3"; // Blue
            fontWeight = "bold";
          }
          columns.forEach((col) => {
            const td = document.createElement("td");
            let value = row[col] || "";
            if (col === "วิภาวดี" || col === "Unrestricted") {
              if (value && !isNaN(value)) {
                value = Number(value).toLocaleString("en-US", {
                  maximumFractionDigits: 0,
                });
              } else if (value === "0" || value === 0) {
                value = "";
              }
            }
            if ((col === "หมายเหตุ" || col === "Rebuilt") && value) {
              td.style.color = "red";
              td.style.fontWeight = "bold";
            }
            // Apply conditional styling to Material, Description, วิภาวดี, and Unrestricted
            if (
              col === "Material" ||
              col === "Description" ||
              col === "วิภาวดี" ||
              col === "Unrestricted"
            ) {
              if (textColor) td.style.color = textColor;
              if (fontWeight) td.style.fontWeight = fontWeight;
            }
            if (col === "UrlWeb" && value && value.startsWith("https://drive.google.com/uc?")) {
              td.innerHTML = `
                <a href="${value}" target="_blank" rel="noopener noreferrer">
                 <button class="view-image-btn">ดูรูป</button>
                </a>
              `;
            } else if (col === "UrlWeb" && value) {
              td.innerHTML = `
                <a href="${value}" target="_blank" rel="noopener noreferrer">
                  <button class="view-image-btn">ดูรูป</button>
                </a>
              `;
            } else {
              td.textContent = value;
            }
            tr.appendChild(td);
          });
          tableBody.appendChild(tr);
        });
      }
      async function showRequisitionDialog(row) {
        document.body.style.overflow = 'hidden';
        const history = {
          employeeCode: getFromLocalStorage('employeeCode'),
          team: getFromLocalStorage('team'),
          contact: getFromLocalStorage('contact'),
          callNumber: getFromLocalStorage('callNumber'),
          callType: getFromLocalStorage('callType'),
        };
        if (employeeData.length === 0) {
          employeeData = await loadEmployeeData();
        }
        Swal.fire({
          title: '📋 เบิกอะไหล่นวนคร',
          html: `
            <style>
              .autocomplete-items {
                position: absolute;
                border: 1px solid #ccc;
                border-top: none;
                z-index: 9999;
                background-color: white;
                width: 100%;
                max-height: 120px;
                overflow-y: auto;
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                margin-top: 2px;
                border-radius: 6px;
              }
              .autocomplete-item {
                padding: 6px;
                cursor: pointer;
                font-size: 14px;
              }
              .autocomplete-item:hover {
                background-color: #f1f1f1;
              }
              .swal2-label {
                text-align: left !important;
                display: block !important;
                margin: 8px 0 4px !important;
                font-weight: bold !important;
                width: 100% !important;
              }
              .swal2-input, .swal2-select {
                width: 100% !important;
                margin: 4px 0 !important;
                padding: 6px !important;
                box-sizing: border-box !important;
                font-size: 14px !important;
                height: 36px !important;
              }
              .error-message {
                color: red !important;
                font-size: 12px !important;
                margin-top: 2px !important;
                display: block !important;
                text-align: left !important;
              }
              .invalid-input {
                border: 2px solid red !important;
                box-shadow: 0 0 5px rgba(255, 0, 0, 0.5) !important;
              }
              #swal-employee-name-display, #swal-team-display {
                color: #4caf50 !important;
                font-weight: bold !important;
                margin: 4px 0 !important;
                padding: 4px !important;
                background: #e8f5e8 !important;
                border-radius: 4px !important;
                text-align: left !important;
              }
            </style>
            <div class="swal2-label">📦 Material: ${row.Material || ''}</div>
            <div class="swal2-label">📝 Description: ${row.Description || ''}</div>
            <label class="swal2-label">🔢 จำนวน</label>
            <input id="swal-quantity" class="swal2-input" type="number" value="1" min="1">
            <span id="swal-quantity-error" class="error-message"></span>
            <label class="swal2-label">🆔 รหัสพนักงาน</label>
            <input id="swal-employee-code" class="swal2-input" placeholder="7xxxxxx">
            <div id="employee-code-history" class="autocomplete-items" style="display:none;"></div>
            <span id="swal-employee-code-error" class="error-message"></span>
            <label class="swal2-label">👤 ชื่อพนักงาน</label>
            <div id="swal-employee-name-display"></div>
            <label class="swal2-label">👥 ทีม</label>
            <div id="swal-team-display"></div>
            <label class="swal2-label">📞 เบอร์ติดต่อ</label>
            <input id="swal-contact" class="swal2-input" placeholder="เช่น 08xxxxxxxx">
            <div id="contact-history" class="autocomplete-items" style="display:none;"></div>
            <span id="swal-contact-error" class="error-message"></span>
            <label class="swal2-label">📄 เลขที่ Call</label>
            <input id="swal-call-number" class="swal2-input" placeholder="2... หรือ ...">
            <div id="call-number-history" class="autocomplete-items" style="display:none;"></div>
            <span id="swal-call-number-error" class="error-message"></span>
            <label class="swal2-label">🗳️ Call Type</label>
            <select id="swal-call-type" class="swal2-select">
              <option value="" disabled selected>เลือก Call Type</option>
              <option value="I">I</option>
              <option value="P">P</option>
              <option value="Q">Q</option>
              <option value="R">R</option>
            </select>
            <span id="swal-call-type-error" class="error-message"></span>
            <label class="swal2-label">🗒️ หมายเหตุ</label>
            <input id="swal-remark" class="swal2-input" placeholder="ไม่บังคับ" readonly>
            <span id="swal-remark-error" class="error-message"></span>
          `,
          focusConfirm: false,
          showCancelButton: true,
          confirmButtonText: 'ยืนยัน',
          cancelButtonText: 'ยกเลิก',
          allowOutsideClick: false,
          allowEscapeKey: false,
          didOpen: () => {
            const quantityInput = document.getElementById('swal-quantity');
            const employeeCodeInput = document.getElementById('swal-employee-code');
            const contactInput = document.getElementById('swal-contact');
            const callNumberInput = document.getElementById('swal-call-number');
            const callTypeInput = document.getElementById('swal-call-type');
            const remarkInput = document.getElementById('swal-remark');
            const confirmButton = document.querySelector('.swal2-confirm');
            confirmButton.disabled = true;
            function setupAutocomplete(input, key, containerId) {
              input.addEventListener('input', () => {
                const container = document.getElementById(containerId);
                const val = input.value.toLowerCase();
                const items = getFromLocalStorage(key).filter(item => item.toLowerCase().includes(val));
                container.innerHTML = '';
                items.forEach(item => {
                  const div = document.createElement('div');
                  div.className = 'autocomplete-item';
                  div.textContent = item;
                  div.onclick = () => {
                    input.value = item;
                    container.style.display = 'none';
                    validateInputs();
                  };
                  container.appendChild(div);
                });
                container.style.display = items.length ? 'block' : 'none';
              });
              input.addEventListener('blur', () => {
                setTimeout(() => {
                  const container = document.getElementById(containerId);
                  container.style.display = 'none';
                }, 200);
              });
            }
            setupAutocomplete(contactInput, 'contact', 'contact-history');
            setupAutocomplete(callNumberInput, 'callNumber', 'call-number-history');
            setupAutocomplete(callTypeInput, 'callType', 'call-type-history');
            const lastContact = getFromLocalStorage('contact')[0];
            if (lastContact) contactInput.value = lastContact;
            const inputs = [quantityInput, employeeCodeInput, contactInput, callNumberInput, callTypeInput, remarkInput];
            inputs.forEach(input => {
              input.addEventListener('focus', () => {
                const popup = document.querySelector('.swal2-popup');
                popup.style.transform = 'translateY(-20%)';
                popup.style.transition = 'transform 0.3s ease';
              });
              input.addEventListener('blur', () => {
                const popup = document.querySelector('.swal2-popup');
                popup.style.transform = 'translateY(0)';
              });
            });
            function validateInputs() {
              const errors = {
                quantityError: document.getElementById('swal-quantity-error'),
                employeeCodeError: document.getElementById('swal-employee-code-error'),
                contactError: document.getElementById('swal-contact-error'),
                callNumberError: document.getElementById('swal-call-number-error'),
                callTypeError: document.getElementById('swal-call-type-error'),
                remarkError: document.getElementById('swal-remark-error')
              };
              inputs.forEach(input => input.classList.remove('invalid-input'));
              Object.values(errors).forEach(el => el.textContent = '');
              let isValid = true;
              if (!quantityInput.value || quantityInput.value < 1) {
                errors.quantityError.textContent = 'กรุณากรอกจำนวนที่มากกว่าหรือเท่ากับ 1';
                quantityInput.classList.add('invalid-input');
                isValid = false;
              }
              const employeeCode = employeeCodeInput.value.trim();
              if (!employeeCode || !/^\d{7}$/.test(employeeCode) || employeeCode[0] !== '7') {
                errors.employeeCodeError.textContent = 'รหัสพนักงานต้องเป็นตัวเลข 7 หลัก เริ่มด้วย 7 (เช่น 7512411)';
                employeeCodeInput.classList.add('invalid-input');
                document.getElementById('swal-employee-name-display').textContent = '';
                document.getElementById('swal-team-display').textContent = '';
                isValid = false;
              } else {
                // Check against employee data
                const employee = employeeData.find(e => e.IDRec && e.IDRec.toString().trim() === employeeCode);
                if (!employee || !employee.Name) {
                  errors.employeeCodeError.textContent = 'ไม่พบรหัสพนักงานนี้ในระบบ';
                  employeeCodeInput.classList.add('invalid-input');
                  document.getElementById('swal-employee-name-display').textContent = '';
                  document.getElementById('swal-team-display').textContent = '';
                  isValid = false;
                } else {
                  document.getElementById('swal-employee-name-display').textContent = `${employee.Name}`;
                  document.getElementById('swal-team-display').textContent = `${employee.หน่วยงาน || ''}`;
                  errors.employeeCodeError.textContent = '';
                }
              }
              if (!contactInput.value || !/^(0|\+66)[6-9][0-9]{7,8}$/.test(contactInput.value)) {
                errors.contactError.textContent = 'กรุณากรอกเบอร์ติดต่อที่ถูกต้อง (เช่น 08xxxxxxxx)';
                contactInput.classList.add('invalid-input');
                isValid = false;
              }
              const hasRemark = remarkInput.value.trim().length > 0;
              if (!hasRemark) {
                if (!callNumberInput.value) {
                  errors.callNumberError.textContent = 'กรุณากรอกเลขที่ Call';
                  callNumberInput.classList.add('invalid-input');
                  isValid = false;
                } else if (
                  (callNumberInput.value.startsWith('2') && callNumberInput.value.length !== 11) ||
                  (!callNumberInput.value.startsWith('2') && callNumberInput.value.length !== 7)
                ) {
                  errors.callNumberError.textContent = 'เลขที่ Call ต้องขึ้นต้นด้วย 2 (11 ตัวอักษร) หรือ (7 ตัวอักษร)';
                  callNumberInput.classList.add('invalid-input');
                  isValid = false;
                }
                if (!callTypeInput.value) {
                  errors.callTypeError.textContent = 'กรุณาเลือก Call Type';
                  callTypeInput.classList.add('invalid-input');
                  isValid = false;
                }
              }
              confirmButton.disabled = !isValid;
            }
            quantityInput.addEventListener('input', validateInputs);
            employeeCodeInput.addEventListener('input', validateInputs);
            contactInput.addEventListener('input', validateInputs);
            callNumberInput.addEventListener('input', validateInputs);
            callTypeInput.addEventListener('change', validateInputs);
            remarkInput.addEventListener('input', validateInputs);
            validateInputs();
            quantityInput.focus();
          },
          didClose: () => {
            document.body.style.overflow = 'auto';
          },
          preConfirm: () => {
            const quantityInput = document.getElementById('swal-quantity');
            const employeeCodeInput = document.getElementById('swal-employee-code');
            const contactInput = document.getElementById('swal-contact');
            const callNumberInput = document.getElementById('swal-call-number');
            const callTypeInput = document.getElementById('swal-call-type');
            const remarkInput = document.getElementById('swal-remark');
            const errors = {
              quantityError: document.getElementById('swal-quantity-error'),
              employeeCodeError: document.getElementById('swal-employee-code-error'),
              contactError: document.getElementById('swal-contact-error'),
              callNumberError: document.getElementById('swal-call-number-error'),
              callTypeError: document.getElementById('swal-call-type-error'),
              remarkError: document.getElementById('swal-remark-error')
            };
            [quantityInput, employeeCodeInput, contactInput, callNumberInput, callTypeInput, remarkInput].forEach(input => {
              input.classList.remove('invalid-input');
            });
            Object.values(errors).forEach(el => el.textContent = '');
            let isValid = true;
            if (!quantityInput.value || quantityInput.value < 1) {
              errors.quantityError.textContent = 'กรุณากรอกจำนวนที่มากกว่าหรือเท่ากับ 1';
              quantityInput.classList.add('invalid-input');
              isValid = false;
            }
            const employeeCode = employeeCodeInput.value.trim();
            console.log('Employee Code Input:', employeeCode);
            if (!employeeCode || !/^\d{7}$/.test(employeeCode) || employeeCode[0] !== '7') {
              errors.employeeCodeError.textContent = 'รหัสพนักงานต้องเป็นตัวเลข 7 หลัก เริ่มด้วย 7 (เช่น 7512411)';
              employeeCodeInput.classList.add('invalid-input');
              isValid = false;
            } else {
              const employee = employeeData.find(e => e.IDRec && e.IDRec.toString().trim() === employeeCode);
              if (!employee || !employee.Name) {
                errors.employeeCodeError.textContent = 'ไม่พบรหัสพนักงานนี้ในระบบ';
                employeeCodeInput.classList.add('invalid-input');
                isValid = false;
              }
            }
            if (!contactInput.value || !/^(0|\+66)[6-9][0-9]{7,8}$/.test(contactInput.value)) {
              errors.contactError.textContent = 'กรุณากรอกเบอร์ติดต่อที่ถูกต้อง (เช่น 08xxxxxxxx)';
              contactInput.classList.add('invalid-input');
              isValid = false;
            }
            const hasRemark = remarkInput.value.trim().length > 0;
            if (!hasRemark) {
              if (!callNumberInput.value) {
                errors.callNumberError.textContent = 'กรุณากรอกเลขที่ Call';
                callNumberInput.classList.add('invalid-input');
                isValid = false;
              } else if (
                (callNumberInput.value.startsWith('2') && callNumberInput.value.length !== 11) ||
                (!callNumberInput.value.startsWith('2') && callNumberInput.value.length !== 7)
              ) {
                errors.callNumberError.textContent = 'เลขที่ Call ต้องขึ้นต้นด้วย 2 (11 ตัวอักษร) หรือ (7 ตัวอักษร)';
                callNumberInput.classList.add('invalid-input');
                isValid = false;
              }
              if (!callTypeInput.value) {
                errors.callTypeError.textContent = 'กรุณาเลือก Call Type';
                callTypeInput.classList.add('invalid-input');
                isValid = false;
              }
            }
            if (isValid) {
              const employee = employeeData.find(e => e.IDRec && e.IDRec.toString().trim() === employeeCode);
              saveToLocalStorage('employeeCode', employeeCode);
              saveToLocalStorage('contact', contactInput.value);
              if (callNumberInput.value) {
                saveToLocalStorage('callNumber', callNumberInput.value);
              }
              if (callTypeInput.value) {
                saveToLocalStorage('callType', callTypeInput.value);
              }
              return {
                quantity: quantityInput.value,
                employeeCode: employeeCode,
                employeeName: employee ? employee.Name : '',
                team: employee ? (employee.หน่วยงาน || '') : '',
                contact: contactInput.value,
                callNumber: callNumberInput.value,
                callType: callTypeInput.value,
                remark: remarkInput.value
              };
            }
            return false;
          }
        }).then(async (result) => {
          if (result.isConfirmed) {
            const formValues = result.value;
            const vibhavadiValue = parseFloat(row["วิภาวดี"]) || 0;
            const quantity = parseFloat(formValues.quantity) || 0;
            // เช็คเงื่อนไขเตือน
            if (quantity <= vibhavadiValue) {
              await Swal.fire({
                icon: 'warning',
                title: '⚠️ คำเตือน',
                text: `ที่คลังวิภาวดีมีอะไหล่ ${vibhavadiValue.toLocaleString()} ชิ้น (จำนวนที่เบิก ${quantity} ชิ้น)`,
                confirmButtonText: 'ยืนยันดำเนินการต่อ',
                allowOutsideClick: false,
                allowEscapeKey: false
              });
            }
            // เพิ่ม popup สรุปข้อมูลที่นี่
            const summaryResult = await Swal.fire({
              title: 'สรุปข้อมูลการเบิก',
              html: `
                <div style="text-align: left; font-size: 14px;">
                  <p><strong>Material:</strong> ${row.Material || ''}</p>
                  <p><strong>Description:</strong> ${row.Description || ''}</p>
                  <p><strong>จำนวน:</strong> ${formValues.quantity}</p>
                  <p><strong>รหัสพนักงาน:</strong> ${formValues.employeeCode}</p>
                  <p><strong>ชื่อพนักงาน:</strong> ${formValues.employeeName}</p>
                  <p><strong>ทีม:</strong> ${formValues.team}</p>
                  <p><strong>เบอร์ติดต่อ:</strong> ${formValues.contact}</p>
                  <p><strong>เลขที่ Call:</strong> ${formValues.callNumber || 'ไม่มี'}</p>
                  <p><strong>Call Type:</strong> ${formValues.callType || 'ไม่มี'}</p>
                  <p><strong>หมายเหตุ:</strong> ${formValues.remark || 'ไม่มี'}</p>
                  <hr style="margin: 10px 0;">
                </div>
              `,
              icon: 'info',
              showCancelButton: true,
              confirmButtonText: 'ยืนยันการเบิก',
              cancelButtonText: 'แก้ไข',
              allowOutsideClick: false,
              allowEscapeKey: false
            });
            if (summaryResult.isConfirmed) {
              // ดำเนินการส่งข้อมูล
              const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLScEkPW7y1aM-Zb4YmvL_ytjgSssPZMpiEjOSspQZd_vzo7bRA/formResponse";
              const formData = new URLSearchParams();
              formData.append("entry.1920472981", row.Material);
              formData.append("entry.1467523821", row.Description);
              formData.append("entry.795690319", formValues.quantity);
              formData.append("entry.794964518", formValues.contact);
              formData.append("entry.702998988", formValues.employeeCode);
              formData.append("entry.1899594146", formValues.team);
              formData.append("entry.1607225659", formValues.callNumber);
              formData.append("entry.738519154", formValues.callType);
              Swal.fire({
                title: 'กำลังบันทึกข้อมูล...',
                html: `
                  <div class="swal2-spinner-container">
                    <div class="swal2-spinner"></div>
                    <p>กรุณารอสักครู่...</p>
                  </div>
                `,
                showConfirmButton: false,
                allowOutsideClick: false,
                allowEscapeKey: false
              });
              try {
                const response = await fetch(formUrl, {
                  method: "POST",
                  mode: "no-cors",
                  headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                  },
                  body: formData.toString()
                });
                await new Promise(resolve => setTimeout(resolve, 2000));
                Swal.fire({
                  icon: 'success',
                  title: 'ส่งข้อมูลสำเร็จ!',
                  text: 'ข้อมูลได้ถูกบันทึกเรียบร้อยแล้ว',
                  confirmButtonText: 'OK'
                }).then((result) => {
                  if (result.isConfirmed) {
                    Swal.fire({
                      title: 'กำลังเปลี่ยนหน้า...',
                      html: `
                        <div class="swal2-spinner-container">
                          <div class="swal2-spinner"></div>
                          <p>กรุณารอสักครู่...</p>
                        </div>
                      `,
                      showConfirmButton: false,
                      allowOutsideClick: false,
                      allowEscapeKey: false
                    });
                    setTimeout(() => {
                      Swal.close();
                      showTab('today');
                    }, 2000);
                  }
                });
              } catch (error) {
                console.error('เกิดข้อผิดพลาดในการส่งฟอร์ม:', error);
                Swal.fire({
                  icon: 'error',
                  title: 'เกิดข้อผิดพลาด',
                  text: 'ไม่สามารถส่งข้อมูลไปยัง Google Form ได้ กรุณาลองใหม่',
                  confirmButtonText: 'ตกลง'
                });
              }
            }
          }
        });
      }
      function saveToLocalStorage(key, value) {
        let items = JSON.parse(localStorage.getItem(key)) || [];
        if (!items.includes(value)) {
          items.unshift(value);
          if (items.length > 5) items.pop();
          localStorage.setItem(key, JSON.stringify(items));
        }
      }
      function getFromLocalStorage(key) {
        return JSON.parse(localStorage.getItem(key)) || [];
      }
      function renderPagination(totalItems) {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        pageNumbers.innerHTML = "";
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, currentPage + 2);
        if (totalPages <= 5) {
          startPage = 1;
          endPage = totalPages;
        } else {
          if (currentPage <= 3) {
            endPage = 5;
          } else if (currentPage >= totalPages - 2) {
            startPage = totalPages - 4;
          }
        }
        for (let page = startPage; page <= endPage; page++) {
          const button = document.createElement("button");
          button.textContent = page;
          button.className = page === currentPage ? "active" : "";
          button.onclick = () => changePage(page);
          pageNumbers.appendChild(button);
        }
        firstPageButton.disabled = currentPage === 1;
        prevPageButton.disabled = currentPage === 1;
        nextPageButton.disabled = currentPage === totalPages;
        lastPageButton.disabled = currentPage === totalPages;
      }
      function changePage(page) {
        currentPage = page;
        renderTableData();
        renderPagination(currentFilteredData.length);
      }
      function renderTableData() {
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        renderTable(currentFilteredData.slice(startIndex, endIndex));
      }
      searchButton.addEventListener("click", () => {
        const keyword = searchInput.value.trim().toLowerCase();
        if (!keyword) {
          Swal.fire({
            icon: "warning",
            title: "กรุณากรอกคำค้นหา",
            text: "โปรดใส่ข้อความที่ต้องการค้นหาก่อนกดปุ่มค้นหา!",
            confirmButtonText: "ตกลง",
          });
          currentFilteredData = allData;
        } else {
          currentFilteredData = allData.filter((row) => {
            return (
              (row["Material"] || "").toLowerCase().includes(keyword) ||
              (row["Description"] || "").toLowerCase().includes(keyword) ||
              (row["Rebuilt"] || "").toLowerCase().includes(keyword) ||
              (row["Product"] || "").toLowerCase().includes(keyword) ||
              (row["OCRTAXT"] || "").toLowerCase().includes(keyword) ||
              (row["หมายเหตุ"] || "").toLowerCase().includes(keyword)
            );
          });
        }
        currentPage = 1;
        renderTableData();
        renderPagination(currentFilteredData.length);
      });
      searchInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          searchButton.click();
          searchInput.blur();
        }
      });
      firstPageButton.addEventListener("click", () => {
        currentPage = 1;
        renderTableData();
        renderPagination(currentFilteredData.length);
      });
      prevPageButton.addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage--;
          renderTableData();
          renderPagination(currentFilteredData.length);
        }
      });
      nextPageButton.addEventListener("click", () => {
        const totalPages = Math.ceil(currentFilteredData.length / itemsPerPage);
        if (currentPage < totalPages) {
          currentPage++;
          renderTableData();
          renderPagination(currentFilteredData.length);
        }
      });
      lastPageButton.addEventListener("click", () => {
        const totalPages = Math.ceil(currentFilteredData.length / itemsPerPage);
        currentPage = totalPages;
        renderTableData();
        renderPagination(currentFilteredData.length);
      });
      async function loadData() {
        document.getElementById("loading").style.display = "flex";
        errorContainer.style.display = "none";
        console.log("Starting data load from:", url);
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 15000);
          const response = await fetch(url, { signal: controller.signal });
          clearTimeout(timeoutId);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          console.log("Data loaded successfully:", data);
          if (!Array.isArray(data) || data.length === 0) {
            throw new Error("No data received or data is empty");
          }
          allData = data;
          currentFilteredData = data;
          renderTableData();
          renderPagination(data.length);
          document.getElementById("loading").style.display = "none";
        } catch (error) {
          console.error("Error loading data:", error);
          document.getElementById("loading").style.display = "none";
          errorContainer.style.display = "block";
          document.getElementById("error-message").textContent = error.message.includes("aborted")
            ? "การโหลดข้อมูลใช้เวลานานเกินไป กรุณาตรวจสอบการเชื่อมต่อ"
            : `ไม่สามารถโหลดข้อมูลได้: ${error.message}`;
          Swal.fire({
            icon: "error",
            title: "ไม่สามารถโหลดข้อมูล",
            text: error.message.includes("aborted")
              ? "การเชื่อมต่อช้าเกินไป กรุณาตรวจสอบเครือข่ายหรือลองใหม่"
              : "ไม่สามารถโหลดข้อมูลจาก Google Sheets ได้ กรุณาตรวจสอบ Sheet ID, ชื่อ Sheet หรือการแชร์สาธารณะ",
            confirmButtonText: "ตกลง",
          });
        }
      }
      // Today tab script (original)
      const sheetIDToday = "1fPzWLyR0xqU30gyIMSuSCuglKEr76AT1ekCR3mY-nrU";
      const sheetNameToday = "ReQuesttoday";
      const urlToday = `https://opensheet.elk.sh/${sheetIDToday}/${sheetNameToday}`;
      const modal = document.getElementById("detailModal");
      const modalContent = document.getElementById("modalContent");
      const closeModal = document.getElementById("closeModal");
      const searchInputToday = document.getElementById("searchInputToday");
      const tableBodyToday = document.querySelector("#data-table-today tbody");
      const errorContainerToday = document.getElementById("error-container-today");
      const retryButtonToday = document.getElementById("retry-button-today");
      let allDataToday = [];
      retryButtonToday.addEventListener("click", () => {
        errorContainerToday.style.display = "none";
        loadTodayData();
      });
      closeModal.onclick = () => {
        modal.style.opacity = "0";
        modal.style.transform = "scale(0.95)";
        setTimeout(() => (modal.style.display = "none"), 300);
      };
      window.onclick = (event) => {
        if (event.target == modal) closeModal.click();
      };
      function renderTableToday(data) {
        tableBodyToday.innerHTML = "";
        data.forEach((row) => {
          const tr = document.createElement("tr");
          const statusTd = document.createElement("td");
          const status = row["Status"] || "";
          statusTd.textContent = status;
          statusTd.className = status === "สั่งเบิกแล้ว" ? "status-green" : "status-red";
          tr.appendChild(statusTd);
          const columns = [
            "Timestamp",
            "Code",
            "Material Description",
            "จำนวน",
            "วิภาวดี",
            "ชื่อช่าง",
            "หน่วยงาน",
            "CallNumber",
            "CallType",
            "หมายเหตุ",
          ];
          columns.forEach((col) => {
            const td = document.createElement("td");
            let value = row[col] || "";
            if (col === "จำนวน" || col === "วิภาวดี") {
              if (value && !isNaN(value)) {
                value = Number(value).toLocaleString("en-US", { maximumFractionDigits: 0 });
              } else if (value === "0" || value === 0) {
                value = "";
              }
            }
            if (col === "หมายเหตุ" && value) {
              td.style.color = "red";
              td.style.fontWeight = "bold";
            }
            if (col === "Code" && (row["หมายเหตุ"] || "").trim() !== "") {
              td.style.color = "red";
              td.style.fontWeight = "bold";
            }
            if (col === "Material Description" && (row["หมายเหตุ"] || "").trim() !== "") {
              td.style.color = "red";
              td.style.fontWeight = "bold";
            }
            if (col === "Timestamp" && (row["หมายเหตุ"] || "").trim() !== "") {
              td.style.color = "red";
              td.style.fontWeight = "bold";
            }
            if (col === "วิภาวดี" && value) {
              td.style.color = "#4caf50"; // Green color
              td.style.fontWeight = "bold";
           }
            td.textContent = value;
            tr.appendChild(td);
          });
          const detailTd = document.createElement("td");
          const btn = document.createElement("button");
          btn.textContent = "ดูรายละเอียด";
          btn.className = "detail-button";
          btn.onclick = () => {
            modalContent.innerHTML = columns
              .map((col) => {
                let label = "";
                switch (col) {
                  case "Timestamp": label = "📅 วันเวลา"; break;
                  case "Code": label = "🔢 Material"; break;
                  case "Material Description": label = "🛠️ Description"; break;
                  case "จำนวน": label = "🔢 จำนวน"; break;
                  case "ชื่อช่าง": label = "👷‍♂️ ชื่อช่าง"; break;
                  case "หน่วยงาน": label = "🏢 หน่วยงาน"; break;
                  case "CallNumber": label = "📄 Call"; break;
                  case "CallType": label = "🗳️ CallType"; break;
                  case "วิภาวดี": label = "📦 คลังวิภาวดี"; break;
                  case "หมายเหตุ": label = "📝 หมายเหตุ"; break;
                  default: label = col;
                }
                const value = row[col] || "";
                const valueHtml = col === "หมายเหตุ" && value
                  ? `<span class='value' style='color:red'>${value}</span>`
                  : `<span class='value'>${value}</span>`;
                return `<div><span class='label'>${label}:</span> ${valueHtml}</div>`;
              })
              .join("");
            modal.style.display = "block";
            setTimeout(() => {
              modal.style.opacity = "1";
              modal.style.transform = "scale(1)";
            }, 10);
          };
          detailTd.appendChild(btn);
          tr.appendChild(detailTd);
          tableBodyToday.appendChild(tr);
        });
      }
      searchInputToday.addEventListener("input", (e) => {
        const keyword = e.target.value.toLowerCase();
        const filtered = allDataToday.filter((row) => {
          return (
            (row["Code"] || "").toLowerCase().includes(keyword) ||
            (row["Material Description"] || "").toLowerCase().includes(keyword) ||
            (row["ชื่อช่าง"] || "").toLowerCase().includes(keyword) ||
            (row["หน่วยงาน"] || "").toLowerCase().includes(keyword)
          );
        });
        renderTableToday(filtered);
      });
      async function loadTodayData() {
        document.getElementById("loading").style.display = "flex";
        document.getElementById("loadingToday").style.display = "block";
        errorContainerToday.style.display = "none";
        console.log("Starting data load from:", urlToday);
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 15000);
          const response = await fetch(urlToday, { signal: controller.signal });
          clearTimeout(timeoutId);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          console.log("Today data loaded successfully:", data);
          if (!Array.isArray(data) || data.length === 0) {
            throw new Error("No data received or data is empty");
          }
          allDataToday = data;
          renderTableToday(data);
          document.getElementById("loading").style.display = "none";
          document.getElementById("loadingToday").style.display = "none";
          document.getElementById("data-table-today").style.display = "table";
        } catch (error) {
          console.error("Error loading today data:", error);
          document.getElementById("loading").style.display = "none";
          document.getElementById("loadingToday").style.display = "none";
          errorContainerToday.style.display = "block";
          document.getElementById("error-message-today").textContent = error.message.includes("aborted")
            ? "การโหลดข้อมูลใช้เวลานานเกินไป กรุณาตรวจสอบการเชื่อมต่อ"
            : `ไม่สามารถโหลดข้อมูลได้: ${error.message}`;
          Swal.fire({
            icon: "error",
            title: "ไม่สามารถโหลดข้อมูล",
            text: error.message.includes("aborted")
              ? "การเชื่อมต่อช้าเกินไป กรุณาตรวจสอบเครือข่ายหรือลองใหม่"
              : "ไม่สามารถโหลดข้อมูลจาก Google Sheets ได้ กรุณาตรวจสอบ Sheet ID, ชื่อ Sheet หรือการแชร์สาธารณะ",
            confirmButtonText: "ตกลง",
          });
        }
      }
      // All tab script
      const sheetIDAll = '1fPzWLyR0xqU30gyIMSuSCuglKEr76AT1ekCR3mY-nrU';
      const sheetNameAll = 'ReQuestHistory';
      const urlAll = `https://opensheet.elk.sh/${sheetIDAll}/${sheetNameAll}`;
      const modalAll = document.getElementById("detailModalAll");
      const modalContentAll = document.getElementById("modalContentAll");
      const closeModalAll = document.getElementById("closeModalAll");
      const searchInputAll = document.getElementById("searchInputAll");
      const tableBodyAll = document.querySelector("#data-table-all tbody");
      const pageNumbersContainerAll = document.getElementById("pageNumbersAll");
      const firstPageButtonAll = document.getElementById("firstPageAll");
      const prevPageButtonAll = document.getElementById("prevPageAll");
      const nextPageButtonAll = document.getElementById("nextPageAll");
      const lastPageButtonAll = document.getElementById("lastPageAll");
      const itemsPerPageSelectAll = document.getElementById("itemsPerPageAll");
      let allDataAll = [];
      let currentPageAll = 1;
      let itemsPerPageAll = parseInt(itemsPerPageSelectAll.value);
      closeModalAll.onclick = () => modalAll.style.display = "none";
      window.onclick = event => {
        if (event.target == modalAll) modalAll.style.display = "none";
      };
      itemsPerPageSelectAll.addEventListener("change", (e) => {
        itemsPerPageAll = parseInt(e.target.value);
        currentPageAll = 1;
        renderTableAll(allDataAll);
      });
     function renderTableAll(data) {
        tableBodyAll.innerHTML = '';
        const startIdx = (currentPageAll - 1) * itemsPerPageAll;
        const endIdx = startIdx + itemsPerPageAll;
        const paginatedData = data.slice(startIdx, endIdx);
        paginatedData.forEach((row, i) => {
          const tr = document.createElement("tr");
          tr.style.animationDelay = `${i * 0.05}s`; // Fade-in ทีละแถว
           const status = row["Status"] || "";
          const statusTd = document.createElement("td");
          statusTd.textContent = status;
          statusTd.className = status === "สั่งเบิกแล้ว" ? "status-green" : "status-red";
          tr.appendChild(statusTd);
          const columns = ["Timestamp", "Code", "Material Description", "จำนวน", "ชื่อช่าง", "หน่วยงาน","CallNumber","CallType", "Note"];
          columns.forEach(col => {
            const td = document.createElement("td");
            td.textContent = row[col] || "";
            tr.appendChild(td);
          });
          const detailTd = document.createElement("td");
          const btn = document.createElement("button");
          btn.textContent = "ดูรายละเอียด";
          btn.className = "detail-button";
          btn.onclick = () => {
            modalContentAll.innerHTML = columns.map(col => {
              const label = col === "Timestamp" ? "วันเวลา" : col;
              return `<div><span class='label'>${label}:</span> <span class='value'>${row[col] || ''}</span></div>`;
            }).join('');
            modalAll.style.display = "block";
          };
          detailTd.appendChild(btn);
          tr.appendChild(detailTd);
          tableBodyAll.appendChild(tr);
        });
        updatePaginationAll(data);
      }
      function updatePaginationAll(data) {
        const totalPages = Math.ceil(data.length / itemsPerPageAll);
        pageNumbersContainerAll.innerHTML = '';
        const startPage = currentPageAll; // เริ่มที่หน้าปัจจุบัน
        const endPage = Math.min(totalPages, currentPageAll + 2); // ไปอีก 2 หน้า
        for (let i = startPage; i <= endPage; i++) {
          const pageNumberButton = document.createElement("button");
          pageNumberButton.className = `all-page-number ${i === currentPageAll ? 'active' : ''}`;
          pageNumberButton.textContent = i;
          pageNumberButton.onclick = () => {
            currentPageAll = i;
            renderTableAll(data);
          };
          pageNumbersContainerAll.appendChild(pageNumberButton);
        }
      }
      // ปุ่มเลื่อนไปหน้าแรก
      firstPageButtonAll.onclick = () => {
        currentPageAll = 1;
        renderTableAll(allDataAll);
      };
      // ปุ่มย้อนกลับ
      prevPageButtonAll.onclick = () => {
        if (currentPageAll > 1) {
          currentPageAll--;
          renderTableAll(allDataAll);
        }
      };
      // ปุ่มไปหน้า next
      nextPageButtonAll.onclick = () => {
        const totalPages = Math.ceil(allDataAll.length / itemsPerPageAll);
        if (currentPageAll < totalPages) {
          currentPageAll++;
          renderTableAll(allDataAll);
        }
      };
      // ปุ่มไปหน้าสุดท้าย
      lastPageButtonAll.onclick = () => {
        currentPageAll = Math.ceil(allDataAll.length / itemsPerPageAll);
        renderTableAll(allDataAll);
      };
      searchInputAll.addEventListener("input", e => {
        const keyword = e.target.value.toLowerCase();
        const filtered = allDataAll.filter(row => {
          return (
            (row["Code"] || "").toLowerCase().includes(keyword) ||
            (row["Material Description"] || "").toLowerCase().includes(keyword) ||
            (row["ชื่อช่าง"] || "").toLowerCase().includes(keyword) ||
            (row["หน่วยงาน"] || "").toLowerCase().includes(keyword) ||
            (row["หมายเหตุ"] || "").toLowerCase().includes(keyword)
          );
        });
        renderTableAll(filtered);
      });
      function loadAllData() {
        fetch(urlAll)
          .then(response => response.json())
          .then(data => {
            allDataAll = data;
            renderTableAll(data);
          })
          .catch(error => {
            console.error("ไม่สามารถโหลดข้อมูลได้:", error);
          });
      }
      // Pending-calls tab script
      const sheetIDPending = '1dzE4Xjc7H0OtNUmne62u0jFQT-CiGsG2eBo-1v6mrZk';
      const sheetNamePending = 'Call_Report';
      const urlPending = `https://opensheet.elk.sh/${sheetIDPending}/${sheetNamePending}`;
      const modalPending = document.getElementById("detailModalPending");
      const modalContentPending = document.getElementById("modalContentPending");
      const closeModalPending = document.getElementById("closeModalPending");
      const teamFilterPending = document.getElementById("teamFilterPending");
      const searchInputPending = document.getElementById("searchInputPending");
      const searchButtonPending = document.getElementById("searchButtonPending");
      const tableBodyPending = document.querySelector("#data-table-pending tbody");
      const pageNumbersContainerPending = document.getElementById("pageNumbersPending");
      const firstPageButtonPending = document.getElementById("firstPagePending");
      const prevPageButtonPending = document.getElementById("prevPagePending");
      const nextPageButtonPending = document.getElementById("nextPagePending");
      const lastPageButtonPending = document.getElementById("lastPagePending");
      const itemsPerPageSelectPending = document.getElementById("itemsPerPagePending");
      let allDataPending = [];
      let currentPagePending = 1;
      let itemsPerPagePending = 20;
      let sortConfigPending = { column: null, direction: 'asc' };
      closeModalPending.onclick = () => modalPending.style.display = "none";
      window.onclick = event => {
        if (event.target == modalPending) modalPending.style.display = "none";
      };
      itemsPerPageSelectPending.addEventListener("change", (e) => {
        itemsPerPagePending = parseInt(e.target.value);
        currentPagePending = 1; // รีเซ็ตหน้าเมื่อเปลี่ยนจำนวนรายการต่อหน้า
        filterAndRenderTablePending();
      });
      searchInputPending.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          currentPagePending = 1; // รีเซ็ตหน้าเมื่อค้นหาใหม่
          filterAndRenderTablePending();
        }
      });
      searchButtonPending.addEventListener("click", () => {
        currentPagePending = 1; // รีเซ็ตหน้าเมื่อค้นหาใหม่
        filterAndRenderTablePending();
      });
      function populateTeamFilterPending(data) {
        const filteredData = data.filter(row => {
          const vipa = Number(row["Vipa"] || 0);
          const pendingDept = (row["ค้างหน่วยงาน"] || "").toLowerCase();
          return vipa > 0 &&
                 !pendingDept.includes("stock วิภาวดี 62") &&
                 !pendingDept.includes("nec_ยกเลิกผลิต");
        });
        const teams = [...new Set(filteredData.map(row => row["Team"]).filter(team => team && team.trim() !== ""))].sort();
        teamFilterPending.innerHTML = '<option value="">ทั้งหมด</option>';
        if (teams.length === 0) {
          const option = document.createElement("option");
          option.value = "";
          option.textContent = "ไม่มีทีมที่ตรงตามเงื่อนไข";
          option.disabled = true;
          teamFilterPending.appendChild(option);
        } else {
          teams.forEach(team => {
            const option = document.createElement("option");
            option.value = team;
            option.textContent = team;
            teamFilterPending.appendChild(option);
          });
        }
      }
      function addSortListenersPending() {
        const sortableHeaders = document.querySelectorAll("#pending-calls th.sortable");
        sortableHeaders.forEach(header => {
          header.addEventListener("click", () => {
            const column = header.getAttribute("data-column");
            if (sortConfigPending.column === column) {
              sortConfigPending.direction = sortConfigPending.direction === 'asc' ? 'desc' : 'asc';
            } else {
              sortConfigPending.column = column;
              sortConfigPending.direction = 'asc';
            }
            updateSortArrowsPending();
            filterAndRenderTablePending();
          });
        });
      }
      function updateSortArrowsPending() {
        const sortableHeaders = document.querySelectorAll("#pending-calls th.sortable");
        sortableHeaders.forEach(header => {
          const arrow = header.querySelector(".pending-arrow");
          const column = header.getAttribute("data-column");
          if (column === sortConfigPending.column) {
            arrow.textContent = sortConfigPending.direction === 'asc' ? '↑' : '↓';
          } else {
            arrow.textContent = '';
          }
        });
      }
      function filterAndRenderTablePending() {
        const selectedTeam = teamFilterPending.value;
        const keyword = searchInputPending.value.toLowerCase().trim();
        let filteredData = allDataPending.filter(row => {
          const pendingDept = (row["ค้างหน่วยงาน"] || "").toLowerCase();
          return Number(row["Vipa"] || 0) > 0 &&
                 !pendingDept.includes("stock วิภาวดี 62") &&
                 !pendingDept.includes("nec_ยกเลิกผลิต") &&
                 (!selectedTeam || row["Team"] === selectedTeam) &&
                 (!keyword ||
                   (row["DateTime"] || "").toLowerCase().includes(keyword) ||
                   (row["Ticket Number"] || "").toLowerCase().includes(keyword) ||
                   (row["Team"] || "").toLowerCase().includes(keyword) ||
                   (row["Brand"] || "").toLowerCase().includes(keyword) ||
                   (row["ค้างหน่วยงาน"] || "").toLowerCase().includes(keyword) ||
                   (row["Material"] || "").toLowerCase().includes(keyword) ||
                   (row["Description"] || "").toLowerCase().includes(keyword) ||
                   (row["Vipa"] || "").toLowerCase().includes(keyword) ||
                   (row["DayRepair"] || "").toLowerCase().includes(keyword)
                 );
        });
        if (sortConfigPending.column) {
          filteredData.sort((a, b) => {
            let valueA = a[sortConfigPending.column] || "";
            let valueB = b[sortConfigPending.column] || "";
            if (sortConfigPending.column === 'DayRepair' || sortConfigPending.column === 'Vipa') {
              valueA = Number(valueA) || 0;
              valueB = Number(valueB) || 0;
              return sortConfigPending.direction === 'asc' ? valueA - valueB : valueB - valueA;
            } else {
              valueA = valueA.toString().toLowerCase();
              valueB = valueB.toString().toLowerCase();
              return sortConfigPending.direction === 'asc' ? valueA.localeCompare(valueB) : valueB.localeCompare(valueA);
            }
          });
        }
        // ตรวจสอบว่า currentPage อยู่ในช่วงที่ถูกต้อง
        const totalPages = Math.ceil(filteredData.length / itemsPerPagePending);
        if (currentPagePending > totalPages) {
          currentPagePending = totalPages || 1;
        }
        renderTablePending(filteredData);
        updateCallCountPending(filteredData);
      }
      teamFilterPending.addEventListener("change", () => {
        currentPagePending = 1; // รีเซ็ตหน้าเมื่อเปลี่ยนทีม
        filterAndRenderTablePending();
      });
      function updateCallCountPending(data) {
        const uniqueTickets = [...new Set(data.map(row => row["Ticket Number"]))];
        const count = uniqueTickets.length;
        const callCountValue = document.getElementById("callCountValuePending");
        callCountValue.textContent = count;
      }
      function formatDateTimePending(dateTime) {
        if (!dateTime) return "";
        const datePart = dateTime.split(" ")[0];
        return datePart;
      }
      function renderTablePending(data) {
        tableBodyPending.innerHTML = '';
        const startIdx = (currentPagePending - 1) * itemsPerPagePending;
        const endIdx = startIdx + itemsPerPagePending;
        const paginatedData = data.slice(startIdx, endIdx);
        if (paginatedData.length === 0) {
          tableBodyPending.innerHTML = '<tr><td colspan="10" class="pending-text-center">ไม่พบข้อมูลที่ตรงกับเงื่อนไข</td></tr>';
          updatePaginationPending(data);
          return;
        }
        const ticketGroups = {};
        data.forEach(row => {
          const ticket = row["Ticket Number"];
          if (!ticketGroups[ticket]) {
            ticketGroups[ticket] = [];
          }
          ticketGroups[ticket].push(row);
        });
        const uniqueTickets = Object.keys(ticketGroups).sort();
        const colorMap = {};
        uniqueTickets.forEach((ticket, index) => {
          if (ticket === "24103102058") {
            colorMap[ticket] = "pending-yellow-light";
          } else if (ticket === "25011101274") {
            colorMap[ticket] = "pending-pink-pastel";
          } else {
            colorMap[ticket] = index % 2 === 0 ? "pending-yellow-light" : "pending-pink-pastel";
          }
        });
        paginatedData.forEach((row, i) => {
          const tr = document.createElement("tr");
          tr.style.animationDelay = `${i * 0.05}s`;
          const ticket = row["Ticket Number"];
          tr.className = colorMap[ticket];
          const columns = ["DateTime", "Ticket Number", "Team", "Brand", "ค้างหน่วยงาน", "Material", "Description", "Vipa", "DayRepair"];
          columns.forEach(col => {
            const td = document.createElement("td");
            let cellValue = row[col] || "";
            if (col === "DateTime") {
              cellValue = formatDateTimePending(cellValue);
            } else if (col === "DayRepair" || col === "Vipa") {
              const numValue = Number(cellValue);
              cellValue = isNaN(numValue) ? "" : numValue.toString();
            }
            td.textContent = cellValue;
            if (col === "Description") {
              td.classList.add("pending-text-left");
            } else if (col === "Vipa" || col === "DayRepair") {
              td.classList.add("pending-text-center");
            }
            if ((col === "Material" || col === "Description") && row["Description"] === "Code ผิด") {
              td.className = "pending-highlight-red";
            }
            tr.appendChild(td);
          });
          const detailTd = document.createElement("td");
          const btn = document.createElement("button");
          btn.textContent = "ดูรายละเอียด";
          btn.className = "pending-detail-button";
          btn.onclick = () => {
            modalContentPending.innerHTML = columns.map(col => {
              let value = row[col] || "";
              if (col === "DateTime") {
                value = formatDateTimePending(value);
              } else if (col === "DayRepair" || col === "Vipa") {
                const numValue = Number(value);
                value = isNaN(numValue) ? "" : numValue.toString();
              }
              let valueClass = (col === "Material" || col === "Description") && row["Description"] === "Code ผิด" ? "pending-highlight-red" : "value";
              return `<div><span class='label'>${col}:</span> <span class='${valueClass}'>${value}</span></div>`;
            }).join('');
            modalPending.style.display = "block";
          };
          detailTd.appendChild(btn);
          tr.appendChild(detailTd);
          tableBodyPending.appendChild(tr);
        });
        updatePaginationPending(data);
      }
      function updatePaginationPending(data) {
        const totalPages = Math.ceil(data.length / itemsPerPagePending);
        pageNumbersContainerPending.innerHTML = '';
        if (totalPages === 0) {
          firstPageButtonPending.disabled = true;
          prevPageButtonPending.disabled = true;
          nextPageButtonPending.disabled = true;
          lastPageButtonPending.disabled = true;
          return;
        }
        const startPage = Math.max(1, currentPagePending - 1);
        const endPage = Math.min(totalPages, currentPagePending + 2);
        for (let i = startPage; i <= endPage; i++) {
          const pageNumberButton = document.createElement("button");
          pageNumberButton.className = `pending-page-number ${i === currentPagePending ? 'active' : ''}`;
          pageNumberButton.textContent = i;
          pageNumberButton.onclick = () => {
            currentPagePending = i;
            filterAndRenderTablePending();
          };
          pageNumbersContainerPending.appendChild(pageNumberButton);
        }
        firstPageButtonPending.disabled = currentPagePending === 1;
        prevPageButtonPending.disabled = currentPagePending === 1;
        nextPageButtonPending.disabled = currentPagePending === totalPages;
        lastPageButtonPending.disabled = currentPagePending === totalPages;
      }
      firstPageButtonPending.onclick = () => {
        currentPagePending = 1;
        filterAndRenderTablePending();
      };
      prevPageButtonPending.onclick = () => {
        if (currentPagePending > 1) {
          currentPagePending--;
          filterAndRenderTablePending();
        }
      };
      nextPageButtonPending.onclick = () => {
        const totalPages = Math.ceil(allDataPending.filter(row => {
          const pendingDept = (row["ค้างหน่วยงาน"] || "").toLowerCase();
          return Number(row["Vipa"] || 0) > 0 &&
                 !pendingDept.includes("stock วิภาวดี 62") &&
                 !pendingDept.includes("nec_ยกเลิกผลิต");
        }).length / itemsPerPagePending);
        if (currentPagePending < totalPages) {
          currentPagePending++;
          filterAndRenderTablePending();
        }
      };
      lastPageButtonPending.onclick = () => {
        currentPagePending = Math.ceil(allDataPending.filter(row => {
          const pendingDept = (row["ค้างหน่วยงาน"] || "").toLowerCase();
          return Number(row["Vipa"] || 0) > 0 &&
                 !pendingDept.includes("stock วิภาวดี 62") &&
                 !pendingDept.includes("nec_ยกเลิกผลิต");
        }).length / itemsPerPagePending);
        filterAndRenderTablePending();
      };
      function loadPendingCallsData() {
        fetch(urlPending)
          .then(response => response.json())
          .then(data => {
            allDataPending = data;
            populateTeamFilterPending(allDataPending);
            addSortListenersPending();
            filterAndRenderTablePending();
          })
          .catch(error => {
            console.error("ไม่สามารถโหลดข้อมูลได้:", error);
            tableBodyPending.innerHTML = '<tr><td colspan="10" class="pending-text-center">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>';
          });
      }
      // Auto-load default data if logged in
      if (appContent.classList.contains('logged-in')) {
        loadData();
      }
    </script>
  </body>
</html>
